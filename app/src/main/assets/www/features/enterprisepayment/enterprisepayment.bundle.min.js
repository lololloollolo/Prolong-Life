angular.module("starter").controller('EnterprisepaymentController',function($translate,$rootScope,$ionicPopup,$scope,$stateParams,Customer,SB,Dialog,SocialSharing,Modal,$timeout,$ionicLoading,Enterprisepaymentpro,$state,Application,$location,$window){$scope.is_loading=!0;$scope.homeView=!1;$scope.value_id=Enterprisepaymentpro.value_id=$stateParams.value_id;if(Application.is_webview){var url=$location.absUrl();if(url.indexOf("?")>-1){$ionicLoading.show({template:'Inprocess...',})
var first_split=url.split('?');var second_split=first_split[1].split('&');if(second_split.length>1){var token_split=second_split[0].split('=');var tokenId=token_split[1];var payer_split=second_split[1].split('=');var payerId=payer_split[1];var amount=Enterprisepaymentpro.get_data('amount');var gid=Enterprisepaymentpro.get_data('paypalDetail_gid');var customer_id=Enterprisepaymentpro.get_data('customer_id');$scope.tokenId=Enterprisepaymentpro.token=tokenId;$scope.payerId=Enterprisepaymentpro.payerId=payerId;$scope.meta_data=Enterprisepaymentpro.metaData=Enterprisepaymentpro.get_local('metaData');$scope.paymentCode=Enterprisepaymentpro.paymentCode=Enterprisepaymentpro.get_local('method_code');$scope.return_value_id=Enterprisepaymentpro.return_value_id=Enterprisepaymentpro.get_local('return_value_id');Enterprisepaymentpro.transaction($scope.value_id,amount,customer_id,1,gid,1,$scope.return_value_id).success(function(data){if(data.success==1){Enterprisepaymentpro.unset_data('amount');Enterprisepaymentpro.unset_data('paypalDetail_gid');Enterprisepaymentpro.unset_data('customer_id');Enterprisepaymentpro.unset_data('metaData');Enterprisepaymentpro.unset_data('method_code');Enterprisepaymentpro.unset_data('return_value_id');$ionicLoading.hide();if(data.return_state.length>0){$state.go(data.return_state,{value_id:data.return_value_id},{reload:!0})}else{$location.path(BASE_PATH+'/'+data.return_url).search({transaction_id:Enterprisepaymentpro.payerId,customer_id:customer_id})}}})}else{$ionicLoading.hide();$state.go('enterprisepayment_process',{value_id:$scope.value_id,amount:Enterprisepaymentpro.get_data('amount'),return_value_id:$stateParams.value_id,order_id:456},{reload:!0})}}}
$scope.openpayment=function(isValid,amount){if(isValid){$state.go('enterprisepayment_process',{value_id:$scope.value_id,amount:amount,return_value_id:$scope.value_id,order_id:456},{reload:!0})}}}).controller('EnterprisepaymentProcessController',function($translate,$location,$ionicLoading,$state,$ocLazyLoad,$ionicLoading,$ionicModal,$rootScope,$scope,$stateParams,Customer,SB,Dialog,SocialSharing,Modal,Enterprisepaymentpro,$ionicPopup,$rootScope){$scope.is_loading=!0;$scope.value_id=Enterprisepaymentpro.value_id=$stateParams.value_id;$scope.meta_data=Enterprisepaymentpro.metaData=$stateParams.meta_data;$scope.return_value_id=Enterprisepaymentpro.return_value_id=$stateParams.return_value_id;Enterprisepaymentpro.set_local('return_value_id',$stateParams.return_value_id);Enterprisepaymentpro.set_local('metaData',$stateParams.meta_data);$scope.amount=$stateParams.amount;$scope.order_id=$stateParams.order_id;$scope.is_logged_in=Customer.isLoggedIn();$scope.$on(SB.EVENTS.AUTH.loginSuccess,function(){$scope.is_logged_in=!0;$scope.getmethodid=Enterprisepaymentpro.get_local('method_gid');$scope.methodcode=Enterprisepaymentpro.get_local('method_code');if($scope.getmethodid){$scope.gotoTransaction($scope.getmethodid,$scope.methodcode)}});$scope.loadContent=function(){Enterprisepaymentpro.getMethods($scope.value_id).success(function(data){if(data.success==1){$scope.methods=data.methods;$scope.base_url=data.basepath;$scope.currency=data.currency;$ocLazyLoad.load($scope.base_url+'/app/local/modules/Enterprisepayment/features/enterprisepayment/js/stripe.js').then(function(){})}}).finally(function(){$scope.is_loading=!1});if($stateParams.amount<=0){var alertPopup=$ionicPopup.alert({title:$translate.instant("Error"),template:$translate.instant("Please enter correct amount")});return}}
Enterprisepaymentpro.unset_local('method_gid');$scope.gotoTransaction=function(method_gid,method_code){Enterprisepaymentpro.set_local('method_gid',method_gid);Enterprisepaymentpro.set_local('method_code',method_code);Enterprisepaymentpro.paymentCode=method_code;console.log(Enterprisepaymentpro.paymentCode);if(!Customer.isLoggedIn()){$scope.login();return}
if(method_code=='stripe'){$ionicLoading.show();$ionicModal.fromTemplateUrl('features/enterprisepayment/assets/templates/l1/stripe-form.html',{scope:$scope,animation:'slide-in-up'}).then(function(modal){$scope.stripeModel=modal;$scope.stripeModel.show();$ionicLoading.hide()});$scope.formstripe=function(isValid,formdata){if(isValid){$ionicLoading.show();Enterprisepaymentpro.getpublishkey(method_gid).success(function(data){if(data.success==1){$scope.publishablekey=data.publishkey;$scope.secretekey=data.secretekey;var PublishableKey=$scope.publishablekey;Stripe.setPublishableKey(PublishableKey);Stripe.card.createToken(formdata,function stripeResponseHandler(status,response){var token=response.id;$scope.amount=$stateParams.amount;Enterprisepaymentpro.getstripe(token,$scope.amount,$scope.secretekey,method_gid,$scope.order_id,$scope.return_value_id).success(function(data){if(data.success==1){$scope.return_url=data.return_url;$scope.transaction_id=data.transaction_id;Enterprisepaymentpro.token=$scope.transaction_id;Enterprisepaymentpro.payerId=$scope.transaction_id;$scope.stripeModel.hide();$stateParams.order_id=$scope.order_id;if(data.return_state.length>0){$state.go(data.return_state,{value_id:data.return_value_id},{reload:!0})}else{$location.path(BASE_PATH+'/'+$scope.return_url).search({transaction_id:$scope.transaction_id,order_id:$scope.order_id,customer_id:Customer.id})}}else{$ionicPopup.alert({title:$translate.instant('Error!'),template:$translate.instant('Please enter correct credentials')})}}).finally(function(){$ionicLoading.hide()})})}})}}}
if(method_code=='paypal'){Enterprisepaymentpro.paypalPayment($scope.amount,method_gid,$scope.order_id,$scope.return_value_id)}
if(method_code=='cash'){Enterprisepaymentpro.postcashresponse($scope.amount,method_gid,$scope.return_value_id).success(function(data){if(data.success==1){console.log(data);console.log('ooooooooooooooooooooooooooooooooooooooooooooo');console.log(data.return_state.length);$scope.return_url=data.return_url;Enterprisepaymentpro.token=data.token;Enterprisepaymentpro.payerId=data.token;if(data.return_state.length>0){$state.go(data.return_state,{value_id:data.return_value_id},{reload:!0})}else{$location.path(BASE_PATH+'/'+$scope.return_url).search({transaction_id:data.token,order_id:$scope.order_id,customer_id:Customer.id})}}})}
if(method_code=='bank_transfer'){$ionicLoading.show();$ionicModal.fromTemplateUrl('features/enterprisepayment/assets/templates/l1/bank-transfer.html',{scope:$scope,animation:'slide-in-up'}).then(function(modal){$scope.bankTransferModel=modal;$scope.bankTransferModel.show();$ionicLoading.hide()});Enterprisepaymentpro.getbanktransferform(method_gid).success(function(data){if(data.success==1){$scope.bank_data=data.bank_data}})}
if(method_code=='payu_latam'){$ionicLoading.show();$ionicModal.fromTemplateUrl('features/enterprisepayment/assets/templates/l1/payu_latam.html',{scope:$scope,animation:'slide-in-up'}).then(function(modal){$scope.stripeModel=modal;$scope.stripeModel.show();$ionicLoading.hide()});$scope.payulatamformsubmit=function(isValid,formdata){if(isValid){$ionicLoading.show();Enterprisepaymentpro.getpayulatamtoken(method_gid,formdata).success(function(data){if(data.success==1){$scope.payu_token=data.payu_latam_token;Enterprisepaymentpro.createpayulatampaymentid(method_gid,data.payu_latam_token,$scope.amount).success(function(data){if(data.success==1){$scope.payu_latam_payment_id=data.payu_latam_payment_id;$scope.reconciliation_id=data.reconciliation_id;Enterprisepaymentpro.createpayulatamchanrge(method_gid,$scope.payu_latam_payment_id,$scope.payu_token,$scope.reconciliation_id).success(function(data){if(data.success==1){}else{$ionicPopup.alert({title:$translate.instant('Error!'),template:$translate.instant('Working .....')})}})}else{$ionicPopup.alert({title:$translate.instant('Error!'),template:$translate.instant('Working....')})}})}else{$ionicPopup.alert({title:$translate.instant('Error!'),template:$translate.instant('Unable to take payment')})}})}else{$ionicPopup.alert({title:$translate.instant('Error!'),template:$translate.instant('Please enter correct credentials')})}}}}
$scope.login=function(){Customer.loginModal($scope)};$scope.month=[1,2,3,4,5,6,7,8,9,10,11,12];var year=new Date().getFullYear();var range=[];range.push(year);for(var i=1;i<=19;i++){range.push(year+i)}
$scope.year=range;$scope.loadContent();$scope.bank_transfer_proceed=function(){$scope.getmethodid=Enterprisepaymentpro.get_local('method_gid');Enterprisepaymentpro.postbankresponse($scope.amount,$scope.getmethodid,$scope.return_value_id).success(function(data){console.log(data);if(data.success==1){$scope.return_url=data.return_url;Enterprisepaymentpro.token=data.token;Enterprisepaymentpro.payerId=data.token;$ionicPopup.alert({title:$translate.instant('Success'),template:$translate.instant('Your payment have been done successfully')}).then(function(){$scope.bankTransferModel.hide();if(data.return_state.length>0){$state.go(data.return_state,{value_id:data.return_value_id},{reload:!0})}else{$location.path(BASE_PATH+'/'+$scope.return_url).search({transaction_id:data.token,order_id:$scope.order_id,customer_id:Customer.id})}})}})}});angular.module('starter').factory('Enterprisepaymentpro',function($sbhttp,$pwaRequest,Application,$rootScope,$http,$ionicPopup,$translate,Loader,Dialog,Url,SB,$location,$ionicLoading,$window,$state,Customer,$ocLazyLoad,$ionicModal){var factory={};factory.value_id=null;factory.token=null;factory.payerId=null;factory.metaData=null;factory.get_local=function(key){return $window.localStorage.getItem(key)||null}
factory.set_local=function(key,id){$window.localStorage.setItem(key,id)}
factory.unset_local=function(key){$window.localStorage.removeItem(key)}
factory.getMethods=function(value_id){var data={};data.value=this.value_id;var url=Url.get("enterprisepayment/mobile_view/getmethods");return $http.post(url,data)}
factory.paypalPayment=function(amount,gid,order_id,return_value_id){var data={};data.gid=gid;data.amount=amount;data.return_value_id=return_value_id;data.current_url=$location.url();data.value_id=factory.value_id;data.order_id=order_id;data.BASE_PATH=BASE_PATH;data.is_webview=Application.is_webview;Loader.show();var promise=$pwaRequest.post('enterprisepayment/mobile_view/paypalpayment',{data:data,cache:!1});promise.then(function(result){if(result.token_url=='&webview=1'){Dialog.alert('Error','Unable to process payment through paypal','OK',-1)}else{factory.populate(result,amount,order_id,return_value_id)}
return result},function(error){Dialog.alert('Error',error.message,'OK',-1)}).then(function(result){Loader.hide();return result});return promise}
factory.populate=function(paypalDetail,amount,order_id,return_value_id){if(paypalDetail.success==1){if(!Application.is_webview){$ionicLoading.show({content:'Loading',animation:'fade-in',showBackdrop:!0,maxWidth:200,showDelay:0});var browser=$window.open(paypalDetail.token_url,$rootScope.getTargetForLink(),'location=yes');browser.addEventListener('loadstart',function(event){var newurl=event.url.split('/?__goto__=');var res=newurl[0].concat(newurl[1]);if(/(confirm)/.test(event.url)){var url=event.url;var first_split=url.split('?');var second_split=first_split[1].split('&');var token_split=second_split[0].split('=');var tokenId=token_split[1];var payer_split=second_split[1].split('=');var payerId=payer_split[1];if(tokenId!=''&&payerId!=''){factory.token=tokenId;factory.payerId=payerId;factory.transaction(this.value_id,amount,Customer.id,1,paypalDetail.gid,order_id,return_value_id);browser.close();$ionicLoading.hide();if(paypalDetail.return_state.length>0){$state.go(paypalDetail.return_state,{value_id:paypalDetail.return_value_id},{reload:!0})}else{$location.path(BASE_PATH+'/'+paypalDetail.return_url).search({transaction_id:this.payerId,order_id:order_id,customer_id:Customer.id})}}else{var responseArray={token:'',payer:''};factory.transaction(this.value_id,amount,Customer.id,0,paypalDetail.gid,order_id,return_value_id)}}else if(/(cancel)/.test(event.url)){browser.close();$ionicLoading.hide()}})}else{factory.set_data('amount',amount);factory.set_data('customer_id',Customer.id);factory.set_data('paypalDetail_gid',paypalDetail.gid);$window.location=paypalDetail.token_url}}}
factory.transaction=function(value_id,amount,customer_id,status,gid,order_id,return_value_id){var data={};data.token=this.token;data.payer=this.payerId;data.customer_id=customer_id;data.amount=amount;data.return_value_id=return_value_id;data.value=this.value_id;data.status=status;data.gid=gid;data.order_id=order_id;var url=Url.get("enterprisepayment/mobile_view/transaction");return $http.post(url,data)}
factory.getpublishkey=function(id){var data={};data.id=id;data.value=this.value_id;var url=Url.get("enterprisepayment/mobile_view/getpublishkey");return $http.post(url,data)}
factory.getstripe=function(token,amount,secretkey,gid,order_id,return_value_id){var data={};data.token=token;data.value=this.value_id;data.amount=amount;data.return_value_id=return_value_id;data.secretkey=secretkey;data.gid=gid;data.customer_id=Customer.id;data.order_id=order_id;var url=Url.get("enterprisepayment/mobile_view/stripepayment");return $http.post(url,data)}
factory.getbanktransferform=function(gid){var data={};data.gid=gid;data.value_id=this.value_id;var url=Url.get("enterprisepayment/mobile_view/getbanktransferform");return $http.post(url,data)}
factory.postbankresponse=function(amount,gid,return_value_id){var data={};data.return_value_id=return_value_id;data.amount=amount;data.gid=gid;data.customer_id=Customer.id;data.value_id=this.value_id;var url=Url.get("enterprisepayment/mobile_view/postbankresponse");return $http.post(url,data)}
factory.postcashresponse=function(amount,gid,return_value_id){var data={};data.return_value_id=return_value_id;data.amount=amount;data.gid=gid;data.customer_id=Customer.id;data.value_id=this.value_id;var url=Url.get("enterprisepayment/mobile_view/postcashresponse");return $http.post(url,data)}
factory.getPaymentValueId=function(){var data={};var url=Url.get("enterprisepayment/mobile_view/getpaymentvalueid");$http.post(url,data).then(function successCallback(response){factory.enterprisepaymentValueId=response.data},function errorCallback(response){console.log(response)})}
factory.get_data=function(key){return $window.localStorage.getItem(key)||null};factory.set_data=function(key,id){$window.localStorage.setItem(key,id)};factory.unset_data=function(key){$window.localStorage.removeItem(key)};factory.getpayulatamtoken=function(id,form_data){var data={};data.id=id;data.form_data=form_data;data.value=this.value_id;var url=Url.get("enterprisepayment/mobile_view/getpayulatamtoken");return $http.post(url,data)}
factory.createpayulatampaymentid=function(method_gid,create_payament,amount){var data={};data.id=method_gid;data.amount=amount;data.token=create_payament;data.value=this.value_id;var url=Url.get("enterprisepayment/mobile_view/createpayulatampaymentid");return $http.post(url,data)}
factory.createpayulatamchanrge=function(method_gid,payu_latam_payment_id,token,reconciliation_id){var data={};data.id=method_gid;data.payu_latam_payment_id=payu_latam_payment_id;data.token=token;data.reconciliation_id=reconciliation_id;data.value=this.value_id;var url=Url.get("enterprisepayment/mobile_view/createpayulatamchanrge");return $http.post(url,data)}
return factory});Features.insertCSS("","enterprisepayment")