angular.module('starter').controller('ChatroomBaseController',function($q,$rootScope,$scope,$stateParams,$timeout,$ionicActionSheet,$translate,AUTH_EVENTS,Chatrooms,Customer,Dialog,Modal,Url,Loader){$scope.$on('connectionStateChange',function(event,args){if(args.isOnline){Chatrooms.goOnline();$scope.loadContent()}});function setIsConnected(){$timeout(function(){$scope.isConnectedToChat=Chatrooms.connected})}
$scope.$on(Chatrooms.CONNECT_EVENT,setIsConnected);$scope.$on(Chatrooms.DISCONNECT_EVENT,setIsConnected);setIsConnected();$scope.$on(AUTH_EVENTS.loginSuccess,function(){$scope.is_logged_in=!0;$scope._updateUserStatus();$scope.loadContent()});$scope.$on(AUTH_EVENTS.logoutSuccess,function(){$scope.is_logged_in=!1;$scope._updateUserStatus();$scope.loadContent()});$scope.is_logged_in=Customer.isLoggedIn();$scope.closePopover=function(){};$scope.is_loading=!0;$scope.value_id=Chatrooms.value_id=$stateParams.value_id;Chatrooms.init();$scope.nickname=Chatrooms.nickname;$scope.no_nickname=function(){return!Customer.isLoggedIn()||(!angular.isString(Chatrooms.nickname)||Chatrooms.nickname.trim()==='')};$scope._focus_input=function(input_id){var input=document.getElementById(input_id);if(input){$timeout(function(){input.focus()},100)}};$scope._focus_chat_input=function(){$scope._focus_input('chat_message_input')};$scope._blur_chat_input=function(){var input=document.getElementById('chat_message_input');if(input){$timeout(function(){input.blur()},100)}};$scope._updateUserStatus=function(){$scope.nickname=Chatrooms.nickname;$scope.is_logged_in=Customer.isLoggedIn();return!0};$scope.saveAndClose=function(){var promises=[];Loader.show('Saving ...');if($scope.chatroom){var notifData={all:$scope.modalForm.notifications.choice==='all',mentions:$scope.modalForm.notifications.choice==='mentions',none:$scope.modalForm.notifications.choice==='none'};var notifs=Chatrooms.updateNotificationsSettings(notifData,$scope.receiver_id,$scope.private_chat);notifs.then(function(){$scope.notifications=notifData});promises.push(notifs)}
var nickname=Chatrooms.setNickname($scope.modalForm.nickname);nickname.then(function(payload){$scope.nickname=Chatrooms.nickname},function(error){Loader.hide();Dialog.alert('Error',error.message,'OK',3750,'chatrooms')});promises.push(nickname);$q.all(promises).then(function(){Loader.hide();Dialog.alert('Success','New settings are saved!','OK',2350,'chatrooms').then(function(){$scope.closeModal()})})};$scope.closeModal=function(){$scope.infosModal.hide();$scope._focus_chat_input()};$scope.showInfos=function(focus_nickname_input){$scope.closePopover();(focus_nickname_input?$scope.loginIfNeeded():$q.resolve()).then(function(){var notifications=null;if($scope.chatroom){notifications=_.merge({choice:$scope.notifications.all?'all':$scope.notifications.mentions?'mentions':'none'},$scope.notifications)}
$scope.modalForm={nickname:$scope.nickname,notifications:notifications};$scope._updateUserStatus();var __showModal=function(){$scope.closePopover();var showed=$scope.infosModal.show();if(focus_nickname_input){showed.then($scope._focus_input.bind(this,'nickname_input'))}};if(!$scope.infosModal){Modal.fromTemplateUrl('features/chatrooms/assets/templates/l1/modal.html',{scope:$scope,animation:'slide-in-right-left'}).then(function(modal){$scope.infosModal=modal;__showModal()})}else{__showModal()}})};$scope.chooseNicknameIfNeeded=function(){$scope.closePopover();$scope._updateUserStatus();if(!Customer.isLoggedIn()||!angular.isString(Chatrooms.nickname)||Chatrooms.nickname.trim().length<1){if(!Customer.isLoggedIn()){$scope.login()}else{$scope.showInfos(!0)}
return $q.reject()}
return $q.resolve()};$scope.loginIfNeeded=function(){$scope.closePopover();$scope._updateUserStatus();if(!$scope.is_logged_in){$scope.login();return $q.reject()}
return $q.resolve()};$scope.login=function(){Customer.loginModal($scope)};var _managing_friends=!1;$scope.closeFriendsModal=function(){$scope.closePopover();if(angular.isObject($scope.friendsModal)&&angular.isFunction($scope.friendsModal.hide)){$scope.friendsModal.hide()}};$scope.manageFriends=function(){$scope.closePopover();$scope.chooseNicknameIfNeeded().then(function(){if(_managing_friends){return}
_managing_friends=!0;Modal.fromTemplateUrl('features/chatrooms/assets/templates/l1/friendships.html',{scope:$scope,animation:'slide-in-right-left'}).then(function(modal){$scope.friendsModal=modal;$scope.friendsModal.show().finally(function(){_managing_friends=!1})})})};var _showingCustomer=!1;$scope.actionModalResolver=null;$scope.actionModalIsOpen=!1;$scope.actionModal=function(message){if($scope.actionModalIsOpen){return}
var _buttons=[{text:$translate.instant('View user profile','chatrooms')},{text:$translate.instant('Report this message','chatrooms')}];$scope.actionModalResolver=$ionicActionSheet.show({buttons:_buttons,cancelText:$translate.instant('Cancel','chatrooms'),cancel:function(){$scope.actionModalResolver();$scope.actionModalIsOpen=!1},buttonClicked:function(index){if(index===0){$scope.showCustomer(message.senderID)}
if(index===1){Dialog.prompt('Report this message','Please tell us why you want to report this message?','text','-',undefined,undefined,'chatrooms').then(function(reportMessage){if(angular.isString(reportMessage)&&reportMessage.trim().length>0){$scope.reportMessage(message.id,reportMessage)}})}
$scope.actionModalIsOpen=!1;return!0}})};$scope.reportMessage=function(messageId,reportMessage){Chatrooms.reportMessage(messageId,reportMessage).then(function(result){Dialog.alert('',result.message,'OK',2350,'chatrooms')},function(result){Dialog.alert('Error',result.message,'OK',2350,'chatrooms')})};$scope.showCustomer=function(query){if(_showingCustomer){return}
_showingCustomer=!0;var CUSTOMER_FRIEND='friend';var CUSTOMER_UNFRIEND='unfriend';var CUSTOMER_BLOCK='block';var CUSTOMER_UNBLOCK='unblock';$scope.chooseNicknameIfNeeded().then(function(){$scope.profile_loading=!0;Chatrooms.getCustomerInfos(query).success(function(data){if(angular.isObject(data)){if(data.is_you){Dialog.alert("Hey","It's you!",'OK',-1,'chatrooms')}else if(angular.isObject(data.customer)){$scope.profile_loading=!1;$scope.profile_avatar=$scope.getDefaultAvatar(data.customer.id);$scope.profile_customer=data.customer;$scope.profile_data=data;$scope.actionProfile=function(action){var verb=null,method=null;switch(action){case CUSTOMER_FRIEND:verb='adding';method='addBuddy';break;case CUSTOMER_UNFRIEND:verb='removing';method='removeBuddy';break;case CUSTOMER_BLOCK:verb='blocking';method='blockBuddy';break;case CUSTOMER_UNBLOCK:verb='unblocking';method='unblockBuddy';break}
var updateProfileData=function(){$scope.profile_loading=!0;Chatrooms.getCustomerInfos(query).success(function(data){$timeout(function(){$scope.profile_loading=!1;$scope.profile_data=data})})};$scope.delProfileDataListener=$scope.$on(Chatrooms.UPDATED_FRIENDLIST_EVENT,updateProfileData);if(verb!==null&&method!==null){Chatrooms[method](data.customer.id).success(function(data){updateProfileData();if(angular.isObject(data)&&data.ok===!0){$scope.loadContent()}else{console.error('Error '+verb+' buddy : ',arguments)}}).error(function(){console.error('Error '+verb+' buddy : ',arguments)})}};var __showProfile=function(){var showed=$scope.profileModal.show()};if(!$scope.profileModal){Modal.fromTemplateUrl('features/chatrooms/assets/templates/l1/profile.html',{scope:$scope,animation:'slide-in-right-left'}).then(function(modal){$scope.profileModal=modal;__showProfile()})}else{__showProfile()}}else if(data.customer===null){Dialog.alert('Sorry',"We haven't found this person!",'OK',-1,'chatrooms')}else{console.error('Unknown error : ',data)}}else{console.error('Expected object, got this instead:',data)}}).error(function(){}).finally(function(){_showingCustomer=!1})}).catch(function(){_showingCustomer=!1})};$scope.closeProfileModal=function(){$scope.closePopover();if(angular.isObject($scope.profileModal)&&angular.isFunction($scope.profileModal.hide)){$scope.profileModal.hide()}};$scope.defaultAvatar='data:image/jpeg;base64,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';$scope.getDefaultAvatar=function(customerId){return Url.get('/customer/mobile_account/avatar',{customer:customerId})}});angular.module('starter').controller('ChatroomsListViewController',function($controller,Modal,$ionicPopover,$q,$rootScope,$scope,$state,$stateParams,$timeout,$translate,Chatrooms,Customer,Dialog,SB){$scope.$on('$ionicView.beforeEnter',function(){$scope.loadContent()});angular.extend(this,$controller('ChatroomBaseController',{Modal:Modal,Dialog:Dialog,$q:$q,$rootScope:$rootScope,$scope:$scope,$stateParams:$stateParams,$timeout:$timeout,$translate:$translate,Chatrooms:Chatrooms,Customer:Customer,SB:SB}));var mapWithIds=function(destination,item){if(angular.isObject(item)&&angular.isNumber(+item.id)){destination[item.id]=item}};$scope.loadContent=function(){$scope.is_loading=!0;Chatrooms.goOnline();var roomsPromise=Chatrooms.getChatrooms();roomsPromise.then(function(payload){$scope.publicRooms=payload.public;$scope.privateRooms=payload.private});var friendsPromise=Chatrooms.getFriends();friendsPromise.then(function(payload){if($scope._updateUserStatus()&&$scope.is_logged_in){$scope.friends={};angular.forEach(payload.friends,mapWithIds.bind(this,$scope.friends));$scope.has_friends=payload.friends.length>0;Chatrooms.setBuddiesToWatchList(payload.friends);Chatrooms.handleAwayForRooms(_.map(payload.friends,'room'))}});var infosPromise=Chatrooms.getInfos();infosPromise.then(function(payload){Chatrooms.SocketIO_Port=payload.socket_io_port;$scope.nickname=Chatrooms.nickname=payload.nickname;$scope._updateUserStatus();$scope.page_title=payload.page_title});$ionicPopover.fromTemplateUrl('chatrooms_popover_menu.html',{scope:$scope}).then(function(popover){$scope.menu_popover=popover});$q.all([roomsPromise,friendsPromise,infosPromise]).catch(function(){console.error('Unexpected error :',arguments)}).finally(function(){$scope.is_loading=!1})};$scope.loadContent();$scope.$on(Chatrooms.UPDATED_FRIENDLIST_EVENT,$scope.loadContent);Chatrooms.onBuddiesStatusChange(function(customer_status){$scope.friends[customer_status.id]=customer_status});$scope.unreadCount=function(chatroom){return Chatrooms.unreadCountForRoom(chatroom.room)};$scope.openPopover=function($event){if(angular.isObject($scope.menu_popover)&&angular.isFunction($scope.menu_popover.show)){$scope.menu_popover.show($event)}};$scope.closePopover=function(){if(angular.isObject($scope.menu_popover)&&angular.isFunction($scope.menu_popover.hide)){$scope.menu_popover.hide()}};$scope.rsSubscriber=$rootScope.$on('modal.shown',function(){$scope._blur_chat_input();$scope.closePopover();var o=angular.isObject,f=angular.isFunction;if(o(cordova)&&o(cordova.plugins)&&o(cordova.plugins.Keyboard)&&f(cordova.plugins.Keyboard.close)){cordova.plugins.Keyboard.close()}});$scope.joinPrivateRoom=function(){$scope.closePopover();$scope.loginIfNeeded().then(function(){Dialog.prompt('Join private chatroom','Enter the exact name of the private chatroom:','text','',undefined,undefined,'chatrooms').then(function(res){if(angular.isString(res)&&res.trim().length>0){$state.go('chatrooms-room',{value_id:$scope.value_id,type:'chatroom',receiver_id:btoa(encodeURIComponent(res))})}})})};$scope.goToRoom=function(params){if(angular.isObject(params)){$state.go('chatrooms-room',angular.extend({},params,{receiver_id:btoa(encodeURIComponent(params.receiver_id))}))}};$scope.$on('$destroy',function(){$scope.rsSubscriber();if(angular.isObject($scope.menu_popover)&&angular.isFunction($scope.menu_popover.remove)){$scope.menu_popover.remove()}})});angular.module('starter').controller('ChatroomsManageFriendsViewController',function($controller,Modal,$q,$rootScope,$scope,$stateParams,$timeout,$translate,Chatrooms,Customer,Dialog,SB){$scope.$on('$ionicView.beforeEnter',function(){$scope.loadContent()});angular.extend(this,$controller('ChatroomBaseController',{Modal:Modal,Dialog:Dialog,$q:$q,$rootScope:$rootScope,$scope:$scope,$stateParams:$stateParams,$timeout:$timeout,$translate:$translate,Chatrooms:Chatrooms,Customer:Customer,SB:SB}));var mapWithIds=function(destination,item){if(angular.isObject(item)&&angular.isNumber(+item.id)){destination[item.id]=item}};$scope.loadContent=function(){$scope.is_loading=!0;Chatrooms.goOnline();$scope._updateUserStatus();if(!$scope.is_logged_in){$scope.closeFriendsModal();return $scope.chooseNicknameIfNeeded()}
Chatrooms.getFriends().success(function(data){if(angular.isObject(data)){$scope.friends={};angular.forEach(data.friends,mapWithIds.bind(this,$scope.friends));$scope.has_friends=data.friends.length>0;Chatrooms.setBuddiesToWatchList(data.friends);$scope.requests={};angular.forEach(data.requests,mapWithIds.bind(this,$scope.requests));$scope.has_requests=data.requests.length>0;$scope.pending_requests={};angular.forEach(data.pending_requests,mapWithIds.bind(this,$scope.pending_requests));$scope.has_pending_requests=data.pending_requests.length>0;$scope.blocked={};angular.forEach(data.blocked,mapWithIds.bind(this,$scope.blocked));$scope.has_blocked=data.blocked.length>0}else{console.error('Expected an object, got this instead:',data)}}).catch(function(){console.error('Unexpected error :',arguments)}).finally(function(){$scope.is_loading=!1})};$scope.addFriend=function(){Dialog.prompt('Add a friend',"Enter your friend's nickname or email address",'text','',undefined,undefined,'chatrooms').then(function(res){if(angular.isString(res)&&res.trim().length>0){$scope.showCustomer(res)}})};$scope.loadContent();$scope.$on(Chatrooms.UPDATED_FRIENDLIST_EVENT,$scope.loadContent)});angular.module('starter').controller('ChatroomsRoomViewController',function($controller,$cordovaCamera,$ionicActionSheet,$ionicHistory,Modal,$ionicScrollDelegate,$q,$rootScope,$scope,$state,$stateParams,$timeout,$translate,Application,Chatrooms,ContextualMenu,Customer,Dialog,Url,AUTH_EVENTS,SB){angular.extend(this,$controller('ChatroomBaseController',{Modal:Modal,Dialog:Dialog,$q:$q,$rootScope:$rootScope,$scope:$scope,$stateParams:$stateParams,$timeout:$timeout,$translate:$translate,Chatrooms:Chatrooms,Customer:Customer,AUTH_EVENTS:AUTH_EVENTS,SB:SB}));$scope.private_chat=($stateParams.type==='private');$scope.receiver_id=decodeURIComponent(atob($stateParams.receiver_id));$scope._scrollBottom=function(){$timeout(function(){$ionicScrollDelegate.scrollBottom(!0)},100)};$scope.getNotificationClass=function(){if($scope.notifications===undefined){return'ion-android-notifications-off'}
if($scope.notifications.mentions&&!$scope.notifications.all){return'ion-android-notifications-none'}
if($scope.notifications.all){return'ion-android-notifications'}
return'ion-android-notifications-off'};$scope.rebuildContextualMenu=function(){if(ContextualMenu.settings.templateUrl!=='features/chatrooms/assets/templates/l1/contextual-menu.html'){ContextualMenu.init('features/chatrooms/assets/templates/l1/contextual-menu.html',275,'right')}};$scope.getRightToggleIcon=function(){return Application.getRightToggleIcon()};$scope.toggleMenu=function(){ContextualMenu.toggle('right')};$scope.loadContent=function(){Chatrooms.goOnline();if(angular.isString($scope.receiver_id)&&$scope.receiver_id.trim().length<1||angular.isNumber(+$scope.receiver_id)&&$scope.receiver_id<1){return $scope.leaveRoom()}
Chatrooms.find($scope.receiver_id,$scope.private_chat).success(function(data){if(angular.isObject(data)){$scope.chatroom=data.chatroom||null;$scope.recipient=data.recipient||null;$scope.room=data.room;$scope.nickname=Chatrooms.nickname=data.nickname;$scope.notifications=data.notifications;$scope.messages=data.messages;$scope._updateUserStatus();$scope.page_title=($scope.chatroom&&$scope.chatroom.name)||($scope.recipient&&$scope.recipient.nickname);Chatrooms.goOnline();var received_msg=function(msg){var ids=[];angular.forEach($scope.messages,function(m){ids.push(m.id)});if(ids.indexOf(msg.id)<0){$scope.messages.push(msg)}
$scope._scrollBottom()};if($scope.private_chat){var unregister_callback=Chatrooms.watchCustomer($scope.receiver_id,function(updated){$scope.recipient=updated;$scope.page_title=$scope.recipient.nickname});$scope.$on('destroy',unregister_callback)}else{if(data.private_chatroom===!0){Chatrooms.savePrivateChatroom($scope.room,angular.extend({},$scope.chatroom,{id:$scope.receiver_id}))}
$scope.receiver_id=$stateParams.receiver_id=data.chatroom.id}
Chatrooms.onMessageFrom($scope.room,received_msg);$scope.$on('$ionicView.leave',function(){Chatrooms.markRoomAsRead($scope.room);ContextualMenu.clear()});Chatrooms.joinRoom($scope.room);$scope._updateUserStatus();$scope.isFriendRoom=$scope.room.indexOf('privroom')===0;if(!$scope.isFriendRoom){$scope.rebuildContextualMenu()}else{ContextualMenu.clear()}}else{console.error('Expected an object, got this instead:',data)}}).error(function(){}).finally(function(){$scope.is_loading=!1;Chatrooms.markRoomAsRead($scope.room);if(!$scope.no_nickname()){$scope._focus_chat_input()}
$scope._scrollBottom()})};var updateNotificationsDebounced=_.debounce(Chatrooms.updateNotificationsSettings,750);$scope.toggleNotifications=function(){$scope.chooseNicknameIfNeeded().then(function(){if($scope.notifications.all){$scope.notifications.none=!0;$scope.notifications.all=$scope.notifications.mentions=!1}else if($scope.notifications.none){$scope.notifications.none=$scope.notifications.all=!1;$scope.notifications.mentions=!0}else if($scope.notifications.mentions&&!$scope.notifications.all){$scope.notifications.none=!1;$scope.notifications.all=$scope.notifications.mentions=!0}
updateNotificationsDebounced($scope.notifications,$scope.receiver_id,$scope.private_chat)})};$scope.isFromMe=function(message){return(message&&message.senderID==Customer.id)};$scope.sendMsg=function(){Chatrooms.goOnline();if(!$scope.is_sending&&!!$scope.chat_message&&$scope.isConnectedToChat){$scope.is_sending=!0;Chatrooms.sendMessage($scope.receiver_id,$scope.chat_message,$scope.private_chat).then(function(){$timeout(function(){$scope.chat_message=''})},function(){}).finally(function(){$scope.is_sending=!1;$scope._focus_chat_input()})}};$scope.thumbnail_image=function(original_url){return angular.isString(original_url)?Url.get(original_url.replace(/(.*)\/(.*).jpg$/,'$1/thumb_$2.jpg'),{remove_key:!0}):original_url};$scope.fullsize_image=function(original_url){return angular.isString(original_url)?Url.get(original_url,{remove_key:!0}):original_url};$scope.openImage=function($event,thumb_url,image_url){$scope.modalImageSrc=Url.get(image_url,{remove_key:!0});window.open($scope.modalImageSrc,'_self');$q(function(resolve){if(!$scope.imageModal){$scope.closeImageModal=function(){$scope.imageModal.hide()};Modal.fromTemplateUrl('message_image_modal.html',{scope:$scope,animation:'slide-in-right-left'}).then(function(modal){$scope.imageModal=modal;resolve()})}else{resolve()}}).then(function(){$scope.imageModal.show()});$event.stopPropagation()};$scope.sendPhoto=function(){if(!$scope.is_sending){$scope.imageToSend=null;var gotImage=function(image_url){$scope.imageToSend=image_url;Dialog.ionicPopup({template:'<center><img ng-src="{{imageToSend}}" style="max-width: 100%; max-height: 100%;"></center>',cssClass:'chatrooms no-title',scope:$scope,buttons:[{text:$translate.instant('Cancel','chatrooms'),type:'button-default',onTap:function(e){return!1}},{text:$translate.instant('OK','chatrooms'),type:'button-positive',onTap:function(e){return!0}}]}).then(function(result){if(result){$scope.is_sending=!0;Chatrooms.sendPicture($scope.receiver_id,$scope.imageToSend,$scope.private_chat).then(function(){},function(){}).finally(function(){$scope.imageToSend=null;$scope.is_sending=!1;$scope._focus_chat_input()})}else{$scope.imageToSend=null}})};var gotError=function(err){};if(DEVICE_TYPE===SB.DEVICE.TYPE_BROWSER){var input=angular.element('<input type=\'file\' accept=\'image/*\'>');var selectedFile=function(evt){var file=evt.currentTarget.files[0];var reader=new FileReader();reader.onload=function(evt){gotImage(evt.target.result);input.off('change',selectedFile)};reader.onerror=gotError;reader.readAsDataURL(file)};input.on('change',selectedFile);input[0].click()}else{var source_type=Camera.PictureSourceType.CAMERA;var hideSheet=$ionicActionSheet.show({buttons:[{text:$translate.instant('Take a picture','chatrooms')},{text:$translate.instant('Import from Library','chatrooms')}],cancelText:$translate.instant('Cancel','chatrooms'),cancel:function(){hideSheet()},buttonClicked:function(index){if(index==0){source_type=Camera.PictureSourceType.CAMERA}
if(index==1){source_type=Camera.PictureSourceType.PHOTOLIBRARY}
var options={quality:90,destinationType:Camera.DestinationType.DATA_URL,sourceType:source_type,encodingType:Camera.EncodingType.JPEG,targetWidth:1200,targetHeight:1200,correctOrientation:!0,popoverOptions:CameraPopoverOptions,saveToPhotoAlbum:!1};$cordovaCamera.getPicture(options).then(function(imageData){gotImage('data:image/jpeg;base64,'+imageData)},gotError);return!0}})}}};$scope.leaveRoom=function(){Dialog.confirm('Confirm','Are you sure you want to leave this room?',['Yes','No'],'','chatrooms').then(function(result){if(result){Chatrooms.leaveRoom($scope.room,_.get($scope,'chatroom.id'),_.get($scope,'recipient.id'));$scope.closeModal(!1);if($ionicHistory.backView()){$ionicHistory.goBack()}else{$ionicHistory.clearHistory();$ionicHistory.nextViewOptions({disableBack:!0,historyRoot:!0});$state.go('chatrooms-list',{value_id:$scope.value_id},{location:'replace'}).then(function(){$ionicHistory.backView(null);$ionicHistory.clearHistory()})}}})};$scope.$on('$ionicView.enter',function(){if($scope.is_loading===!1){$scope._focus_chat_input()}
if(angular.isString($scope.room)){Chatrooms.markRoomAsRead($scope.room)}});$scope.loadContent()});angular.module('starter').controller('ChatroomsContextualMenuController',function($scope,$rootScope,$stateParams,$controller,$q,$timeout,$translate,Chatrooms,Customer,Modal,Dialog,SB){angular.extend(this,$controller('ChatroomBaseController',{Modal:Modal,Dialog:Dialog,$q:$q,$rootScope:$rootScope,$scope:$scope,$stateParams:$stateParams,$timeout:$timeout,$translate:$translate,Chatrooms:Chatrooms,Customer:Customer,SB:SB}));angular.extend($scope,{users:{online:[]}});$scope.private_chat=($stateParams.type==='private');$scope.receiver_id=decodeURIComponent(atob($stateParams.receiver_id));$scope.is_loading=!0;$rootScope.$on('chatrooms.userlist.update',function(event,payload){if($scope.localRoom===payload.room){$scope.users.online=payload.users}});$scope.loadContent=function(){Chatrooms.goOnline();if($scope.is_loading){Chatrooms.find($scope.receiver_id,$scope.private_chat).success(function(data){if(angular.isObject(data)){$scope.localChatroom=data.chatroom;$scope.localRoom=data.room;Chatrooms.getCurrentUsers($scope.localRoom)}else{console.error('Expected an object, got this instead:',data)}}).error(function(error){}).finally(function(){$scope.is_loading=!1})}};$scope.loadContent()});angular.module('starter').factory('Chatrooms',function(_,$cordovaLocalNotification,$filter,$rootScope,$state,$http,$ionicPlatform,$pwaRequest,Url,$q,$window,$timeout,Application,Pages,Customer,SB,$session){var factory={value_id:null,SocketIO_Port:null,nickname:null,privateChatrooms:[],_prvchrmsKey:'private-chatrooms',watchedRooms:[],notificationSettings:[],localNotificationId:100,CONNECT_EVENT:'chatrooms:connect_event',DISCONNECT_EVENT:'chatrooms:disconnect_event',UPDATED_FRIENDLIST_EVENT:'chatrooms:updated_friendlist_event',};factory.reportMessage=function(messageId,reportMessage){return $pwaRequest.post('chatrooms/mobile_view/reportmessage',{urlParams:{value_id:factory.value_id},data:{messageId:messageId,reportMessage:reportMessage}})};factory.getChatrooms=function(){if(!factory.value_id){return $pwaRequest.reject("Unknown application")}
var deferred=$q.defer();$session.getItem(factory._prvchrmsKey).then(function(private_chatrooms){if(private_chatrooms===null){private_chatrooms=[]}
factory.privateChatrooms=angular.copy(private_chatrooms);var _private=private_chatrooms.map(function(item){return item.name});var roomsPromise=$pwaRequest.post('chatrooms/mobile_view/rooms',{urlParams:{value_id:factory.value_id},data:{private:_private}});roomsPromise.then(function(payload){deferred.resolve(payload);var shouldSave=!1;var privateRooms=payload.private.map(function(item){return item.room});var removed=_.remove(factory.privateChatrooms,function(r){return privateRooms.indexOf(r.room)===-1});if(removed.length>0){shouldSave=!0}
factory.watchedRooms=[];factory.notificationSettings=[];for(var j=0;j<payload.public.length;j++){var jRoom=payload.public[j];var jRoomKey=jRoom.room;factory.watchedRooms.push(jRoomKey);factory.notificationSettings[jRoomKey]=jRoom.notifications}
for(var k=0;k<payload.private.length;k++){var kRoom=payload.private[k];var kRoomKey=kRoom.room;factory.watchedRooms.push(kRoomKey);factory.notificationSettings[kRoomKey]=kRoom.notifications}
if(shouldSave){factory.savePrivateChatroom()}
if(factory.watchedRooms.length>0){factory.handleAwayForRooms(factory.watchedRooms)}},function(error){deferred.reject(error)})});return deferred.promise};factory.getInfos=function(){if(!factory.value_id){return $q.reject("Unknown application")}
return $pwaRequest.get('chatrooms/mobile_view/infos',{urlParams:{value_id:factory.value_id},cache:!1})};factory.getFriends=function(){if(!factory.value_id){return $q.reject("Unknown application")}
var friendsPromise=$pwaRequest.get('chatrooms/mobile_view/friends',{urlParams:{value_id:factory.value_id},cache:!1});friendsPromise.then(function(payload){_.forEach(_.get(payload,'friends'),function(_friend){factory.watchedRooms.push(_friend.room);factory.notificationSettings[_friend.room]=_friend.notifications});var blocked=_.get(payload,'blocked');if(_.isArray(blocked)){_blocked_users=_.map(blocked,'id')}
if(factory.watchedRooms.length>0){factory.handleAwayForRooms(factory.watchedRooms)}});return friendsPromise};factory.find=function(receiver_id,private_chat){if(!factory.value_id||!receiver_id){return $q.reject("Unknown application or chatroom")}
var transforms=$http.defaults.transformResponse;transforms=angular.isArray(transforms)?transforms:[transforms];transforms.push(function(data){if(angular.isObject(data)&&angular.isArray(data.messages)){angular.forEach(data.messages,function(msg,messageIndex){if(!msg.decoded){msg.message=window.Base64.fromBase64(msg.message);msg.decoded=!0}})}
return data});return $http({method:'GET',url:Url.get("chatrooms/mobile_view/find",{value_id:factory.value_id,receiver_id:btoa(encodeURIComponent(receiver_id)),private_chat:(private_chat===!0)}),cache:!1,responseType:'json',transformResponse:transforms})};var _socket=null;var _callbacks={};var _rooms=[];var _blocked_users=[];var _buddies=[];var _buddies_callbacks=[];var _watchedCustomers={};var __sentPush=0;var __lastPush=0;var __rooms_unread=[];var __away_rooms=[];var __is_in_background=!1;var __sentPushMessageIDs=[];$ionicPlatform.on('resume',function(result){__is_in_background=!1;__sentPush=0;__lastPush=0;if((ionic.Platform.isAndroid()||ionic.Platform.isIOS())&&(typeof $cordovaLocalNotification!=="undefined")){$cordovaLocalNotification.cancel([factory.localNotificationId])}});$ionicPlatform.on('pause',function(result){__is_in_background=!0;__sentPush=0;__lastPush=0});$rootScope.$on('$cordovaLocalNotification:click',function(event,notification,state){if(!!_.get(notification,"data.chatrooms")){$state.go("chatrooms-list",{value_id:factory.value_id})}});var $socket=function(){if(angular.isObject(_socket)&&_socket.disconnected===!0&&!(_socket.reconnecting||_socket.connecting)){try{_socket.disconnect()}catch(e){console.error(e)}
_socket=null}
if(_socket===null){_socket=new io.connect(DOMAIN+":"+factory.SocketIO_Port+"/chatrooms?appKey="+APP_KEY,{'reconnection':!0,'reconnectionDelay':1000,'reconnectionDelayMax':5000,'reconnectionAttempts':30});_bindListeners()}
return _socket};factory._loggedIn=function(){factory.goOnline();$rootScope.$broadcast(factory.UPDATED_FRIENDLIST_EVENT);factory.getChatrooms();factory.getFriends()};factory._loggedOut=function(){factory.goOffline();$rootScope.$broadcast(factory.UPDATED_FRIENDLIST_EVENT);factory.handleAwayForRooms([])};factory.connected=!1;factory.isInit=!1;factory.init=function(){if(factory.isInit){return}
$rootScope.$on(SB.EVENTS.AUTH.loginSuccess,factory._loggedIn);$rootScope.$on(SB.EVENTS.AUTH.logoutSuccess,factory._loggedOut);factory.getInfos().success(function(data){factory.SocketIO_Port=data.socket_io_port;if(Customer.isLoggedIn()){factory._loggedIn()}else{factory._loggedOut()}});factory.isInit=!0};var _bindListeners=function(){var filter_callbacks=function(callbacks,payload){if(angular.isObject(payload)&&angular.isString(payload.room)){if(angular.isArray(callbacks[payload.room])){angular.forEach(callbacks[payload.room],function(callback){$timeout(callback.bind(null,payload))})}}};var process_message=filter_callbacks.bind(this,_callbacks);_socket.on('userlist',function(payload){$rootScope.$broadcast('chatrooms.userlist.update',payload)});_socket.on('msg',process_message);_socket.on('privmsg',process_message);_socket.on('customer_status_update',function(payload){if(angular.isObject(payload)&&angular.isNumber(payload.id)){if(_buddies.indexOf(payload.id)>=0){angular.forEach(_buddies_callbacks,function(callback){$timeout(callback.bind(null,payload))})}
if(angular.isObject(_watchedCustomers[payload.id])){angular.forEach(_watchedCustomers[payload.id],function(callback){$timeout(callback.bind(null,payload))})}}});_socket.on('buddy_list_update',function(){$rootScope.$broadcast(factory.UPDATED_FRIENDLIST_EVENT);factory.getFriends().success(function(data){var blocked=_.get(data,"blocked");if(_.isArray(blocked))_blocked_users=_.map(blocked,"id")})});var onConnect=function(){factory.connected=!0;$rootScope.$broadcast(factory.CONNECT_EVENT);factory.goOnline();angular.forEach(_rooms,factory.joinRoom);angular.forEach(_buddies,factory.addBuddyToWatchList);angular.forEach(_watchedCustomers,function(o,key){if(+key>0){_watchCustomer(key)}})};var onDisconnect=function(){factory.connected=!1;$rootScope.$broadcast(factory.DISCONNECT_EVENT)};_socket.on("connect",onConnect);_socket.on("reconnect",onConnect);_socket.on("disconnect",onDisconnect);_socket.on("reconnect_failed",onDisconnect)};var payload=function(payload){if(!angular.isObject(payload)){payload={}}
return angular.extend({},{sessionID:$session.getId(),appID:Application.app_id,valueID:factory.value_id},payload)};factory.goOnline=function(){$socket().emit("online",payload());return $q.resolve()};factory.goOffline=function(){if(_socket!==null){$socket().close();_socket=null}
_callbacks={};_rooms=[];_buddies=[];_buddies_callbacks=[];_watchedCustomers={};__sentPush=0;__lastPush=0;__rooms_unread=[];__away_rooms=[];_blocked_users=[]};factory.setNickname=function(new_nickname){if(!factory.value_id){return $q.reject("Unknown application")}
var promise=$pwaRequest.post('chatrooms/mobile_view/set-nickname2',{urlParams:{value_id:factory.value_id},data:{nickname:new_nickname}});promise.then(function(){factory.goOnline();factory.nickname=new_nickname});return promise};factory.updateNotificationsSettings=function(notifications,receiver_id,private_chat){if(!factory.value_id){return $q.reject("Unknown application")}
var request=$http.postForm(Url.get("chatrooms/mobile_view/setnotificationssettings",{value_id:factory.value_id}),{notifications:notifications,receiver_id:receiver_id,private_chat:(private_chat===!0)},{cache:!1});request.success(function(data){if(_.isObject(data)&&data.ok===!0){factory.notificationSettings[data.room]=notifications}});return request};factory.getCustomerInfos=function(query){if(!factory.value_id){return $q.reject("Unknown application")}
return $http({method:'GET',url:Url.get("chatrooms/mobile_view/getcustomerinfos",{value_id:factory.value_id,query:query}),cache:!1,responseType:'json'})};angular.forEach({addBuddy:"addbuddy",removeBuddy:"removebuddy",blockBuddy:"blockbuddy",unblockBuddy:"unblockbuddy",},function(php_method,js_method){factory[js_method]=function(customer_id){if(!factory.value_id){return $q.reject("Unknown application")}
return $http.postForm(Url.get("chatrooms/mobile_view/"+php_method,{value_id:factory.value_id}),{customer_id:customer_id},{cache:!1}).success(function(data){if(angular.isObject(data)&&data.ok===!0){$socket().emit("buddy_list_update",payload({customer_id:+customer_id}))}})}});var _watchCustomer=function(customer_id){$socket().emit('watch_customer',payload({customer_id:+customer_id}))};var _unwatchCustomer=function(customer_id){$socket().emit('unwatch_customer',payload({customer_id:+customer_id}))};factory.addBuddyToWatchList=function(buddy_id){if(angular.isNumber(+buddy_id)&&(+buddy_id)>0){_watchCustomer(+buddy_id);if(_buddies.indexOf(+buddy_id)<0)
_buddies.push(+buddy_id)}};factory.setBuddiesToWatchList=function(buddies){if(angular.isArray(buddies)){angular.forEach(_buddies,_unwatchCustomer);angular.forEach(buddies,function(buddy){var buddy_id=null;if(angular.isObject(buddy))
buddy_id=+buddy.id;else if(angular.isNumber(+buddy))
buddy_id=+buddy;if(angular.isNumber(buddy_id)&&buddy_id>0){factory.addBuddyToWatchList(buddy_id)}})}};factory.watchCustomer=function(customer_id,callback){customer_id=+customer_id;if(!factory.value_id){return $q.reject("Unknown application")}
if(!angular.isNumber(customer_id)||(customer_id)<1){return $q.reject("Unknown ")}
if(!angular.isFunction(callback)){return $q.reject("callback must be a function")}
if(!angular.isObject(_watchedCustomers))
_watchedCustomers={};if(!angular.isObject(_watchedCustomers[customer_id]))
_watchedCustomers[customer_id]={};var random_id=Math.round(Math.random()*(new Date()*Math.random()*customer_id));_watchedCustomers[customer_id][random_id]=callback;_watchCustomer(customer_id);return $q.resolve(function removeCallback(){if(angular.isObject(_watchedCustomers)){if(angular.isObject(_watchedCustomers[customer_id])){_watchedCustomers[customer_id][random_id]=undefined;delete _watchedCustomers[customer_id][random_id];if(Object.keys(_watchedCustomers[customer_id]).length<1){_unwatchCustomer(customer_id);_watchedCustomers[customer_id]=undefined;delete _watchedCustomers[customer_id]}}else{_unwatchCustomer(customer_id)}}})};factory.sendMessage=function(receiver,message,private_chat){private_chat=(private_chat===!0);if(!factory.value_id||!receiver){return $q.reject("Unknown application or chatroom")}
$socket().emit(private_chat?'sendprivmsg':'sendmsg',payload({receiver_id:receiver,sender_avatar:Customer.getAvatarUrl(Customer.id),message:message}));return $q.resolve()};factory.sendPicture=function(receiver,image,private_chat){if(!factory.value_id||!angular.isString(receiver)||receiver.length<1){return $q.reject("Unknown application or chatroom")}
var q=$q.defer();$http.postForm(Url.get("chatrooms/mobile_view/uploadimage",{value_id:factory.value_id}),{image:image},{cache:!1}).success(function(data){if(angular.isObject(data)&&data.ok===!0&&angular.isString(data.url)&&data.url.length>0){$socket().emit(private_chat?'sendprivmsg':'sendmsg',payload({receiver_id:receiver,image:data.url}));q.resolve(!0)}}).error(q.resolve);return q.promise};factory.getCurrentUsers=function(room){if(!factory.value_id||!angular.isString(room)||room.length<1){return}
$socket().emit('get_user_list',payload({room:room}))};factory.joinRoom=function(room){if(!factory.value_id||!angular.isString(room)||room.length<1){return $q.reject("Unknown application or chatroom")}
$socket().emit('join_room',payload({room:room}));if(_rooms.indexOf(room)<0)
_rooms.push(room);return $q.resolve()};factory.savePrivateChatroom=function(room_id,room_infos){if(room_id!==undefined&&room_infos!==undefined){room_infos.room=room_id;factory.privateChatrooms.push(room_infos)}
factory.privateChatrooms=angular.copy(_.uniqBy(factory.privateChatrooms,'id'));$session.setItem(factory._prvchrmsKey,factory.privateChatrooms)};factory.leaveRoom=function(room,chatroom_id,recipient_id){if(!factory.value_id||!angular.isString(room)||room.length<1){return $q.reject("Unknown application or chatroom")}
$socket().emit('leave_room',payload({room:room,chatroom_id:chatroom_id,recipient_id:recipient_id}));var room_index=_rooms.indexOf(room);if(room_index>=0)
_rooms.splice(room_index,1);_.remove(factory.privateChatrooms,function(r){return r.room===room});factory.savePrivateChatroom();factory.handleAwayForRooms(_.without(__away_rooms,room));return $q.resolve()};factory.onMessageFrom=function(room,callback){if(!factory.value_id||!angular.isString(room)||room.length<1){return $q.reject("Unknown application or chatroom")}
if(!angular.isFunction(callback)){return $q.reject("callback must be a function")}
_callbacks[room]=_callbacks[room]||[];_callbacks[room].push(callback);return $q.resolve()};factory.markRoomAsRead=function(room){__rooms_unread[room]=[]};factory.unreadCountForRoom=function(room){__rooms_unread[room]=__rooms_unread[room]||[];return __rooms_unread[room].length}
factory.handleAwayForRooms=function(rooms){if(!factory.value_id||!angular.isArray(rooms)){return $q.reject("Unknown application or rooms is not an array")}
var handle_away=function(data){if(data.senderID!=Customer.id){__rooms_unread[data.room]=__rooms_unread[data.room]||[];__rooms_unread[data.room].push(data);__rooms_unread[data.room]=_.uniq(__rooms_unread[data.room]);if(__is_in_background){var should_notify_message=!1;if(!_.includes(_blocked_users,data.senderID)){if(_.get(factory.notificationSettings,"["+data.room+"].all",/^privroom:/.test(data.room))){should_notify_message=!0}else if(_.get(factory.notificationSettings,"["+data.room+"].mentions",/^room:/.test(data.room))){var mentioned=new RegExp("\\b@?"+factory.nickname+"\\b","gi");if(!!(data.message.match(mentioned))){should_notify_message=!0}}}
if((__lastPush+(15*60*1000))<(+new Date())){__sentPush=0}
if(should_notify_message&&__sentPush<5&&!_.includes(__sentPushMessageIDs,data.id)){__sentPushMessageIDs.push(data.id);__sentPush++;__lastPush=+(new Date());var params={id:factory.localNotificationId,data:{chatrooms:!0,cover:Customer.getAvatarUrl(data.senderID)}};if(ionic.Platform.isIOS()){params.title=data.nickname+": "+$filter('emojify')(data.message)}else{params.title=data.nickname;params.text=$filter('emojify')(data.message)}
if(ionic.Platform.isAndroid())
params.icon="res://icon.png";params.data={chatrooms:!0};if(typeof $cordovaLocalNotification!=="undefined"){$cordovaLocalNotification.schedule(params)}}}}};angular.forEach(__away_rooms,function(room){if(angular.isArray(_callbacks[room])){var index=_callbacks[room].indexOf(handle_away);while(index>-1){_callbacks[room].splice(index,1);index=_callbacks[room].indexOf(handle_away)}}});__away_rooms=rooms;angular.forEach(__away_rooms,function(room){factory.onMessageFrom(room,handle_away);factory.joinRoom(room)})};factory.onBuddiesStatusChange=function(callback){if(!factory.value_id){return $q.reject("Unknown application")}
if(!angular.isFunction(callback)){return $q.reject("callback must be a function")}
_buddies_callbacks=_buddies_callbacks||[];_buddies_callbacks.push(callback);return $q.resolve()};factory.onStart=function(){Application.loaded.then(function(){var chatrooms=_.find(Pages.getActivePages(),{code:'chatrooms'});if(!chatrooms){return}
factory.value_id=parseInt(chatrooms.value_id,10);factory.init()})};return factory});Features.insertCSS(":root{--safe-area-inset-top:0;--safe-area-inset-right:0;--safe-area-inset-bottom:0;--safe-area-inset-left:0}@supports (padding-top:constant(safe-area-inset-top)){:root{--safe-area-inset-top:constant(safe-area-inset-top);--safe-area-inset-right:constant(safe-area-inset-right);--safe-area-inset-bottom:constant(safe-area-inset-bottom);--safe-area-inset-left:constant(safe-area-inset-left)}}@supports (padding-top:env(safe-area-inset-top)){:root{--safe-area-inset-top:env(safe-area-inset-top);--safe-area-inset-right:env(safe-area-inset-right);--safe-area-inset-bottom:env(safe-area-inset-bottom);--safe-area-inset-left:env(safe-area-inset-left)}}.platform-overview.platform-cordova{--safe-area-inset-top:1.5em;--safe-area-inset-right:0;--safe-area-inset-bottom:.5em;--safe-area-inset-left:0}.chatrooms .friend{font-style:italic}.chatrooms .friend .status-bubble{display:inline-block;height:10px;width:10px;border-radius:100%;background-color:#ccc;margin-right:5px}.chatrooms .friend.online{font-style:normal;font-weight:700}.chatrooms .friend.online .status-bubble{background-color:#478500}.chatrooms .item .message-img{max-width:100%;max-height:480px}.chatrooms .item .message-date{font-size:70%;font-style:italic;color:#ccc}.chatrooms.chatrooms-profile .profile-avatar{border-radius:50%;padding:.4em}.chatrooms.popup-container .popup{width:90%}.chatrooms.popup-container.profile img{float:left;margin:8px}.chatrooms.popup-container.no-title .popup .popup-head{display:none}.chatrooms.popover-custom{height:134px;border-radius:2px!important}.chatrooms.popover-content-custom{border-radius:2px!important;margin:0!important;background:none}.chatrooms .popover-arrow{display:none!important}.chatrooms .item-input-wrapper{padding:2px}.chatrooms .item-input-inset{padding:0}.chatrooms .button-send-msg{margin:0!important}.chatrooms .nickname{padding-left:2px;padding-right:10px}.chatrooms span.time{font-size:12px}.chatrooms .footer-bar{border:0;margin:0}.chatrooms .message-bubble-line{background:transparent;border:none;padding-top:12px;padding-bottom:8px}.chatrooms .message-bubble-line.item.activated{background:transparent;border:none}.chatrooms .message-bubble{font-size:20px;max-width:100%;padding:6px 12px;border:0;border-radius:12px}.chatrooms .message-bubble.pull-left{float:left}.chatrooms .message-bubble.pull-right{float:right}.chatrooms .from-me{position:relative;padding:10px 20px;color:#fff;background:#0b93f6;border-radius:25px;float:right}.chatrooms .from-me:before{content:\"\";position:absolute;z-index:-1;bottom:-2px;right:-7px;height:20px;border-right:20px solid #0b93f6;border-bottom-left-radius:16px 14px;-webkit-transform:translate(0,-2px)}.chatrooms .from-me:after{content:\"\";position:absolute;z-index:1;bottom:-2px;right:-56px;width:26px;height:20px;background:#fff;border-bottom-left-radius:10px;-webkit-transform:translate(-30px,-2px)}.chatrooms .from-them{position:relative;padding:10px 20px;background:#e5e5ea;border-radius:25px;color:#000;float:left}.chatrooms .from-them:before{content:\"\";position:absolute;z-index:2;bottom:-2px;left:-7px;height:20px;border-left:20px solid #e5e5ea;border-bottom-right-radius:16px 14px;-webkit-transform:translate(0,-2px)}.chatrooms .from-them:after{content:\"\";position:absolute;z-index:3;bottom:-2px;left:4px;width:26px;height:20px;background:#fff;border-bottom-right-radius:10px;-webkit-transform:translate(-30px,-2px)}.chatrooms .chatrooms-spacer{margin-top:20px}.chatrooms .chatroom-rooms-list .item.item-custom{padding:0}.chatrooms .chatroom-rooms-list .item.item-custom h2{font-weight:700}.chatrooms.chatrooms-contextual-menu{background-color:#fff!important}.chatrooms.chatrooms-contextual-menu .item-custom-user-list{padding:5px!important}.chatrooms .message{font-size:70%;font-variant:normal}.chatrooms .message .emoji{font-size:100%;margin:0 3px}.chatrooms .notifications-toggle{margin-right:10px}.chatrooms .n-icons{font-size:24px;vertical-align:sub;margin-right:10px}.chatrooms .message-img img{max-width:100%;height:auto!important;border:2px solid #fff;border-radius:3px}.chatrooms ion-content.chatroom-view{overflow-y:visible!important}.chatrooms ion-footer-bar form[name=chat_msg_form]{width:100%;display:flex}.platform-android .chatrooms.popover-custom{margin-top:10px!important}@media (min-width:430px){.chatrooms.popup-container .popup{width:400px}}.mini-radio .chatrooms ion-footer-bar{bottom:75px}.layout-l1 .has-footer-fixed .chatrooms ion-content.chatroom-view{bottom:calc(var(--safe-area-inset-bottom) + 100px)}.layout-l1 .has-footer-fixed .chatrooms ion-footer-bar form[name=chat_msg_form]{bottom:calc(var(--safe-area-inset-bottom) + 55px);position:fixed;right:0;left:0}.layout-l1 .has-footer-fixed .mini-radio .chatrooms ion-footer-bar{bottom:calc(var(--safe-area-inset-bottom) + 55px + 75px)!important}","chatrooms")