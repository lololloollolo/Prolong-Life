angular.module("starter").directive("mmobilcartFooter",function($translate,Dialog,$state,$ionicHistory,MmobilcartCart,$ionicTabsDelegate,$window,$stateParams){return{restrict:'EA',templateUrl:'features/m_mobilcart/assets/templates/l1/tabs.html',link:function($scope,element,attrs){$scope.use_exit=0;$scope.bottom_titles=0;$scope.cart_total_badge=0;$scope.disable_special=1;$scope.footer_special_total_count=0;$scope.tab_order_history_name="";$scope.tab_cart_name="";$scope.tab_home_name="";$scope.tab_exit_name="";$scope.tab_specials_name="";$scope.tab_order_history_icon="";$scope.tab_cart_icon="";$scope.tab_home_icon="";$scope.tab_exit_icon="";$scope.tab_specials_icon="";MmobilcartCart.value_id=$stateParams.value_id;$scope.value_id=$stateParams.value_id;if($window.localStorage.getItem("mmobilcart_disable_special")!=""){$scope.disable_special=parseInt($window.localStorage.getItem("mmobilcart_disable_special"))}
if($window.localStorage.getItem("mmobilcart_tab_order_history_name")!=""){$scope.tab_order_history_name=$window.localStorage.getItem("mmobilcart_tab_order_history_name")}
if($window.localStorage.getItem("mmobilcart_tab_cart_name")!=""){$scope.tab_cart_name=$window.localStorage.getItem("mmobilcart_tab_cart_name")}
if($window.localStorage.getItem("mmobilcart_tab_home_name")!=""){$scope.tab_home_name=$window.localStorage.getItem("mmobilcart_tab_home_name")}
if($window.localStorage.getItem("mmobilcart_tab_exit_name")!=""){$scope.tab_exit_name=$window.localStorage.getItem("mmobilcart_tab_exit_name")}
if($window.localStorage.getItem("mmobilcart_tab_specials_name")!=""){$scope.tab_specials_name=$window.localStorage.getItem("mmobilcart_tab_specials_name")}
if($window.localStorage.getItem("mmobilcart_use_exit")!=""){$scope.use_exit=parseInt($window.localStorage.getItem("mmobilcart_use_exit"),10)}
if($window.localStorage.getItem("mmobilcart_bottom_titles")!=""){$scope.bottom_titles=parseInt($window.localStorage.getItem("mmobilcart_bottom_titles"),10)}
if($window.localStorage.getItem("mmobilcart_tab_order_history_icon")!=""){$scope.tab_order_history_icon=$window.localStorage.getItem("mmobilcart_tab_order_history_icon")}
if($window.localStorage.getItem("mmobilcart_tab_cart_icon")!=""){$scope.tab_cart_icon=$window.localStorage.getItem("mmobilcart_tab_cart_icon")}
if($window.localStorage.getItem("mmobilcart_tab_home_icon")!=""){$scope.tab_home_icon=$window.localStorage.getItem("mmobilcart_tab_home_icon")}
if($window.localStorage.getItem("mmobilcart_tab_specials_icon")!=""){$scope.tab_specials_icon=$window.localStorage.getItem("mmobilcart_tab_specials_icon")}
if($window.localStorage.getItem("mmobilcart_tab_exit_icon")!=""){$scope.tab_exit_icon=$window.localStorage.getItem("mmobilcart_tab_exit_icon")}
console.log($scope);$scope.footer_update=function(){MmobilcartCart.getFooter().then(function(data){console.log('Footer say: curren data is');console.log(data);if($scope.tab_order_history_name!=data.mmobilcart_data.orders_name){$scope.tab_order_history_name=data.mmobilcart_data.orders_name;$window.localStorage.setItem("mmobilcart_tab_order_history_name",$scope.tab_order_history_name)}
if($scope.tab_cart_name!=data.mmobilcart_data.cart_name){$scope.tab_cart_name=data.mmobilcart_data.cart_name;$window.localStorage.setItem("mmobilcart_tab_cart_name",$scope.tab_cart_name)}
if($scope.tab_home_name!=data.mmobilcart_data.home_name){$scope.tab_home_name=data.mmobilcart_data.home_name;$window.localStorage.setItem("mmobilcart_tab_home_name",$scope.tab_home_name)}
if($scope.tab_specials_name!=data.mmobilcart_data.special_name){$scope.tab_specials_name=data.mmobilcart_data.special_name;$window.localStorage.setItem("mmobilcart_tab_specials_name",$scope.tab_specials_name)}
if($scope.tab_exit_name!=data.mmobilcart_data.exit_name){$scope.tab_exit_name=data.mmobilcart_data.exit_name;$window.localStorage.setItem("mmobilcart_tab_exit_name",$scope.tab_exit_name)}
if($scope.use_exit!=data.mmobilcart_data.use_exit){$scope.use_exit=data.mmobilcart_data.use_exit;$window.localStorage.setItem("mmobilcart_use_exit",$scope.use_exit)}
if($scope.tab_order_history_icon!=data.mmobilcart_data.orders_icon){$scope.tab_order_history_icon=data.mmobilcart_data.orders_icon;$window.localStorage.setItem("mmobilcart_tab_order_history_icon",$scope.tab_order_history_icon)}
if($scope.tab_cart_icon!=data.mmobilcart_data.cart_icon){$scope.tab_cart_icon=data.mmobilcart_data.cart_icon;$window.localStorage.setItem("mmobilcart_tab_cart_icon",$scope.tab_cart_icon)}
if($scope.tab_home_icon!=data.mmobilcart_data.home_icon){$scope.tab_home_icon=data.mmobilcart_data.home_icon;$window.localStorage.setItem("mmobilcart_tab_home_icon",$scope.tab_home_icon)}
if($scope.tab_specials_icon!=data.mmobilcart_data.special_icon){$scope.tab_specials_icon=data.mmobilcart_data.special_icon;$window.localStorage.setItem("mmobilcart_tab_specials_icon",$scope.tab_specials_icon)}
if($scope.tab_exit_icon!=data.mmobilcart_data.exit_icon){$scope.tab_exit_icon=data.mmobilcart_data.exit_icon;$window.localStorage.setItem("mmobilcart_tab_exit_icon",$scope.tab_exit_icon)}
if($scope.disable_special!=(data.mmobilcart_data.disable_special)){$window.localStorage.setItem("mmobilcart_disable_special",data.mmobilcart_data.disable_special);$scope.disable_special=data.mmobilcart_data.disable_special}
if($scope.bottom_titles!=(data.mmobilcart_data.bottom_titles)){$window.localStorage.setItem("mmobilcart_bottom_titles",data.mmobilcart_data.bottom_titles);$scope.bottom_titles=data.mmobilcart_data.bottom_titles}
$scope.footer_special_total_count=data.special_total_count;$scope.cart_total_badge=data.cart_total})}
$scope.footer_update();$scope.$on('MobilcartCartIsUpdated',function(event,data){console.log("Cart is update event.");$scope.footer_update()});console.log('Footer say: curren state is');console.log($state);$scope.setActiveTab=function(){if($state.current.name=="mmobilcart-category-list"||$state.current.name=="mmobilcart-subcategory-list"||$state.current.name=="mmobilcart-product-view")$ionicTabsDelegate.select(3);else if($state.current.name=="mmobilcart-specials")$ionicTabsDelegate.select(2);else if($state.current.name=="mmobilcart-sales-history")$ionicTabsDelegate.select(1);else if($state.current.name=="mmobilcart-sales-history-details")$ionicTabsDelegate.select(1);else $ionicTabsDelegate.select(4)}
$scope.setActiveTab();$scope.openCart=function(){if(!$scope.is_loading){$state.go('mmobilcart-cart-view',{value_id:$scope.value_id})}};$scope.closeMobilcart=function(){$state.go('home')};$scope.goHome=function(){if(!$scope.is_loading){$state.go('mmobilcart-category-list',{value_id:$scope.value_id})}};$scope.openHistory=function(){if(!$scope.is_loading){$state.go('mmobilcart-sales-history',{value_id:$scope.value_id})}};$scope.openSpecials=function(){if(!$scope.is_loading){$state.go('mmobilcart-specials',{value_id:$scope.value_id})}}}}});angular.module("starter").config(['$ionicConfigProvider',function($ionicConfigProvider){$ionicConfigProvider.tabs.position('bottom')}]);angular.module('starter').controller('MMobilcartCartViewController',function($scope,$state,Loader,$stateParams,$translate,$timeout,Dialog,$log,MmobilcartCart,Customer,$timeout,$window,$ionicTabsDelegate){var updateTipTimoutFn=null;$scope.is_loading=!0;$scope.points_data={use_points:!1,nb_points_used:0};MmobilcartCart.value_id=$stateParams.value_id;$scope.value_id=$stateParams.value_id;$scope.page_title=$translate.instant('Cart');$scope.tab_specials_name=$translate.instant("Specials");MmobilcartCart.value_id=$stateParams.value_id;$scope.special_total_count=0;$scope.cart_total_badge="";$scope.cart_total_badge_updating=0;$scope.cart_total_badge_update=function(){if($scope.cart_total_badge_updating==0){console.log("update total cart event");$scope.cart_total_badge_updating=1;MmobilcartCart.getOnlyTotal().then(function(data){if(data.cart_total==null||data.cart_total==0)$scope.cart_total_badge="";else $scope.cart_total_badge=data.cart_total.toString();$window.localStorage.setItem("cart_total_badge",$scope.cart_total_badge)});$scope.cart_total_badge_updating=0}}
$scope.cart_total_badge_update();$scope.loadContent=function(){Loader.show('Updating price');$scope.is_loading=!0;$scope.cart_total_badge_update();MmobilcartCart.compute().then(function(computation){$scope.computation=computation}).then(function(){$scope.computation=angular.isObject($scope.computation)?$scope.computation:{};MmobilcartCart.find().then(function(data){if(data.cart.tip===0){data.cart.tip=''}
if(angular.isObject($scope.cart)&&(!angular.isString(data.cart.discount_code)||data.cart.discount_code.trim().length<1)){data.cart.discount_code=$scope.cart.discount_code}
$scope.cart=data.cart;$scope.special_total_count=data.special_total_count;$scope.cart.discount_message=$scope.computation.message;$scope.cart.discount=$scope.computation.discount;$scope.nb_stores=data.nb_stores;if($scope.cart.lines.length>0){$scope.right_button={action:$scope.proceed,label:$translate.instant('Proceed')}}}).then(function(){Customer.find().then(function(data){$scope.cart.customer_fidelity_points=(data.metadatas&&data.metadatas.fidelity_points)?data.metadatas.fidelity_points.points:null;if(!$scope.points_data.use_points){$scope.points_data.nb_points_used=parseInt($scope.cart.customer_fidelity_points)}
$scope.updateEstimatedDiscount()}).then(function(){Loader.hide();$scope.is_loading=!1})})})};$scope.updateEstimatedDiscount=function(){if($scope.points_data.nb_points_used>0){$scope.cart.estimated_fidelity_discount=(Math.round($scope.points_data.nb_points_used*$scope.cart.fidelity_rate*100)/100)+' '+$scope.cart.currency_code}};$scope.useFidelityChange=function(){if($scope.points_data.use_points){$scope.cart.discount_code='';$scope.updateTipAndDiscount()}};$scope.openSpecials=function(){if(!$scope.is_loading){$state.go('mmobilcart-specials',{value_id:$scope.value_id})}};$scope.closeMobilcart=function(){$state.go('home')};$scope._update=_.debounce(function(){Loader.show('Updating price');$scope.$broadcast('MobilcartCartIsUpdated','1');$scope.is_loading=!0;MmobilcartCart.adddiscount($scope.cart.discount_code,!0).then(function(){MmobilcartCart.addTip($scope.cart).then(function(data){if(data.success){if(angular.isDefined(data.message)){Dialog.alert('',data.message,'OK');return}}},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert('',data.message,'OK')}}).then(function(){$scope.loadContent();Loader.hide();$scope.is_loading=!1})},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert('',data.message,'OK')}}).then(function(){Loader.hide();$scope.is_loading=!1})},900);$scope.updateTipAndDiscount=function(){$scope._update()};$scope.proceed=function(){Loader.show();var gotToNext=function(){if(!$scope.cart.valid){$scope.cartIdInvalid()}else if($scope.nb_stores>1){$scope.goToStoreChoice()}else{$scope.goToDeliveryPage()}};if($scope.cart&&$scope.cart.discount_code){MmobilcartCart.adddiscount($scope.cart.discount_code,!0).then(function(data){if(data&&data.success){gotToNext()}else{if(data&&data.message){Dialog.alert('',data.message,'OK')}else{Dialog.alert('','Unexpected Error','OK')}}},function(resp){var data=resp.data;if(data&&angular.isDefined(data.message)){Dialog.alert('',data.message,'OK')}}).then(function(){Loader.hide()})}else if($scope.points_data.use_points){if($scope.points_data.nb_points_used>0){if($scope.points_data.nb_points_used<=$scope.cart.customer_fidelity_points){MmobilcartCart.useFidelityPoints($scope.points_data.nb_points_used).then(function(data){gotToNext()},function(data){Dialog.alert('',data.message,'OK')}).then(function(){Loader.hide()})}else{Dialog.alert('',"You don't have enough points",'OK')}}}else{MmobilcartCart.removeAllDiscount().then(function(data){gotToNext()},function(data){Dialog.alert('',data.message,'OK')}).then(function(){Loader.hide()})}};$scope.cartIdInvalid=function(){Dialog.alert('',$scope.cart.valid_message,'OK')};$scope.goToStoreChoice=function(){$state.go('mmobilcart-sales-store',{value_id:$scope.value_id})};$scope.goToDeliveryPage=function(){if(!$scope.is_loading){$state.go('mmobilcart-sales-delivery',{value_id:$scope.value_id})}};$scope.goToCategories=function(){$state.go('mmobilcart-category-list',{value_id:$scope.value_id})};$scope.removeLine=function(line){Loader.show('Updating price');$scope.is_loading=!0;MmobilcartCart.deleteLine(line.id).then(function(data){if(data.success){if(angular.isDefined(data.message)){Dialog.alert('',data.message,'OK');return}
$scope.$broadcast('MobilcartCartIsUpdated','1');$scope.loadContent()}},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert('',data.message,'OK')}})};$scope.changeQuantity=function(qty,params){Loader.show('Updating price');$scope.is_loading=!0;var localLine=angular.copy(params.line);localLine.qty=angular.copy(qty);return MmobilcartCart.modifyLine(localLine).then(function(data){console.log(data.cart);$scope.cart.formattedSubtotalExclTax=data.cart.formattedSubtotalExclTax;$scope.cart.formattedDeliveryCost=data.cart.formattedDeliveryCost;$scope.cart.formattedTotalExclTax=data.cart.formattedTotalExclTax;$scope.cart.formattedTotalTax=data.cart.formattedTotalTax;$scope.cart.formattedTotal=data.cart.formattedTotal;$scope.cart.formattedDeductedTva=data.cart.formattedDeductedTva;$scope.cart.deliveryCost=data.cart.deliveryCost;$scope.cart.valid=data.cart.valid;$scope.$broadcast('MobilcartCartIsUpdated','1');return data},function(data){if(data&&angular.isDefined(data.message)){$scope.message=new Message();$scope.message.isError(!0).setText(data.message).show()}}).then(function(data){var scopeLineIndex=_.findIndex($scope.cart.lines,function(line){return line.id==data.line.id});$timeout(function(){$scope.cart.lines[scopeLineIndex]=data.line;$scope.cart.lines[scopeLineIndex].qty=data.line.qty;$scope.cart_total_badge_update();Loader.hide();$scope.is_loading=!1},500);return data}).catch(function(){Loader.hide();$scope.is_loading=!1})};$scope.loadContent();$scope.goHome=function(){if(!$scope.is_loading){$state.go('mmobilcart-category-list',{value_id:$scope.value_id})}};$scope.openCart=function(){if(!$scope.is_loading){$state.go("mmobilcart-cart-view",{value_id:$scope.value_id})}};$scope.openHistory=function(){if(!$scope.is_loading){$state.go('mmobilcart-sales-history',{value_id:$scope.value_id})}}});angular.module('starter').controller('MMobilcartListController',function(Loader,$location,$scope,$state,$window,Dialog,$stateParams,MmobilcartCategory,MmobilcartOffline,Customer,$ionicHistory,$translate,MmobilcartCart,$timeout,$ionicTabsDelegate){$scope.is_loading=!0;Loader.show();$scope.factory=MmobilcartCategory;$scope.collection=[];$scope.collection_all=[];$scope.collection_category=[];$scope.collection_category_is_empty=!0;$scope.collection_is_empty=!0;$scope.is_offline=0;$scope.offline_text="";$scope.show_sku=0;$scope.show_model=0;$scope.use_exit=0;$scope.show_category_info=1;$scope.categories_list_type=0;$scope.products_list_type=0;$scope.categories_list_chunks=[];$scope.products_list_chunks=[];$scope.products_list_chunks_all=[];$scope.special_is_hidden=!0;$scope.load_more=!1;$scope.load_more_button=!1;$scope.is_more_delay=!1;$scope.products_limit=10;$scope.products_limit_now=10;$scope.products_total=0;$scope.category_row_type=0;$scope.quick_order=0;MmobilcartCart.value_id=$stateParams.value_id;$scope.tab_order_history_name=$translate.instant("Order history");$scope.tab_cart_name=$translate.instant("My Cart");$scope.tab_home_name=$translate.instant("Home");$scope.tab_specials_name=$translate.instant("Specials");$scope.tab_exit=$translate.instant("Exit");$scope.special_total_count=0;$scope.cart_total_badge="";$scope.cart_total_badge_updating=0;$scope.cart_total_badge_update=function(){if($scope.cart_total_badge_updating==0){console.log("update total cart event");$scope.cart_total_badge_updating=1;MmobilcartCart.getOnlyTotal().then(function(data){if(data.cart_total==null||data.cart_total==0)$scope.cart_total_badge="";else $scope.cart_total_badge=data.cart_total.toString();$window.localStorage.setItem("cart_total_badge",$scope.cart_total_badge)});$scope.cart_total_badge_updating=0}}
$scope.cart_total_badge_update();$timeout(function(){$scope.cart_total_badge_update()},3000);if($window.localStorage.getItem("mmobilcart_use_exit")=="1"){$scope.use_exit=1}
$ionicTabsDelegate.select(3);MmobilcartOffline.value_id=$stateParams.value_id;MmobilcartCategory.value_id=$stateParams.value_id;MmobilcartCategory.category_id=$stateParams.category_id;$scope.value_id=$stateParams.value_id;$scope.use_button_header=!1;if(Customer.isLoggedIn()&&!$stateParams.category_id){$scope.use_button_header=!0}
MmobilcartOffline.findAll().then(function(data){if(data.is_offline==1){console.log('do offline');console.log(data);$ionicHistory.nextViewOptions({disableAnimate:!0});$state.go('offline-mode',{value_id:$scope.value_id})}});$scope.chunkArray=function(myArray,chunk_size){var results=[];while(myArray.length){results.push(myArray.splice(0,chunk_size))}
return results}
$scope.loadContent=function(){MmobilcartCategory.findAll().then(function(data){$scope.show_search=data.show_search;$scope.collection=data.collection;$scope.products_total=data.collection.length;$scope.products_limit=20;if(data.products_list_type>0){$scope.products_list_chunks=$scope.chunkArray($scope.collection,data.products_list_type+1);$scope.products_limit=10;$scope.products_total=$scope.products_list_chunks.length}
$scope.products_limit_now=$scope.products_limit;console.log("$scope.products_total:"+$scope.products_total);console.log("$scope.products_limit:"+$scope.products_limit);console.log("$scope.products_limit_now:"+$scope.products_limit_now);if(data.collection_category){$scope.collection_category=data.collection_category;$scope.collection_category_is_empty=$scope.collection_category.length>0;if(data.categories_list_type>0)$scope.categories_list_chunks=$scope.chunkArray($scope.collection_category,data.categories_list_type+1)}else{$scope.collection_category=[];$scope.collection_category_is_empty=!0}
if(data.cart_total==null||data.cart_total==0)$scope.cart_total_badge="";else $scope.cart_total_badge=data.cart_total.toString();$window.localStorage.setItem("cart_total_badge",$scope.cart_total_badge);$scope.show_category_info=data.show_category_info;$scope.show_sku=data.show_sku;$scope.use_exit=data.use_exit;$scope.quick_order=data.quick_order;$scope.category_row_type=data.category_row_type;$ionicTabsDelegate.select(3);$window.localStorage.setItem("mmobilcart_use_exit",$scope.use_exit);$scope.show_model=data.show_model;$scope.categories_list_type=data.categories_list_type;$scope.products_list_type=data.products_list_type;$scope.cover=data.cover;$scope.page_title=data.page_title;$scope.special_total_count=data.special_total_count;$scope.is_offline=data.is_offline;$scope.offline_text=data.offline_text;$scope.special_is_hidden=!0}).then(function(){$scope.is_loading=!1;Loader.hide()})};$scope.openCart=function(){if(!$scope.is_loading){$state.go('mmobilcart-cart-view',{value_id:$scope.value_id})}};$scope.closeMobilcart=function(){$state.go('home')};$scope.goHome=function(){if(!$scope.is_loading){$state.go('mmobilcart-category-list',{value_id:$scope.value_id})}};$scope.openHistory=function(){if(!$scope.is_loading){$state.go('mmobilcart-sales-history',{value_id:$scope.value_id})}};$scope.openSpecials=function(){if(!$scope.is_loading){$state.go('mmobilcart-specials',{value_id:$scope.value_id})}};if(!$scope.use_button_header){$scope.right_button={action:$scope.openCart,icon:'ion-ios-cart'}}
$scope.showItem=function(item){$location.path(item.url)};$scope.addToCart=function(item,$event){if(!item.has_option&&item.product_note!=2){console.log("fast add to cart");console.log(item);$scope.is_loading=!0;Loader.show();var postParameters={'product_id':item.product_id,'product_comment':"",'category_id':MmobilcartCategory.category_id,'qty':1,'options':[],'options_multiselect':[],'choices':[],'selected_format':{id:null}};MmobilcartCart.addProduct(postParameters).then(function(data){if(data.success){$scope.is_loading=!1;Loader.hide();Dialog.alert("",$translate.instant("Product successfully added to cart"),$translate.instant("OK"));$scope.$broadcast('MobilcartCartIsUpdated','1');$timeout(function(){$scope.$broadcast('MobilcartCartIsUpdated','1')},3000)}},function(data){Dialog.alert($translate.instant("Error"),data.message,$translate.instant("OK"));$scope.is_loading=!1;Loader.hide()})}else{$location.path(item.url)}
$event.stopPropagation()};$scope.is_tab_special_hidden=function(){return!0};$scope.loadContent();$scope.loadMore=function(infiniteScroll){console.log("load more activated");setTimeout(()=>{if($scope.products_list_type>0){if($scope.products_list_chunks_all.length>0){$scope.load_more=!0;$scope.load_more_button=!0;$scope.products_list_chunks=$scope.products_list_chunks.concat($scope.products_list_chunks_all[0]);$scope.products_list_chunks_all.shift()}}else{if($scope.collection_all.length>0){$scope.load_more=!0;$scope.load_more_button=!0;$scope.collection=$scope.collection.concat($scope.collection_all[0]);$scope.collection_all.shift()}else{$scope.load_more=!1;$scope.load_more_button=!1}}
$scope.$broadcast('scroll.infiniteScrollComplete')},200)}
$scope.loadMoreButton=function(){console.log("load more button activated");$scope.is_more_delay=!0;$timeout(function(){console.log($scope.products_limit_now);$scope.products_limit_now=$scope.products_limit_now+$scope.products_limit;console.log($scope.products_limit_now);$scope.$broadcast('scroll.infiniteScrollComplete');$scope.is_more_delay=!1},500)}}).controller('MMobilcartRedirectController',function($ionicHistory,$scope,$state,$stateParams,HomepageLayout){angular.extend($scope,{value_id:$stateParams.value_id,layout:HomepageLayout});$state.go('home').then(function(){if($scope.layout.properties.options.autoSelectFirst){$ionicHistory.nextViewOptions({historyRoot:!0,disableAnimate:!1})}
$state.go('mmobilcart-category-list',{value_id:$scope.value_id})})}).controller('MMobilcartSpecialsController',function(Loader,$location,$scope,$state,$window,$stateParams,MmobilcartCategory,MmobilcartOffline,Customer,$ionicHistory,$translate,MmobilcartCart,$timeout,$ionicTabsDelegate){console.log("MMobilcartSpecialsController fired!");$scope.is_loading=!0;Loader.show();$scope.factory=MmobilcartCategory;$scope.collection=[];$scope.collection_category=[];$scope.collection_category_is_empty=!0;$scope.collection_is_empty=!0;$scope.is_offline=0;$scope.offline_text="";$scope.show_sku=0;$scope.show_model=0;$scope.show_category_info=1;$scope.categories_list_type=0;$scope.products_list_type=0;$scope.categories_list_chunks=[];$scope.products_list_chunks=[];$scope.special_is_hidden=!0;MmobilcartCart.value_id=$stateParams.value_id;$scope.tab_order_history_name=$translate.instant("Order history");$scope.tab_cart_name=$translate.instant("My Cart");$scope.tab_home_name=$translate.instant("Home");$scope.tab_specials_name=$translate.instant("Specials");$scope.tab_exit=$translate.instant("Exit");$scope.special_total_count=0;$scope.cart_total_badge="";$scope.cart_total_badge_updating=0;$scope.use_exit=0;$scope.quick_order=0;$scope.category_row_type=0;$scope.cart_total_badge_update=function(){if($scope.cart_total_badge_updating==0){console.log("update total cart event");$scope.cart_total_badge_updating=1;MmobilcartCart.getOnlyTotal().then(function(data){if(data.cart_total==null||data.cart_total==0)$scope.cart_total_badge="";else $scope.cart_total_badge=data.cart_total.toString();$window.localStorage.setItem("cart_total_badge",$scope.cart_total_badge)});$scope.cart_total_badge_updating=0}}
$scope.cart_total_badge_update();$timeout(function(){$scope.cart_total_badge_update()},3000);if($window.localStorage.getItem("mmobilcart_use_exit")=="1"){$scope.use_exit=1}
$ionicTabsDelegate.select(2);MmobilcartOffline.value_id=$stateParams.value_id;MmobilcartCategory.value_id=$stateParams.value_id;MmobilcartCategory.category_id=$stateParams.category_id;$scope.value_id=$stateParams.value_id;$scope.use_button_header=!1;if(Customer.isLoggedIn()&&!$stateParams.category_id){$scope.use_button_header=!0}
MmobilcartOffline.findAll().then(function(data){if(data.is_offline==1){console.log('do offline');console.log(data);$ionicHistory.nextViewOptions({disableAnimate:!0});$state.go('offline-mode',{value_id:$scope.value_id})}});$scope.chunkArray=function(myArray,chunk_size){var results=[];while(myArray.length){results.push(myArray.splice(0,chunk_size))}
return results}
console.log('specials load content');$scope.loadContent=function(){MmobilcartCategory.specials().then(function(data){$scope.show_search=data.show_search;$scope.collection=data.collection;$scope.collection=data.collection;$scope.products_total=data.collection.length;$scope.products_limit=20;if(data.products_list_type>0){$scope.products_list_chunks=$scope.chunkArray($scope.collection,data.products_list_type+1);$scope.products_limit=10;$scope.products_total=$scope.products_list_chunks.length}
$scope.products_limit_now=$scope.products_limit;console.log("$scope.products_total:"+$scope.products_total);console.log("$scope.products_limit:"+$scope.products_limit);console.log("$scope.products_limit_now:"+$scope.products_limit_now);if(data.collection_category){$scope.collection_category=data.collection_category;$scope.collection_category_is_empty=$scope.collection_category.length>0;if(data.categories_list_type>0)$scope.categories_list_chunks=$scope.chunkArray($scope.collection_category,data.categories_list_type+1)}else{$scope.collection_category=[];$scope.collection_category_is_empty=!0}
if(data.cart_total==null||data.cart_total==0)$scope.cart_total_badge="";else $scope.cart_total_badge=data.cart_total.toString();$window.localStorage.setItem("cart_total_badge",$scope.cart_total_badge);$scope.show_category_info=data.show_category_info;$scope.show_sku=data.show_sku;$scope.show_model=data.show_model;$scope.use_exit=data.use_exit;$scope.quick_order=data.quick_order;$scope.category_row_type=data.category_row_type;$ionicTabsDelegate.select(2);$window.localStorage.setItem("mmobilcart_use_exit",$scope.use_exit);$scope.categories_list_type=data.categories_list_type;$scope.products_list_type=data.products_list_type;$scope.cover=data.cover;$scope.page_title=$translate.instant("Our Sales");$scope.special_total_count=data.special_total_count;$scope.is_offline=data.is_offline;$scope.offline_text=data.offline_text}).then(function(){$scope.is_loading=!1;Loader.hide()})};$scope.loadContent();$scope.is_tab_special_hidden=function(){return!0};$scope.openCart=function(){if(!$scope.is_loading){$state.go('mmobilcart-cart-view',{value_id:$scope.value_id})}};$scope.goHome=function(){if(!$scope.is_loading){$state.go('mmobilcart-category-list',{value_id:$scope.value_id})}};$scope.closeMobilcart=function(){$state.go('home')};$scope.openHistory=function(){if(!$scope.is_loading){$state.go('mmobilcart-sales-history',{value_id:$scope.value_id})}};$scope.openSpecials=function(){if(!$scope.is_loading){$state.go('mmobilcart-specials',{value_id:$scope.value_id})}};$scope.showItem=function(item){$location.path(item.url)};$scope.addToCart=function(item,$event){if(!item.has_option&&item.product_note!=2){console.log("fast add to cart");console.log(item);$scope.is_loading=!0;Loader.show();var postParameters={'product_id':item.product_id,'product_comment':"",'category_id':MmobilcartCategory.category_id,'qty':1,'options':[],'options_multiselect':[],'choices':[],'selected_format':{id:null}};MmobilcartCart.addProduct(postParameters).then(function(data){if(data.success){$scope.is_loading=!1;Loader.hide();Dialog.alert("",$translate.instant("Product successfully added to cart"),$translate.instant("OK"));$scope.$broadcast('MobilcartCartIsUpdated','1');$timeout(function(){$scope.$broadcast('MobilcartCartIsUpdated','1')},3000)}},function(data){Dialog.alert($translate.instant("Error"),data.message,$translate.instant("OK"));$scope.is_loading=!1;Loader.hide()})}else{$location.path(item.url)}
$event.stopPropagation()};if(!$scope.use_button_header){$scope.right_button={action:$scope.openCart,icon:'ion-ios-cart'}}});angular.module("starter").controller("MMobilcartProductViewController",function($cordovaSocialSharing,Loader,$log,$state,$stateParams,$scope,$translate,Analytics,$ionicHistory,Application,Dialog,MmobilcartCategory,MmobilcartCart,MmobilcartProduct,$rootScope,$timeout,$window,$ionicTabsDelegate){MmobilcartProduct.value_id=$stateParams.value_id;MmobilcartCart.value_id=$stateParams.value_id;$scope.value_id=$stateParams.value_id;$scope.product_id=$stateParams.product_id;$scope.cart_total=0;$scope.product_note=0;$scope.show_cart=0;$scope.product_comment="";$scope.social_sharing_active=!1;$scope.product_quantity=1;$scope.selected_format={id:null};$scope.list_qty=[1,2,3,4,5,6,7,8,9,10];$scope.choices_qty=[];MmobilcartCart.value_id=$stateParams.value_id;$scope.cart_total_badge="";$scope.cart_total_badge_updating=0;$scope.cart_total_badge_update=function(){if($scope.cart_total_badge_updating==0){console.log("update total cart event");$scope.cart_total_badge_updating=1;MmobilcartCart.getOnlyTotal().then(function(data){if(data.cart_total==null||data.cart_total==0)$scope.cart_total_badge="";else $scope.cart_total_badge=data.cart_total.toString();$window.localStorage.setItem("cart_total_badge",$scope.cart_total_badge)});$scope.cart_total_badge_updating=0}}
$scope.cart_total_badge_update();$timeout(function(){$scope.cart_total_badge_update()},3000);$scope.loadContent=function(){$scope.is_loading=!0;Loader.show();MmobilcartProduct.find($scope.product_id).then(function(data){$scope.product=data.product;$scope.product.product_note=data.product.product_note;$scope.cart_total=data.cart_total;$scope.special_total_count=data.special_total_count;$scope.use_exit=data.use_exit;$scope.show_cart=data.show_cart;$ionicTabsDelegate.select(3);$window.localStorage.setItem("mmobilcart_use_exit",$scope.use_exit);Analytics.storeProductOpening($scope.product);$scope.social_sharing_active=($scope.product.social_sharing_active&&$rootScope.isNativeApp);$scope.share=function(){if($scope.is_sharing){return}
$scope.is_sharing=!0;var app_name=Application.app_name;var link=DOMAIN+"/application/device/downloadapp/app_id/"+Application.app_id;var subject="";var file=($scope.product.picture[0]&&$scope.product.picture[0].url)?$scope.product.picture[0].url:"";var content=$scope.product.name;var message=$translate.instant("Hi. I just found: $1 in the $2 app.").replace("$1",content).replace("$2",app_name);$cordovaSocialSharing.share(message,subject,file,link).then(function(result){$log.debug("MMobilcart::product.js","social sharing success");$scope.is_sharing=!1},function(err){$log.debug("MMobilcart::product.js",err);$scope.is_sharing=!1})};if($scope.product.formatGroups.length>0){$scope.selected_format.id=$scope.product.formatGroups[0].id}
$scope.page_title=data.page_title}).then(function(){$scope.is_loading=!1;Loader.hide()})};$scope.openSpecials=function(){if(!$scope.is_loading){$state.go('mmobilcart-specials',{value_id:$scope.value_id})}};$scope.closeMobilcart=function(){$state.go('home')};$scope.addProduct=function(){$scope.is_loading=!0;Loader.show();var errors=[];var postParameters={'product_id':$scope.product_id,'product_comment':$scope.product.product_comment,'category_id':MmobilcartCategory.category_id,'qty':$scope.product_quantity,'options':null,'options_multiselect':null,'choices':$scope.product.choicesGroups.reduce(function(choices,choicesGroup){var selected=[];var selected_qty=[];choicesGroup.options.forEach(function(e,i){if(e.selected){selected.push(e.id)}});if(choicesGroup.required&&!selected.length){errors.push($translate.instant("Option $1 is required.").replace("$1",choicesGroup.title))}
choices[choicesGroup.id]={'selected_options':selected};return choices},{}),'selected_format':$scope.selected_format.id};var new_options=[];$scope.product.optionsGroups.forEach(function(optionsGroup){if(optionsGroup.multiselect==0){if(optionsGroup.required&&!optionsGroup.selectedOptionId){errors.push($translate.instant("Option $1 is required.").replace("$1",optionsGroup.title))}
if(optionsGroup.selectedQuantity<=0||!optionsGroup.selectedQuantity){errors.push($translate.instant("Quantity for option $1 is required.").replace("$1",optionsGroup.title))}
new_options[""+optionsGroup.id]={'option_id':optionsGroup.selectedOptionId,'qty':optionsGroup.selectedQuantity}}});postParameters.options=new_options;var new_options1=[];$scope.product.optionsGroups.forEach(function(optionsGroup){if(optionsGroup.multiselect==1){optionsGroup.options.forEach(function(option){if(option.selected){new_options1.push({'group_id':optionsGroup.id,'option_id':option.optionId,'qty':option.selectedQuantity})}})}});postParameters.options_multiselect=new_options1;if($scope.product.product_note==2&&$scope.product.product_comment==null){console.log($scope.product.product_comment);errors.push($translate.instant("Comment is required."))}
if(errors.length<=0){MmobilcartCart.addProduct(postParameters).then(function(data){if(data.success){$scope.is_loading=!1;Loader.hide();if($scope.show_cart)$scope.openCart();else{Dialog.alert("",$translate.instant("Product successfully added to cart"),$translate.instant("OK")).then(function(){$ionicHistory.goBack()})}}},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert("",data.message,$translate.instant("OK"))}
$scope.is_loading=!1;$scope.product_quantity=1;$scope.selected_format={id:null};$scope.product.optionsGroups.forEach(function(option){option.selectedOptionId=null;option.selectedQuantity=1});$scope.product.choicesGroups.forEach(function(choice){choice.options.forEach(function(option){option.selected=!1})});Loader.hide()})}else{var message=errors.join("<br/>");Dialog.alert("",message,"OK");$scope.is_loading=!1;Loader.hide()}};$scope.openCart=function(){if(!$scope.is_loading){$state.go("mmobilcart-cart-view",{value_id:$scope.value_id})}};$scope.changeQuantity=function(qty){if(qty){$scope.product_quantity=qty}};$scope.changeOptionsGroupQuantity=function(optionsGroup,qty){if(qty){console.log(optionsGroup);console.log(qty);optionsGroup.selectedQuantity=qty}}
$scope.changeChoicesGroupQuantity=function(i,j,qty){if(qty){$scope.product.optionsGroups[i].options[j].selectedQuantity=qty}}
$scope.goHome=function(){if(!$scope.is_loading){$state.go('mmobilcart-category-list',{value_id:$scope.value_id})}};$scope.openHistory=function(){if(!$scope.is_loading){$state.go('mmobilcart-sales-history',{value_id:$scope.value_id})}};$scope.right_button={action:$scope.openCart,icon:"ion-ios-cart"};$scope.loadContent()});angular.module('starter').controller('MMobilcartOfflineController',function(Loader,$location,$scope,$state,MmobilcartOffline,$rootScope,$stateParams){$scope.is_loading=!0;$scope.offline_text=$stateParams.offline_text;Loader.show();console.log("Show offline mode");console.log($scope);console.log($stateParams);$scope.goHome=function(){$state.go('home')};$scope.loadContent=function(){MmobilcartOffline.findAll().then(function(data){console.log("Recived text:");console.log(data);$scope.offline_text=data.offline_text;$scope.myHTML=data.offline_text}).then(function(){$scope.is_loading=!1;Loader.hide()})};$scope.loadContent()});angular.module('starter').controller('MMobilcartSalesConfirmationViewController',function($ionicPopup,Loader,$location,$rootScope,$session,$scope,$state,$stateParams,$timeout,$ionicModal,$translate,$window,Analytics,Application,Customer,Dialog,Modal,MmobilcartCart,MmobilcartSalesPayment,$ionicTabsDelegate,$http){angular.extend($scope,{is_loading:!0,page_title:$translate.instant('Review'),value_id:$stateParams.value_id});$scope.stripe_card=null;$scope.stripe_script=null;$scope.stripe_script_src=null;$scope.stripe_total=null;$scope.iyzipay_token=null;Loader.show();MmobilcartCart.value_id=$stateParams.value_id;MmobilcartSalesPayment.value_id=$stateParams.value_id;console.log($session);MmobilcartCart.value_id=$stateParams.value_id;$scope.special_total_count=0;$scope.comment_required=0;$scope.cart_total_badge="";$scope.cart_total_badge_updating=0;$scope.cart_total_badge_update=function(){if($scope.cart_total_badge_updating==0){console.log("update total cart event");$scope.cart_total_badge_updating=1;MmobilcartCart.getOnlyTotal().then(function(data){if(data.cart_total==null||data.cart_total==0)$scope.cart_total_badge="";else $scope.cart_total_badge=data.cart_total.toString();$window.localStorage.setItem("cart_total_badge",$scope.cart_total_badge)});$scope.cart_total_badge_updating=0}}
$scope.cart_total_badge_update();$timeout(function(){$scope.cart_total_badge_update()},3000);$scope.goHome=function(){if(!$scope.is_loading){$state.go('mmobilcart-category-list',{value_id:$scope.value_id})}};$scope.closeMobilcart=function(){$state.go('home')};$scope.openHistory=function(){if(!$scope.is_loading){$state.go('mmobilcart-sales-history',{value_id:$scope.value_id})}};$scope.openSpecials=function(){if(!$scope.is_loading){$state.go('mmobilcart-specials',{value_id:$scope.value_id})}};$scope.openCart=function(){if(!$scope.is_loading){$state.go("mmobilcart-cart-view",{value_id:$scope.value_id})}};$scope.stripe_modal=null;$scope.iyzico_modal=null;$scope.yandex_modal=null;$scope.yandex_token="";$scope.cloudpayments_modal=null;$scope.cloudpayments_script=null;$scope.stripe_script=null;$scope.cloudpayments_widget=null;$scope.stripe_widget=null;$scope.loadContent=function(){$scope.guest_mode=Customer.guest_mode;MmobilcartCart.compute().then(function(computation){MmobilcartCart.find().then(function(data){$scope.cart=data.cart;$scope.cart.discount_message=computation.message;$scope.cart.discount=computation.discount;$scope.special_total_count=data.special_total_count;$scope.use_exit=data.cart.use_exit;$scope.comment_required=data.cart.comment_required;console.log(data);MmobilcartSalesPayment.findOnlinePaymentUrl().then(function(onlinePaymentData){$scope.payment_code='';$scope.onlinePaymentUrl=onlinePaymentData.url;$scope.form_url=onlinePaymentData.form_url;if(typeof onlinePaymentData.code!='undefined'&&onlinePaymentData.code){$scope.payment_code=onlinePaymentData.code}
console.log("Confirm load content:");console.log(onlinePaymentData);$scope.right_button={action:$scope.validate,label:$translate.instant('Proceed')}}).then(function(){Loader.hide();if(computation&&angular.isDefined(computation.message)&&computation.show_message){Dialog.alert('',computation.message,'OK')}
$scope.is_loading=!1})},function(){$scope.is_loading=!1;Loader.hide()})},function(){Loader.hide();$scope.is_loading=!1})};$scope.validate=function(){console.log("Validate.");console.log($scope.comment_required);console.log($scope.notes);if($scope.comment_required=="1"&&($scope.notes==""||$scope.notes==null)){Dialog.alert('',$translate.instant('Note is required!'),'OK');return!1}
MmobilcartSalesPayment.notes=$scope.notes||'';sessionStorage.setItem('mmobilcart-notes',$scope.notes||'');if($scope.onlinePaymentUrl){if(!isNativeApp){$window.location=$scope.onlinePaymentUrl}else{var browser=$window.open($scope.onlinePaymentUrl,$rootScope.getTargetForLink(),'location=yes');var nextState='mmobilcart-sales-error';var stepNext=function(){browser.close();$state.go(nextState,{value_id:$stateParams.value_id})};browser.addEventListener('loadstart',function(event){switch(!0){case/(mmobilcart\/mobile_sales_success)/.test(event.url):nextState='mmobilcart-sales-success';stepNext();break;case/(mmobilcart\/mobile_sales_cancel)/.test(event.url):nextState='mmobilcart-sales-confirmation-cancel';stepNext();break;case/(mmobilcart\/mobile_sales_error)/.test(event.url):nextState='mmobilcart-sales-error';stepNext();break}})}}else if($scope.form_url){$location.path($scope.form_url)}else if($scope.payment_code=='cloudpayments'){Loader.show();$scope.is_loading=!0;console.log('try get payments data');MmobilcartSalesPayment.getCloudPaymentsData().then(function(onlinePaymentData){console.log(onlinePaymentData);$scope.cloudpayments_script=null;if(!$scope.cloudpayments_script){console.log('Try to load cloudpayments script (if not loaded)');$scope.is_loading=!0;$scope.cloudpayments_script=document.createElement("script");$scope.cloudpayments_script.type="text/javascript";$scope.cloudpayments_script.src="https://widget.cloudpayments.ru/bundles/cloudpayments";$scope.cloudpayments_script.onload=function(){console.log('Cloudpayments script load.');if($scope.cloudpayments_widget!=null)$scope.cloudpayments_widget=null;$scope.cloudpayments_widget=new cp.CloudPayments();$scope.cloudpayments_widget.charge({publicId:onlinePaymentData.pub_key,description:onlinePaymentData.comment,amount:onlinePaymentData.total,currency:onlinePaymentData.currency_code,invoiceId:onlinePaymentData.last_order,accountId:$session.getDeviceUid(),data:{firstName:onlinePaymentData.firstName,lastName:onlinePaymentData.lastName,email:onlinePaymentData.email,phone:onlinePaymentData.phone,comment:onlinePaymentData.last_order,birthDate:onlinePaymentData.birthDate,}},function(options){console.log('CloudPayments succesful');$scope.AddToAnalitic();$window.location=onlinePaymentData.returnUrl},function(reason,options){console.log('CloudPayments pay error');$state.go('mmobilcart-sales-confirmation',{value_id:$stateParams.value_id})});$scope.is_loading=!1;Loader.hide()};document.body.appendChild($scope.cloudpayments_script)}}).then(function(){})}else if($scope.payment_code=='stripe'){Loader.show();$scope.is_loading=!0;console.log('try get stripe data');MmobilcartSalesPayment.getStripePaymentsData().then(function(onlinePaymentData){console.log("Recived data:");console.log(onlinePaymentData);$scope.stripe_script_src=null;$scope.stripe_published_key=onlinePaymentData.publishable_key;$scope.stripe_total=onlinePaymentData.total;console.log('Try to load stripe checkout script');if(!$scope.stripe_script_src){$scope.stripe_script_src=document.createElement('script');$scope.stripe_script_src.type="text/javascript";$scope.stripe_script_src.src="https://js.stripe.com/v3/";$scope.stripe_script_src.onload=function(){console.log('Stripe script load.');if($scope.stripe_widget!=null)$scope.stripe_widget=null;console.log('Show stripe modal.');$scope.openStripeModal(onlinePaymentData)};document.body.appendChild($scope.stripe_script_src)}}).then(function(){});Loader.hide()}else if($scope.payment_code=='yandex'){console.log('try get yandex data');$scope.loadyandexdata()}else if($scope.payment_code=='iyzico'){console.log('try get iyzico data');console.log('run $scope.loadiyzicodata()');$scope.loadiyzicodata()}else{if($scope.is_loading){return}
$scope.is_loading=!0;Loader.show();MmobilcartSalesPayment.validatePayment().then(function(data){var products=[];angular.forEach($scope.cart.lines,function(value,key){var product=value.product;product.category_id=value.category_id;product.quantity=value.qty;products.push(product)});Analytics.storeProductSold(products);$state.go('mmobilcart-sales-success',{value_id:$stateParams.value_id})},function(data){Dialog.alert('',data.message,'OK')}).then(function(){$scope.is_loading=!1;Loader.hide()})}};$scope.AddToAnalitic=function(){var products=[];angular.forEach($scope.cart.lines,function(value,key){var product=value.product;product.category_id=value.category_id;product.quantity=value.qty;products.push(product)});Analytics.storeProductSold(products)};$scope.openStripeModal=function(data){if($scope.stripe_modal==null){Modal.fromTemplateUrl('features/m_mobilcart/assets/templates/l1/sales/payment-modals/stripe-payment.html',{scope:$scope}).then(function(modal){$scope.stripe_modal=modal;console.log("stripe modal data:");console.log($scope);$scope.stripe_modal.show();console.log("$scope.stripe_script:");console.log($scope.stripe_script);$scope.stripe_script=null;if($scope.stripe_script==null){console.log("$scope.stripe_script created");$scope.stripe_script=Stripe($scope.stripe_published_key);var elements=$scope.stripe_script.elements();$scope.stripe_card=elements.create('card');$scope.stripe_card.mount('#stripe-card-element')}
$scope.is_loading=!1;Loader.hide()})}else{$scope.stripe_modal.show();$scope.is_loading=!1;Loader.hide()}};$scope.closeStripeModal=function(){$scope.stripe_modal.hide()};$scope.closeIyzicoModal=function(){$scope.iyzico_modal.hide()};$scope.closeYandexModal=function(){$scope.yandex_modal.hide()};$scope.make_stripe_pay=function(data){console.log($scope.stripe_script);$scope.is_loading=!0;Loader.show();$scope.stripe_script.createSource($scope.stripe_card).then(function(result){if(result.error){console.log('Stripe script error:');console.log(result);var errorElement=document.getElementById('card-errors');errorElement.textContent=result.error.message;$scope.is_loading=!1;Loader.hide()}else{console.log('Stripe script success:');console.log(result);console.log("Post parameters to MmobilcartSalesPayment.makeStripePayment:");MmobilcartSalesPayment.makeStripePayment(result).then(function(data){console.log("Sending data to Stripe");console.log(data);if(data.success){$scope.AddToAnalitic();$window.location=data.returnUrl}else if(data['3ds']){console.log("going to 3dsec url");$window.location=data['3ds_url']}else if(data.error){var errorElement=document.getElementById('card-errors');errorElement.textContent=data.message}
$scope.is_loading=!1;Loader.hide()}).catch(function(data){var errorElement=document.getElementById('card-errors');errorElement.textContent=data.message;$scope.is_loading=!1;Loader.hide()})}})};$scope.loadiyzicodata=function(){console.log("Request iyzico data");$scope.is_loading=!0;Loader.show();MmobilcartSalesPayment.getIyzicoPaymentsData().then(function(onlinePaymentData){console.log("Recived iyzico data:");console.log(onlinePaymentData);if(onlinePaymentData.error){Dialog.alert('ERROR',onlinePaymentData.message,'OK')}else if(onlinePaymentData.success){$scope.is_loading=!0;Loader.show();$window.location=onlinePaymentData.url;$scope.is_loading=!1;Loader.hide()}}).then(function(){})}
$scope.load2iframe=function(){$scope.yandex_modal.show();var ifrboxdiv=document.getElementById('ifrboxdiv');var ifrbox=document.getElementById('ifrbox');ifrbox.src="features/m_mobilcart/assets/templates/l1/sales/payment-modals/iframe-box.html";ifrbox.onload=function(){ifrbox.contentWindow.runKassa($scope.yandex_token,$scope.return_url);ifrboxdiv.style.display="block"}}
$scope.loadyandexdata=function(){console.log("Request yandex data");$scope.is_loading=!0;Loader.show();MmobilcartSalesPayment.getYandexPaymentsData().then(function(onlinePaymentData){console.log("Recived yandex data:");console.log(onlinePaymentData);if(onlinePaymentData.error){$scope.is_loading=!1;Loader.hide();Dialog.alert('ERROR',onlinePaymentData.message,'OK')}else{$scope.yandex_token=onlinePaymentData.token;$scope.return_url=onlinePaymentData.return_url;if($scope.yandex_modal==null){Modal.fromTemplateUrl('features/m_mobilcart/assets/templates/l1/sales/payment-modals/yandex-payment.html',{scope:$scope}).then(function(modal){$scope.yandex_modal=modal;console.log("yandex open iframe");$scope.load2iframe(onlinePaymentData.data.confirmation.confirmation_url)})}else{$scope.load2iframe(onlinePaymentData.data.confirmation.confirmation_url)}
$timeout(YandexPaymentCheckTimer,4000);$scope.is_loading=!1;Loader.hide()}}).then(function(){})}
var YandexPaymentCheckTimer=function(){console.log('YandexPaymentCheckTimer:');MmobilcartSalesPayment.checkYandexPaymentsData().then(function(yandexData){console.log('YandexPaymentCheckTimer1:');console.log(yandexData);if(yandexData.status=="succeeded"){}else{}
$window.location=yandexData.return_url}).catch(function(error){console.log("YandexPaymentCheckTimer return error");console.log(error)});$timeout(YandexPaymentCheckTimer,2000)}
$scope.loadContent()});angular.module('starter').controller('MMobilcartSalesConfirmationCancelController',function($state,$stateParams,$translate,Dialog){Dialog.alert('','The payment has been cancelled, something wrong happened? Feel free to contact us.','OK').then(function(){$state.go('mmobilcart-sales-confirmation',{value_id:$stateParams.value_id})})});angular.module('starter').controller('MMobilcartSalesCustomerViewController',function(Loader,$state,$stateParams,$scope,$translate,$rootScope,MmobilcartCart,$log,MmobilcartSalesCustomer,Customer,Dialog,SB,$timeout,$window,$ionicTabsDelegate){$scope.hasguestmode=!1;$scope.shoudShowPaymentAddress=($window.APP_KEY!='5d94ad0485c1b')||MmobilcartCart.shoudShowPaymentAddress();$scope.shoudShowDeleveryAddress=($window.APP_KEY!='5d94ad0485c1b')||MmobilcartCart.shoudShowDeleveryAddress();MmobilcartCart.value_id=$stateParams.value_id;$scope.special_total_count=0;$scope.cart_total_badge="";$scope.cart_total_badge_updating=0;$scope.cart_total_badge_update=function(){if($scope.cart_total_badge_updating==0){console.log("update total cart event");$scope.cart_total_badge_updating=1;MmobilcartCart.getOnlyTotal().then(function(data){if(data.cart_total==null||data.cart_total==0)$scope.cart_total_badge="";else $scope.cart_total_badge=data.cart_total.toString();$window.localStorage.setItem("cart_total_badge",$scope.cart_total_badge)});$scope.cart_total_badge_updating=0}}
$scope.cart_total_badge_update();$timeout(function(){$scope.cart_total_badge_update()},3000);$scope.customer_login=function(){Customer.display_account_form=!1;Customer.loginModal($scope)};$scope.customer_signup=function(){Customer.display_account_form=!0;Customer.loginModal($scope)};$scope.closeMobilcart=function(){$state.go('home')};$scope.customer_guestmode=function(){Loader.show();var currentTs=Date.now();var guestmail='guest'+currentTs+(parseInt(Math.random()*1000,10))+'@guest.com';Customer.register({civility:'m',firstname:'Guest',lastname:'Guest',email:guestmail,password:parseInt(Math.random()*10000000000,10),privacy_policy:!0}).then(function(){$scope.is_logged_in=!0;Customer.guest_mode=!0;$scope.loadContent()}).then(function(){$scope.is_loading=!1;Loader.hide()})};$scope.$on(SB.EVENTS.AUTH.loginSuccess,function(){$scope.is_logged_in=!0;$scope.loadContent()});$scope.$on(SB.EVENTS.AUTH.logoutSuccess,function(){$scope.is_logged_in=!1});$scope.is_loading=!0;Loader.show();$scope.is_logged_in=Customer.isLoggedIn();MmobilcartCart.value_id=$stateParams.value_id;MmobilcartSalesCustomer.value_id=$stateParams.value_id;$scope.value_id=$stateParams.value_id;$scope.page_title=$translate.instant('My information');$scope.loadContent=function(){console.log("Load content");MmobilcartSalesCustomer.hasGuestMode().then(function(dataGuestMode){if(dataGuestMode.success&&dataGuestMode.activated){$scope.hasguestmode=!0}
MmobilcartSalesCustomer.find().then(function(data){$scope.special_total_count=data.special_total_count;$scope.customer=data.customer;console.log("Customer found");console.log(data);console.log(data.customer);console.log(MmobilcartSalesCustomer);if($scope.customer&&$scope.customer.hasOwnProperty('metadatas')&&$scope.customer.metadatas.birthday){console.log("birthday fix");$scope.customer.metadatas.birthday=new Date($scope.customer.metadatas.birthday)}
$scope.settings=data.settings}).then(function(){$scope.is_loading=!1;Loader.hide()})},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert('Error',data.message,'OK')}}).then(function(){$scope.is_loading=!1;Loader.hide()})};$scope.goToConfirmationPage=function(){$state.go('mmobilcart-sales-confirmation',{value_id:$stateParams.value_id})};$scope.updateCustomerInfos=function(){$rootScope.loginFeature=!0;$rootScope.loginFeatureBack=!1;$scope.is_loading=!0;Loader.show();console.log("Try to update customer");console.log($scope.customer);console.log($scope);$scope.customer.metadatas.shoudShowPaymentAddress=$scope.shoudShowPaymentAddress;$scope.customer.metadatas.shoudShowDeleveryAddress=$scope.shoudShowDeleveryAddress;MmobilcartSalesCustomer.updateCustomerInfos({customer:$scope.customer}).then(function(data){$scope.customer=data.customer;console.log("Customer update");console.log(data);console.log(data.customer);console.log(MmobilcartSalesCustomer);Customer.save($scope.customer).then(function(data){if(angular.isDefined(data.message)){}
$scope.goToConfirmationPage()},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert('Error',data.message,'OK')}}).then(function(){$scope.is_loading=!1;Loader.hide()})},function(data){$scope.is_loading=!1;Loader.hide();if(data&&angular.isDefined(data.message)){Dialog.alert('Error',data.message,'OK')}})};$scope.right_button={action:$scope.updateCustomerInfos,label:$translate.instant('Next')};$scope.loadContent();$scope.goHome=function(){if(!$scope.is_loading){$state.go('mmobilcart-category-list',{value_id:$scope.value_id})}};$scope.openSpecials=function(){if(!$scope.is_loading){$state.go('mmobilcart-specials',{value_id:$scope.value_id})}};$scope.closeMobilcart=function(){$state.go('home')};$scope.openHistory=function(){if(!$scope.is_loading){$state.go('mmobilcart-sales-history',{value_id:$scope.value_id})}};$scope.openCart=function(){if(!$scope.is_loading){$state.go("mmobilcart-cart-view",{value_id:$scope.value_id})}}});angular.module("starter").controller("MMobilcartSalesDeliveryViewController",function(Loader,$scope,$stateParams,$state,$timeout,$window,$translate,MmobilcartCart,MmobilcartSalesDelivery,Dialog,$ionicTabsDelegate){$scope.page_title=$translate.instant("Delivery");MmobilcartCart.value_id=$stateParams.value_id;MmobilcartSalesDelivery.value_id=$stateParams.value_id;$scope.value_id=$stateParams.value_id;$scope.clients_calculate_change_form_is_visible=!1;MmobilcartCart.value_id=$stateParams.value_id;$scope.special_total_count=0;$scope.cart_total_badge="";$scope.cart_total_badge_updating=0;$scope.cart_total_badge_update=function(){if($scope.cart_total_badge_updating==0){console.log("update total cart event");$scope.cart_total_badge_updating=1;MmobilcartCart.getOnlyTotal().then(function(data){if(data.cart_total==null||data.cart_total==0)$scope.cart_total_badge="";else $scope.cart_total_badge=data.cart_total.toString();$window.localStorage.setItem("cart_total_badge",$scope.cart_total_badge)});$scope.cart_total_badge_updating=0}}
$scope.cart_total_badge_update();$timeout(function(){$scope.cart_total_badge_update()},3000);$scope.closeMobilcart=function(){$state.go('home')};$scope.loadContent=function(){$scope.is_loading=!0;Loader.show();MmobilcartCart.find().then(function(data){$scope.cart=data.cart;$scope.cart.delivery_method_extra_client_amount=$scope.cart.paid_amount?parseFloat($scope.cart.paid_amount):$scope.cart.total;$scope.cart.delivery_method_extra_amount_due=($scope.cart.delivery_amount_due)?parseFloat($scope.cart.delivery_amount_due):0;$scope.calculateAmountDue();$scope.special_total_count=data.special_total_count;MmobilcartSalesDelivery.findStore().then(function(data){$scope.clients_calculate_change_form_is_visible=data.clients_calculate_change;$scope.selectedStore=data.store}).then(function(){$scope.is_loading=!1;Loader.hide()})},function(){$scope.is_loading=!1;Loader.hide()})};$scope.selectDeliveryMethod=function(cart,delivery_method){var tmp_total_with_fees=cart.base_total_without_fees+delivery_method.price;cart.total=parseFloat(tmp_total_with_fees!=cart.total&&!cart.deliveryCost?tmp_total_with_fees:cart.total);cart.delivery_method_extra_client_amount=cart.total;cart.deliveryMethodId=delivery_method.id;$scope.clients_calculate_change_form_is_visible=((delivery_method.code=="home_delivery")&&$scope.selectedStore.clients_calculate_change);$scope.cart.delivery_method_extra_amount_due=0};$scope.calculateAmountDue=function(){var price=parseFloat($scope.cart.delivery_method_extra_client_amount);if(isNaN(price)||price<$scope.cart.total){if(isNaN(price)){$scope.cart.delivery_method_extra_client_amount=""}
$scope.cart.delivery_method_extra_amount_due=null;return}
$scope.cart.delivery_method_extra_amount_due=(price-$scope.cart.total).toFixed(2);$scope.cart.total=$scope.cart.total};$scope.updateDeliveryInfos=function(){if($scope.cart.delivery_method_extra_amount_due==null){Dialog.alert("","Remaining due is incorrect.","OK").then(function(){return})}
if(!$scope.cart.deliveryMethodId){Dialog.alert("","You have to choose a delivery method.","OK").then(function(){return})}
if(!$scope.is_loading){$scope.is_loading=!0;Loader.show();MmobilcartCart.setDeleveryMethodId($scope.cart.deliveryMethodId);var postParameters={'delivery_method_id':$scope.cart.deliveryMethodId,'paid_amount':$scope.clients_calculate_change_form_is_visible?$scope.cart.delivery_method_extra_client_amount:null,'store_id':$scope.selectedStore.id};MmobilcartSalesDelivery.updateDeliveryInfos(postParameters).then(function(data){$scope.goToPaymentPage()},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert("",data.message,"OK")}}).then(function(){$scope.is_loading=!1;Loader.hide()})}};$scope.goToPaymentPage=function(){$state.go("mmobilcart-sales-payment",{value_id:$stateParams.value_id})};$scope.goHome=function(){if(!$scope.is_loading){$state.go('mmobilcart-category-list',{value_id:$scope.value_id})}};$scope.openSpecials=function(){if(!$scope.is_loading){$state.go('mmobilcart-specials',{value_id:$scope.value_id})}};$scope.openHistory=function(){if(!$scope.is_loading){$state.go('mmobilcart-sales-history',{value_id:$scope.value_id})}};$scope.openCart=function(){if(!$scope.is_loading){$state.go("mmobilcart-cart-view",{value_id:$scope.value_id})}};$scope.right_button={action:$scope.updateDeliveryInfos,label:$translate.instant("Next")};$scope.loadContent()});angular.module('starter').controller('MMobilcartSalesErrorViewController',function($scope,$state,$stateParams,$timeout){$scope.value_id=$stateParams.value_id;$timeout(function(){$state.go('mmobilcart-redirect',{value_id:$scope.value_id})},4000)});angular.module("starter").controller("MMobilcartSalesHistoryViewController",function(Loader,$scope,$state,$stateParams,$translate,MmobilcartSalesCustomer,$timeout,$window,MmobilcartCart,$ionicTabsDelegate){$scope.value_id=$stateParams.value_id;$scope.page_title=$translate.instant("Order history");$scope.showLoader=function(){Loader.show()};$scope.orders=[];$scope.offset=0;$scope.can_load_older_posts=!0;MmobilcartCart.value_id=$stateParams.value_id;$scope.cart_total_badge="";$scope.cart_total_badge_updating=0;$scope.special_total_count=0;$scope.cart_total_badge_update=function(){if($scope.cart_total_badge_updating==0){console.log("update total cart event");$scope.cart_total_badge_updating=1;MmobilcartCart.getOnlyTotal().then(function(data){if(data.cart_total==null||data.cart_total==0)$scope.cart_total_badge="";else $scope.cart_total_badge=data.cart_total.toString();$window.localStorage.setItem("cart_total_badge",$scope.cart_total_badge)});$scope.cart_total_badge_updating=0}}
$scope.cart_total_badge_update();$timeout(function(){$scope.cart_total_badge_update()},3000);$scope.use_exit=0;if($window.localStorage.getItem("mmobilcart_use_exit")=="1"){$scope.use_exit=1}
$scope.goHome=function(){if(!$scope.is_loading){$state.go('mmobilcart-category-list',{value_id:$scope.value_id})}};$scope.openHistory=function(){if(!$scope.is_loading){$state.go('mmobilcart-sales-history',{value_id:$scope.value_id})}};$scope.openSpecials=function(){if(!$scope.is_loading){$state.go('mmobilcart-specials',{value_id:$scope.value_id})}};$scope.openCart=function(){if(!$scope.is_loading){$state.go("mmobilcart-cart-view",{value_id:$scope.value_id})}};$scope.special_total_count=0;MmobilcartSalesCustomer.value_id=$stateParams.value_id;$scope.loadContent=function(){$scope.showLoader();MmobilcartSalesCustomer.getOrderHistory($scope.offset).then(function(data){if(data.orders){$scope.orders=$scope.orders.concat(data.orders);$scope.offset+=data.orders.length;$scope.use_exit=data.use_exit;$scope.special_total_count=data.special_total_count;if(data.orders.length<=0){$scope.can_load_older_posts=!1}
return!0}else{$scope.orders=[];return!1}}).then(function(refresh){if(refresh){$scope.$broadcast('scroll.infiniteScrollComplete')}
Loader.hide()})};$scope.loadContent();$scope.showDetails=function(order_id){$state.go("mmobilcart-sales-history-details",{value_id:$scope.value_id,order_id:order_id})};$scope.loadMore=function(){$scope.loadContent()};$scope.closeMobilcart=function(){$state.go('home')}}).controller("MMobilcartSalesHistoryDetailsController",function(Loader,$scope,$state,$stateParams,$timeout,$window,MmobilcartCart,Dialog,$translate,MmobilcartSalesCustomer,$ionicTabsDelegate){$scope.value_id=$stateParams.value_id;$scope.page_title=$translate.instant("Order details");$scope.order_id=$stateParams.order_id;Loader.show();MmobilcartCart.value_id=$stateParams.value_id;$scope.cart_total_badge="";$scope.cart_total_badge_updating=0;$scope.special_total_count=0;$scope.cart_total_badge_update=function(){if($scope.cart_total_badge_updating==0){console.log("update total cart event");$scope.cart_total_badge_updating=1;MmobilcartCart.getOnlyTotal().then(function(data){if(data.cart_total==null||data.cart_total==0)$scope.cart_total_badge="";else $scope.cart_total_badge=data.cart_total.toString();$window.localStorage.setItem("cart_total_badge",$scope.cart_total_badge)});$scope.cart_total_badge_updating=0}}
$scope.cart_total_badge_update();$timeout(function(){$scope.cart_total_badge_update()},3000);$scope.use_exit=0;if($window.localStorage.getItem("mmobilcart_use_exit")=="1"){$scope.use_exit=1}
$scope.goHome=function(){if(!$scope.is_loading){$state.go('mmobilcart-category-list',{value_id:$scope.value_id})}};$scope.openHistory=function(){if(!$scope.is_loading){$state.go('mmobilcart-sales-history',{value_id:$scope.value_id})}};$scope.closeMobilcart=function(){$state.go('home')};$scope.addOrderToCart=function(){Loader.show();console.log("Reaorder id:");console.log($scope.order_id);MmobilcartSalesCustomer.reOrder($scope.order_id).then(function(data){console.log("reorder return:");console.log(data);$scope.cart_total_badge_update();Dialog.alert("",$translate.instant("Items add to Cart."),"OK").then(function(){return})}).then(function(refresh){Loader.hide()})}
$scope.openCart=function(){if(!$scope.is_loading){$state.go("mmobilcart-cart-view",{value_id:$scope.value_id})}};$scope.openSpecials=function(){if(!$scope.is_loading){$state.go('mmobilcart-specials',{value_id:$scope.value_id})}};MmobilcartSalesCustomer.value_id=$stateParams.value_id;$scope.loadContent=function(){MmobilcartSalesCustomer.getOrderDetails($scope.order_id).then(function(data){$scope.order=data.order;$scope.use_exit=data.order.use_exit;$scope.special_total_count=data.order.special_total_count}).then(function(){Loader.hide()})};$scope.loadContent()});angular.module('starter').controller('MMobilcartSalesPaymentViewController',function(Loader,$scope,$state,$stateParams,$timeout,$window,$translate,MmobilcartCart,MmobilcartSalesPayment,Dialog,$ionicTabsDelegate){$scope.page_title=$translate.instant('Payment');MmobilcartCart.value_id=$stateParams.value_id;MmobilcartSalesPayment.value_id=$stateParams.value_id;$scope.value_id=$stateParams.value_id;MmobilcartCart.value_id=$stateParams.value_id;$scope.special_total_count=0;$scope.cart_total_badge="";$scope.cart_total_badge_updating=0;$scope.cart_total_badge_update=function(){if($scope.cart_total_badge_updating==0){console.log("update total cart event");$scope.cart_total_badge_updating=1;MmobilcartCart.getOnlyTotal().then(function(data){if(data.cart_total==null||data.cart_total==0)$scope.cart_total_badge="";else $scope.cart_total_badge=data.cart_total.toString();$window.localStorage.setItem("cart_total_badge",$scope.cart_total_badge)});$scope.cart_total_badge_updating=0}}
$scope.cart_total_badge_update();$timeout(function(){$scope.cart_total_badge_update()},3000);$scope.use_exit=0;if($window.localStorage.getItem("mmobilcart_use_exit")=="1"){$scope.use_exit=1}
$scope.goHome=function(){if(!$scope.is_loading){$state.go('mmobilcart-category-list',{value_id:$scope.value_id})}};$scope.closeMobilcart=function(){$state.go('home')};$scope.openHistory=function(){if(!$scope.is_loading){$state.go('mmobilcart-sales-history',{value_id:$scope.value_id})}};$scope.openSpecials=function(){if(!$scope.is_loading){$state.go('mmobilcart-specials',{value_id:$scope.value_id})}};$scope.openCart=function(){if(!$scope.is_loading){$state.go("mmobilcart-cart-view",{value_id:$scope.value_id})}};$scope.loadContent=function(){Loader.show();MmobilcartCart.find().then(function(data){$scope.cart=data.cart;MmobilcartSalesPayment.findPaymentMethods().then(function(resultMethods){$scope.paymentMethods=resultMethods.paymentMethods;$scope.special_total_count=resultMethods.special_total_count;$scope.use_exit=resultMethods.use_exit;$scope.paymentMethodId=resultMethods.paymentMethods.reduce(function(paymentMethodId,paymentMethod){return($scope.cart.paymentMethodId===paymentMethod.id)?paymentMethod.id:paymentMethodId},null);if($scope.paymentMethods.length===1&&$scope.paymentMethods[0].code==='free'){$scope.cart.paymentMethodId=$scope.paymentMethods[0].id;$scope.updatePaymentInfos()}}).then(function(){$scope.is_loading=!1;Loader.hide()})},function(){$scope.is_loading=!1;Loader.hide()})};$scope.updatePaymentInfos=function(){if(!$scope.is_loading){$scope.is_loading=!0;Loader.show();MmobilcartCart.setPaymentMethodId($scope.cart.paymentMethodId);var postParameters={'payment_method_id':$scope.cart.paymentMethodId};MmobilcartSalesPayment.updatePaymentInfos(postParameters).then(function(data){$scope.goToOverview()},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert('',data.message,'OK')}}).then(function(){$scope.is_loading=!1;Loader.hide()})}};$scope.goToOverview=function(){if($scope.cart.paymentMethodId){$state.go('mmobilcart-sales-customer',{value_id:$stateParams.value_id})}else{Dialog.alert('','Please choose a payment method.','OK')}};$scope.right_button={action:$scope.updatePaymentInfos,label:$translate.instant('Next')};$scope.loadContent()});angular.module("starter").controller("MMobilcartSalesStoreChoiceController",function(Loader,$scope,$state,$stateParams,$translate,Dialog,MmobilcartSalesStorechoice){$scope.value_id=$stateParams.value_id;MmobilcartSalesStorechoice.value_id=$stateParams.value_id;$scope.selected_store={id:null};$scope.loadContent=function(){$scope.is_loading=!0;Loader.show();MmobilcartSalesStorechoice.find().then(function(data){$scope.stores=data.stores;$scope.cart_amount=data.cart_amount;$scope.selected_store.id=data.store_id;if($scope.selected_store.id){$scope.chooseStore()}}).then(function(){$scope.is_loading=!1;Loader.hide()})};$scope.chooseStore=function(){if($scope.selected_store.id){$scope.min_amount=0;angular.forEach($scope.stores,function(store){if(store.id==$scope.selected_store.id){$scope.min_amount=store.min_amount;$scope.error_message=store.error_message}});if($scope.min_amount<=$scope.cart_amount){$scope.is_loading=!0;Loader.show();MmobilcartSalesStorechoice.update($scope.selected_store.id).then(function(data){if(data.store_id){$scope.showNextButton()}}).then(function(){$scope.is_loading=!1;Loader.hide()})}else{Dialog.alert("",$scope.error_message,"OK");$scope.hideNextButton()}}};$scope.goToDeliveryPage=function(){if(!$scope.is_loading){$state.go('mmobilcart-sales-delivery',{value_id:$scope.value_id})}};$scope.showNextButton=function(){$scope.right_button={action:$scope.goToDeliveryPage,label:$translate.instant("Proceed")}};$scope.hideNextButton=function(){$scope.right_button={action:null,label:""}};$scope.openSpecials=function(){if(!$scope.is_loading){$state.go('mmobilcart-specials',{value_id:$scope.value_id})}};$scope.loadContent()});angular.module("starter").controller("MMobilcartSalesStripeViewController",function(Loader,$scope,$state,$stateParams,$timeout,$translate,Customer,MmobilcartStripe,Dialog){$scope.is_loading=!0;Loader.show();$scope.value_id=$stateParams.value_id;MmobilcartStripe.value_id=$stateParams.value_id;$scope.card={};$scope.payment={};$scope.payment.save_card=!1;$scope.payment.use_stored_card=!1;$scope.loadContent=function(){$scope.guest_mode=Customer.guest_mode;var cust_id=null;if(Customer.isLoggedIn()){cust_id=Customer.id}
$scope.payment.save_card=!1;MmobilcartStripe.find(cust_id).then(function(data){Stripe.setPublishableKey(data.publishable_key);$scope.cart_total=data.total;if(data.card&&data.card.exp_year){$scope.card=data.card;$scope.payment.use_stored_card=!0}}).then(function(){$scope.is_loading=!1;Loader.hide()})};if(typeof Stripe==="undefined"){var stripeJS=document.createElement('script');stripeJS.type="text/javascript";stripeJS.src="https://js.stripe.com/v2/";stripeJS.onload=function(){$scope.loadContent()};document.body.appendChild(stripeJS)}else{$scope.loadContent()}
$scope.unloadcard=function(){Dialog.confirm("Confirmation","Do you confirm you want to remove your card?",["Yes","No"]).then(function(result){if(result){$scope.is_loading=!0;Loader.show();MmobilcartStripe.removeCard(Customer.id).then(function(data){$scope.oldcard=$scope.card;$scope.card={};$scope.payment.use_stored_card=!1}).then(function(){$scope.is_loading=!1;Loader.hide()})}})};$scope.process=function(){if(!$scope.is_loading){$scope.is_loading=!0;Loader.show();if($scope.payment.use_stored_card){_process()}else{Stripe.card.createToken($scope.card,function(status,response){_stripeResponseHandler(status,response)})}}};var _stripeResponseHandler=function(status,response){$timeout(function(){if(response.error){Dialog.alert("",response.error.message,"OK");$scope.is_loading=!1;Loader.hide()}else{$scope.card={token:response.id,last4:response.card.last4,brand:response.card.brand,exp_month:response.card.exp_month,exp_year:response.card.exp_year,exp:Math.round(+(new Date((new Date(response.card.exp_year,response.card.exp_month,1))-1))/1000)|0};_process()}})};var _process=function(){var data={"token":$scope.card.token,"use_stored_card":$scope.payment.use_stored_card,"save_card":$scope.payment.save_card,"customer_id":Customer.id||null};MmobilcartStripe.process(data).then(function(res){if(res){$state.go("mmobilcart-sales-success",{value_id:$stateParams.value_id})}else{Dialog.alert("Error","Unexpected error","OK")}},function(err){Dialog.alert("Error","Unexpected error","OK")}).then(function(){$scope.is_loading=!1;Loader.hide()})};$scope.right_button={action:$scope.process,label:$translate.instant("Pay")}});angular.module('starter').controller('MMobilcartSalesSuccessViewController',function($scope,$state,$stateParams,$timeout,Customer){$scope.value_id=$stateParams.value_id;if(Customer.guest_mode){Customer.guest_mode=!1;Customer.logout()}
$timeout(function(){$state.go('mmobilcart-redirect',{value_id:$scope.value_id})},3000)});angular.module("starter").factory("MmobilcartCart",function($pwaRequest,$session){var factory={value_id:null};var paymentMethodId=null;var deliveryMethodId=null;factory.setPaymentMethodId=function(id){paymentMethodId=id};factory.shoudShowPaymentAddress=function(){return paymentMethodId==4};factory.setDeleveryMethodId=function(id){deliveryMethodId=id};factory.shoudShowDeleveryAddress=function(){return deliveryMethodId==2};factory.find=function(){if(!this.value_id){return $pwaRequest.reject("[MmobilcartCart::find] missing value_id.")}
return $pwaRequest.get("mmobilcart/mobile_cart/find",{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.addProduct=function(form){if(!this.value_id){return $pwaRequest.reject("[MmobilcartCart::addProduct] missing value_id.")}
return $pwaRequest.post("mmobilcart/mobile_cart/add",{urlParams:{value_id:this.value_id},data:{form:form},cache:!1,refresh:!0})};factory.adddiscount=function(discount_code,use_clean_code){if(!this.value_id){return use_clean_code?$pwaRequest.reject('[MmobilcartCart::adddiscount] missing value_id.'):$pwaRequest.resolve({success:!1})}
if(discount_code===undefined){return $pwaRequest.resolve({success:!0})}
if(discount_code.length===0&&!use_clean_code){return $pwaRequest.resolve({success:!0})}
return $pwaRequest.post('mmobilcart/mobile_cart/adddiscount',{urlParams:{value_id:this.value_id},data:{discount_code:discount_code,customer_uuid:$session.getDeviceUid()},cache:!1,refresh:!0,})};factory.addTip=function(cart){if(!this.value_id){return $pwaRequest.reject("[MmobilcartCart::addTip] missing value_id.")}
return $pwaRequest.post("mmobilcart/mobile_cart/addtip",{urlParams:{value_id:this.value_id},data:{tip:cart.tip?cart.tip:0}})};factory.compute=function(){if(!this.value_id){return $pwaRequest.reject("[MmobilcartCart::compute] missing value_id.")}
return $pwaRequest.post("mmobilcart/mobile_cart/compute",{urlParams:{value_id:this.value_id,customer_uuid:$session.getDeviceUid()},cache:!1,refresh:!0})};factory.deleteLine=function(line_id){if(!this.value_id||!line_id){return $pwaRequest.reject("[MmobilcartCart::deleteLine] missing value_id or line_id.")}
return $pwaRequest.get("mmobilcart/mobile_cart/delete",{urlParams:{value_id:this.value_id,line_id:line_id},cache:!1,refresh:!0})};factory.modifyLine=function(line){if(!this.value_id){return $pwaRequest.reject("[MmobilcartCart::modifyLine] missing value_id.")}
return $pwaRequest.post("mmobilcart/mobile_cart/modify",{data:{line_id:line.id,qty:line.qty,format:line.format},cache:!1,refresh:!0})};factory.useFidelityPoints=function(points){if(!this.value_id){return $pwaRequest.reject("[MmobilcartCart::useFidelityPoints] missing value_id.")}
return $pwaRequest.post("mmobilcart/mobile_cart/usefidelitypointsforcart",{data:{points:points}})};factory.removeAllDiscount=function(){if(!this.value_id){return $pwaRequest.reject("[MmobilcartCart::removeAllDiscount] missing value_id.")}
return $pwaRequest.post("mmobilcart/mobile_cart/removealldiscount")};factory.getOnlyTotal=function(){if(!this.value_id){return $pwaRequest.reject("[MmobilcartCart::getOnlyTotal] missing value_id.")}
return $pwaRequest.get("mmobilcart/mobile_cart/getonlytotal",{urlParams:{value_id:this.value_id}}).then(function(data){return data})};factory.getFooter=function(){if(!this.value_id){return $pwaRequest.reject("[MmobilcartCart::getFooter] missing value_id.")}
return $pwaRequest.get("mmobilcart/mobile_cart/getfooter",{urlParams:{value_id:this.value_id}}).then(function(data){return data})};return factory});angular.module("starter").factory("MmobilcartCategory",function($pwaRequest){var factory={value_id:null,category_id:null};factory.findAll=function(offset){if(!this.value_id){return $pwaRequest.reject("[MmobilcartCategory::findAll] missing value_id.")}
return $pwaRequest.get("mmobilcart/mobile_category/findall",{urlParams:{value_id:this.value_id,category_id:this.category_id,offset:offset},cache:!1,refresh:!0}).then(function(data){if(data.displayed_per_page){factory.displayed_per_page=data.displayed_per_page}
return data})};factory.specials=function(offset){if(!this.value_id){return $pwaRequest.reject("[MmobilcartCategory::specials] missing value_id.")}
return $pwaRequest.get("mmobilcart/mobile_category/specials",{urlParams:{value_id:this.value_id},cache:!1,refresh:!0}).then(function(data){if(data.displayed_per_page){factory.displayed_per_page=data.displayed_per_page}
return data})};return factory});angular.module("starter").factory("MmobilcartProduct",function($pwaRequest){var factory={value_id:null};factory.find=function(product_id){if(!this.value_id){return $pwaRequest.reject("[MmobilcartProduct::find] missing value_id.")}
return $pwaRequest.get("mmobilcart/mobile_product/find",{urlParams:{value_id:this.value_id,product_id:product_id},cache:!1,refresh:!0})};return factory});angular.module("starter").factory("MmobilcartOffline",function($pwaRequest){var factory={value_id:null,offline_text:null,is_offline:null,offline_redirect:null};factory.findAll=function(offset){if(!this.value_id){return $pwaRequest.reject("[MmobilcartOffline::findAll] missing value_id.")}
return $pwaRequest.get("mmobilcart/mobile_offline/findall",{urlParams:{value_id:this.value_id}}).then(function(data){factory.is_offline=data.is_offline;factory.offline_text=data.offline_text;factory.offline_redirect=data.offline_redirect;return data})};return factory});angular.module('starter').factory('MmobilcartSalesCustomer',function($pwaRequest){var factory={value_id:null};factory.updateCustomerInfos=function(form){if(!this.value_id){return $pwaRequest.reject('[MmobilcartSalesCustomer::updateCustomerInfos] missing value_id.')}
return $pwaRequest.post('mmobilcart/mobile_sales_customer/update',{urlParams:{value_id:this.value_id},cache:!1,refresh:!0,data:{form:form,option_value_id:this.value_id}})};factory.find=function(){if(!this.value_id){return $pwaRequest.reject('[MmobilcartSalesCustomer::find] missing value_id.')}
return $pwaRequest.get('mmobilcart/mobile_sales_customer/find',{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.hasGuestMode=function(){if(!this.value_id){return $pwaRequest.reject('[MmobilcartSalesCustomer::hasGuestMode] missing value_id.')}
return $pwaRequest.get('mmobilcart/mobile_sales_customer/hasguestmode',{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.getOrderHistory=function(offset){if(!this.value_id){return $pwaRequest.reject('[MmobilcartSalesCustomer::getOrderHistory] missing value_id.')}
return $pwaRequest.get('mmobilcart/mobile_sales_customer/getorders',{urlParams:{value_id:this.value_id,offset:offset},cache:!1,refresh:!0})};factory.getOrderDetails=function(order_id){if(!this.value_id){return $pwaRequest.reject('[MmobilcartSalesCustomer::getOrderDetails] missing value_id.')}
return $pwaRequest.get('mmobilcart/mobile_sales_customer/getorderdetails',{urlParams:{value_id:this.value_id,order_id:order_id},cache:!1,refresh:!0})};factory.reOrder=function(order_id){if(!this.value_id){return $pwaRequest.reject('[MmobilcartSalesCustomer::reOrder] missing value_id.')}
return $pwaRequest.get('mmobilcart/mobile_sales_customer/reorder',{urlParams:{value_id:this.value_id,order_id:order_id},cache:!1,refresh:!0})};return factory});angular.module("starter").factory("MmobilcartSalesDelivery",function($pwaRequest){var factory={value_id:null};factory.findStore=function(){if(!this.value_id){return $pwaRequest.reject("[MmobilcartSalesDelivery::findStore] missing value_id.")}
return $pwaRequest.get("mmobilcart/mobile_sales_delivery/findstore",{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.updateDeliveryInfos=function(form){if(!this.value_id){return $pwaRequest.reject("[MmobilcartSalesDelivery::updateDeliveryInfos] missing value_id.")}
return $pwaRequest.post("mmobilcart/mobile_sales_delivery/update",{urlParams:{value_id:this.value_id},data:{form:form},cache:!1,refresh:!0})};return factory});angular.module('starter').factory('MmobilcartSalesPayment',function($pwaRequest,$session){var factory={value_id:null,notes:''};factory.findPaymentMethods=function(){if(!this.value_id){return $pwaRequest.reject('[MmobilcartSalesPayment::findPaymentMethods] missing value_id.')}
return $pwaRequest.get('mmobilcart/mobile_sales_payment/findpaymentmethods',{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.findOnlinePaymentUrl=function(){if(!this.value_id){return $pwaRequest.reject('[MmobilcartSalesPayment::findOnlinePaymentUrl] missing value_id.')}
return $pwaRequest.get('mmobilcart/mobile_sales_payment/findonlinepaymenturl',{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.getCloudPaymentsData=function(){if(!this.value_id){return $pwaRequest.reject('[MmobilcartSalesPayment::getCloudPaymentsData] missing value_id.')}
return $pwaRequest.get('mmobilcart/mobile_sales_payment/getcloudpaymentsdata',{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.getStripePaymentsData=function(){if(!this.value_id){return $pwaRequest.reject('[MmobilcartSalesPayment::getStripePaymentsData] missing value_id.')}
return $pwaRequest.get('mmobilcart/mobile_sales_payment/getstripedata',{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.getIyzicoPaymentsData=function(){if(!this.value_id){return $pwaRequest.reject('[MmobilcartSalesPayment::getIyzicoPaymentsData] missing value_id.')}
return $pwaRequest.get('mmobilcart/mobile_sales_payment/getiyzicodata',{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.getYandexPaymentsData=function(){if(!this.value_id){return $pwaRequest.reject('[MmobilcartSalesPayment::getYandexPaymentsData] missing value_id.')}
return $pwaRequest.get('mmobilcart/mobile_sales_payment/getyandexdata',{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.checkYandexPaymentsData=function(){if(!this.value_id){return $pwaRequest.reject('[MmobilcartSalesPayment::checkYandexPaymentsData] missing value_id.')}
return $pwaRequest.get('mmobilcart/mobile_sales_payment/checkyandexdata',{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.updatePaymentInfos=function(form){if(!this.value_id){return $pwaRequest.reject('[MmobilcartSalesPayment::updatePaymentInfos] missing value_id.')}
return $pwaRequest.post('mmobilcart/mobile_sales_payment/update',{urlParams:{value_id:this.value_id},cache:!1,refresh:!0,data:{form:form}})};factory.validatePayment=function(){if(!this.value_id){return $pwaRequest.reject('[MmobilcartSalesPayment::validatePayment] missing value_id.')}
var formData={validate_payment:1,customer_uuid:$session.getDeviceUid(),notes:factory.notes||''};if(IS_NATIVE_APP){formData.is_ajax=!0}
return $pwaRequest.post('mmobilcart/mobile_sales_payment/validatepayment',{urlParams:{value_id:this.value_id},cache:!1,refresh:!0,data:formData})}
factory.makeStripePayment=function(p){if(!this.value_id){return $pwaRequest.reject("[MmobilcartStripe::process] missing value_id.")}
return $pwaRequest.post("mmobilcart/mobile_stripe/process",{urlParams:{value_id:this.value_id},cache:!1,refresh:!0,data:{"source_data":p,"notes":sessionStorage.getItem('mmobilcart-notes')||""}})};return factory});angular.module("starter").factory("MmobilcartSalesStorechoice",function($pwaRequest){var factory={value_id:null};factory.find=function(){if(!this.value_id){return $pwaRequest.reject("[MmobilcartSalesStorechoice::find] missing value_id.")}
return $pwaRequest.get("mmobilcart/mobile_sales_storechoice/find",{urlParams:{value_id:this.value_id},cache:!1})};factory.update=function(store_id){if(!this.value_id){return $pwaRequest.reject("[MmobilcartSalesStorechoice::update] missing value_id.")}
return $pwaRequest.post("mmobilcart/mobile_sales_storechoice/update",{data:{store_id:store_id}})};return factory});angular.module("starter").factory("MmobilcartStripe",function($pwaRequest){var factory={value_id:null};factory.find=function(cust_id){if(!this.value_id){return $pwaRequest.reject("[MmobilcartStripe::find] missing value_id.")}
return $pwaRequest.post("mmobilcart/mobile_sales_stripe/find",{data:{customer_id:cust_id}})};factory.process=function(data){if(!this.value_id){return $pwaRequest.reject("[MmobilcartStripe::process] missing value_id.")}
return $pwaRequest.post("mmobilcart/mobile_sales_stripe/process",{data:{value_id:this.value_id,token:data.token,customer_id:data.customer_id,use_stored_card:data.use_stored_card,save_card:data.save_card,notes:sessionStorage.getItem('mmobilcart-notes')||""}})};factory.getCard=function(customer_id){if(!this.value_id){return $pwaRequest.reject("[MmobilcartStripe::getCard] missing value_id.")}
return $pwaRequest.post("mmobilcart/mobile_sales_stripe/getcard",{data:{"value_id":this.value_id,"customer_id":customer_id}})};factory.removeCard=function(customer_id){if(!this.value_id){return $pwaRequest.reject("[MmobilcartStripe::removeCard] missing value_id.")}
return $pwaRequest.post("mmobilcart/mobile_sales_stripe/removecard",{data:{"value_id":this.value_id,"customer_id":customer_id}})};return factory});Features.insertCSS(":root{--safe-area-inset-top:0;--safe-area-inset-right:0;--safe-area-inset-bottom:0;--safe-area-inset-left:0}@supports (padding-top:constant(safe-area-inset-top)){:root{--safe-area-inset-top:constant(safe-area-inset-top);--safe-area-inset-right:constant(safe-area-inset-right);--safe-area-inset-bottom:constant(safe-area-inset-bottom);--safe-area-inset-left:constant(safe-area-inset-left)}}@supports (padding-top:env(safe-area-inset-top)){:root{--safe-area-inset-top:env(safe-area-inset-top);--safe-area-inset-right:env(safe-area-inset-right);--safe-area-inset-bottom:env(safe-area-inset-bottom);--safe-area-inset-left:env(safe-area-inset-left)}}.platform-overview.platform-cordova{--safe-area-inset-top:1.5em;--safe-area-inset-right:0;--safe-area-inset-bottom:.5em;--safe-area-inset-left:0}.products-list-rows-button-bar .button-small.icon-left::before{font-size:24px}.products-list-rows-button-bar .products-list-rows-row-cart-button{font-size:24px}.products-list-grid-button-bar .button.button-icon{font-size:24px}ion-tabs.hydrated{visibility:inherit;top:auto;height:auto}ion-tabs.hydrated ion-tab:first-child{display:none!important}","m_mobilcart")