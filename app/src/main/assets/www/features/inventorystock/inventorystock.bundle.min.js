angular.module('starter').controller('InventorystockController',function(Application,Dialog,Loader,$timeout,$filter,Inventorystock,$ionicModal,Customer,$rootScope,SB,$scope,$state,$stateParams,$translate,$cordovaBarcodeScanner){$scope.value_id=Inventorystock.value_id=$stateParams.value_id;$scope.is_logged_in=Customer.isLoggedIn();$scope.is_store_available=!1;$scope.is_loading=!1;$scope.is_submitting=!1;$scope.page_title='';$scope.default_store={};$scope.products={};$scope.searchText='';$scope.is_searching=!1;$scope.forTranslate=function(text){return $translate.instant(text,"inventorystock")};$rootScope.$on(SB.EVENTS.AUTH.loginSuccess,function(){$scope.loadContent();$scope.is_logged_in=Customer.isLoggedIn();$scope.customer=Customer.customer});$rootScope.$on(SB.EVENTS.AUTH.logoutSuccess,function(){$scope.loadContent();$scope.is_logged_in=Customer.isLoggedIn();$scope.customer=Customer.customer});$scope.login=function(){Customer.loginModal($scope)}
$scope.loadContent=function(){if(!Customer.isLoggedIn())return!1;$scope.is_loading=!0;$scope.store_id=0;$scope.default_store=Inventorystock.getDefaultStore();if($scope.default_store){$scope.store_id=$scope.default_store.store_id}
Inventorystock.findAll($scope.store_id).success(function(data){$scope.page_title=data.page_title;$scope.payout=data;$scope.products=data.products;if(data.total_stores==0){$scope.is_store_available=!1}else{$scope.default_store=Inventorystock.getDefaultStore();if(!$scope.default_store){if(data.total_stores==1){Inventorystock.setDefaultStore(data.stores[0]);$scope.is_store_available=!0}}else{var oldStore=$filter('filter')(data.stores,{store_id:$scope.default_store.store_id});console.log("oldStore",oldStore);if(oldStore.length==0){Inventorystock.setDefaultStore({});Dialog.alert($translate.instant("Error","inventorystock"),$scope.default_store.store_name+' '+$translate.instant("is not available, Please change the default store.","inventorystock"),"OK",-1,"inventorystock");$scope.is_store_available=!1}else{$scope.is_store_available=!0}}}}).error(function(){$scope.is_loading=!1}).finally(function(){$scope.is_loading=!1})}
$scope.changeStore=function(){$ionicModal.fromTemplateUrl('features/inventorystock/assets/templates/l1/modal/store.html',{scope:$scope,animation:'slide-in-up'}).then(function(modal){$scope.stores=$scope.payout.stores;$scope.storeModal=modal;$scope.storeModal.show()})};$scope.closeChangeStore=function(){$scope.storeModal.hide()}
$scope.setDefaultStore=function(store){Inventorystock.setDefaultStore(store);$scope.loadContent();$scope.closeChangeStore()}
$scope.openProductModal=function(ean_number=''){$scope.is_loading=!0;$ionicModal.fromTemplateUrl('features/inventorystock/assets/templates/l1/modal/add.html',{scope:$scope,animation:'slide-in-up'}).then(function(modal){$scope.cart={};$scope.cart=Inventorystock.getCart();$scope.cart.ean_number=ean_number;$scope.cart.qty='';$scope.cart.id='';Inventorystock.setCart($scope.cart);$scope.is_loading=!1;$scope.addProductModal=modal;$scope.addProductModal.show()})};$scope.openEditProductModal=function(param){$scope.is_loading=!0;$ionicModal.fromTemplateUrl('features/inventorystock/assets/templates/l1/modal/add.html',{scope:$scope,animation:'slide-in-up'}).then(function(modal){$scope.cart={};$scope.cart=Inventorystock.getCart();$scope.cart.ean_number=parseInt(param.ean_number);$scope.cart.qty=parseInt(param.qty);$scope.cart.id=parseInt(param.id);$scope.cart.category_id=parseInt(param.category_id);$scope.cart.category_name=param.category_name;$scope.is_loading=!1;$scope.addProductModal=modal;$scope.addProductModal.show()})};$scope.closeAddProduct=function(){$scope.addProductModal.hide()}
$scope.saveProduct=function(){$scope.default_store=Inventorystock.getDefaultStore();$scope.cart.store_name=$scope.default_store.store_name;$scope.cart.store_id=$scope.default_store.store_id;$scope.is_submitting=!0;Inventorystock.saveProduct($scope.cart).success(function(data){$scope.products=data.products;$scope.closeAddProduct();$scope.is_submitting=!1}).error(function(){$scope.is_submitting=!1}).finally(function(){$scope.is_submitting=!1})}
$scope.openCategoryModal=function(){$scope.is_loading=!0;$ionicModal.fromTemplateUrl('features/inventorystock/assets/templates/l1/modal/category.html',{scope:$scope,animation:'slide-in-up'}).then(function(modal){$scope.is_loading=!1;$scope.categories=$scope.payout.categories;$scope.addCategoryModal=modal;$scope.addCategoryModal.show()})};$scope.closeCategoryModal=function(){$scope.addCategoryModal.hide()}
$scope.selectCategory=function(category){$scope.cart.category_id=category.id;$scope.cart.category_name=category.category_name;Inventorystock.setCart($scope.cart);$scope.closeCategoryModal()}
$scope.searchProduct=function(){console.log('searchText',$scope.searchText);$scope.default_store=Inventorystock.getDefaultStore();$scope.is_searching=!0;Inventorystock.searchProduct($scope.default_store.store_id,$scope.searchText).success(function(data){$scope.products=data.products;$scope.is_searching=!1}).error(function(){$scope.is_searching=!1}).finally(function(){$scope.is_searching=!1})}
$scope.showScanCamera=function(){if(!Application.is_webview){$cordovaBarcodeScanner.scan().then(function(barcodeData){if(!barcodeData.cancelled&&(barcodeData.text!=='')){$timeout(function(){if(barcodeData.format==='EAN_13'||barcodeData.format==="EAN_8"){var barcodeDataText=barcodeData.text;$scope.openProductModal(parseInt(barcodeDataText))}else{Dialog.alert('Error','Invalid code.','OK',-1)}})}else{Dialog.alert($translate.instant("Error","inventorystock"),$translate.instant("Unreadable QRCode, sorry","inventorystock"),"OK",-1,"inventorystock")}},function(error){Dialog.alert('Error','An error occurred while reading the code.','OK',-1)})}else{Dialog.alert($translate.instant("Info","inventorystock"),$translate.instant("This will open the code scan camera on your device","inventorystock"),$translate.instant("Ok","inventorystock"),-1)}};$scope.loadContent()});angular.module('starter').factory('Inventorystock',function($state,$pwaRequest,$session,$rootScope,$log){var factory={};factory.value_id=null;factory.cart={};factory.setCart=function(cart){factory.cart=cart;return factory};factory.getCart=function(){return factory.cart};factory.setDefaultStore=function(default_store){return localStorage.setItem("default_store",JSON.stringify(default_store))};factory.getDefaultStore=function(){return JSON.parse(localStorage.getItem("default_store"))};factory.setValueId=function(valueId){factory.value_id=valueId;return factory};factory.getValueId=function(){return factory.value_id};factory.findAll=function(store_id){return $pwaRequest.post('/inventorystock/mobile_view/findall',{urlParams:{value_id:factory.value_id,store_id:store_id},cache:!1,refresh:!0})};factory.searchProduct=function(store_id,searchText){return $pwaRequest.post('/inventorystock/mobile_view/search-product',{urlParams:{value_id:factory.value_id,store_id:store_id,q:searchText},cache:!1,refresh:!0})};factory.saveProduct=function(param){return $pwaRequest.post('/inventorystock/mobile_view/save-product',{urlParams:{value_id:factory.value_id},data:param,cache:!1,refresh:!0})};return factory});Features.insertCSS(":root{--safe-area-inset-top:0;--safe-area-inset-right:0;--safe-area-inset-bottom:0;--safe-area-inset-left:0}@supports (padding-top:constant(safe-area-inset-top)){:root{--safe-area-inset-top:constant(safe-area-inset-top);--safe-area-inset-right:constant(safe-area-inset-right);--safe-area-inset-bottom:constant(safe-area-inset-bottom);--safe-area-inset-left:constant(safe-area-inset-left)}}@supports (padding-top:env(safe-area-inset-top)){:root{--safe-area-inset-top:env(safe-area-inset-top);--safe-area-inset-right:env(safe-area-inset-right);--safe-area-inset-bottom:env(safe-area-inset-bottom);--safe-area-inset-left:env(safe-area-inset-left)}}.platform-overview.platform-cordova{--safe-area-inset-top:1.5em;--safe-area-inset-right:0;--safe-area-inset-bottom:.5em;--safe-area-inset-left:0}.inventorystock .button-floating-action{position:fixed!important;top:calc(90vh - 60px)!important;right:2vw!important;border-radius:100px!important;border-width:0!important;padding:5px 12px 5px 12px!important;z-index:999!important;box-shadow:5px 5px 5px #888!important}.inventorystock .remove-border{border:0}.inventorystock .welcome-message-box{top:calc(20vh - 0px)!important}.inventorystock .select-a-store{padding:0 20px 0;border-radius:12px}.inventorystock .opacity-half{opacity:.5}","inventorystock")