angular.module('starter').controller('CommerceProCartViewController',function($scope,$state,Loader,$stateParams,$translate,$timeout,Dialog,$rootScope,CommerceProCart,Customer){angular.extend($scope,{is_loading:!1,value_id:$stateParams.value_id,page_title:$translate.instant('Cart','commerce_pro'),points_data:{use_points:!1,nb_points_used:null},nb_stores:null,object:{cart:null,},show_change_quantity:!0});CommerceProCart.value_id=$stateParams.value_id;$scope.checkStock=function(){$scope.stockinCart={};if($scope.object.cart.lines.length>0){var commerce_pro_setting=$scope.object.cart.commerce_pro;for(var line of $scope.object.cart.lines){var productIdkey=line.product.id;$scope.stockinCart[productIdkey]=$scope.stockinCart[productIdkey]!=undefined?$scope.stockinCart[productIdkey]+line.qty:line.qty;var currQuantityInCart=parseInt($scope.stockinCart[productIdkey]);if(currQuantityInCart>line.max_order_qty&&line.max_order_qty!=0){$scope.object.cart.valid=!1;var diff=currQuantityInCart-line.max_order_qty;$scope.object.cart.valid_message=$translate.instant('Quantity for product $2 can not be more than Maximum Order Quantity $1. Please remove $3 quantity to continue.','commerce_pro').replace("$1",line.max_order_qty).replace("$2",line.name).replace("$3",diff)}
if(currQuantityInCart<line.min_order_qty&&line.min_order_qty!=0){$scope.object.cart.valid=!1;var diff=line.min_order_qty-currQuantityInCart;$scope.object.cart.valid_message=$translate.instant('Quantity for product $2 can not be less than Minimum Order Quantity $1.  Please add $3 quantity to continue.','commerce_pro').replace("$1",line.min_order_qty).replace("$2",line.name).replace("$3",diff)}
if($scope.object.cart.stockCheck&&currQuantityInCart>line.available_stock){$scope.object.cart.valid=!1;var diff=parseInt($scope.stockinCart[productIdkey]-line.available_stock);$scope.object.cart.valid_message=$translate.instant("Product $1's available stock is $2. Please remove $3 quantity to continue.",'commerce_pro').replace("$1",line.name).replace("$2",line.available_stock).replace("$3",diff)}
if(commerce_pro_setting.payment_gateway_mapping=="2"){console.log('$scope.object.cart')
console.log($scope.object.cart)
console.log('line.store_id')
console.log(line.store_id)
if(line.store_id!=$scope.object.cart.storeId){$scope.object.cart.valid=!1;$scope.object.cart.valid_message=$translate.instant("User can not add products from multiple stores",'commerce_pro')}}}
$timeout(function(){if(!$scope.object.cart.valid)
Dialog.alert('',$scope.object.cart.valid_message,'OK')},1500)}}
$scope.loadContent=function(){Loader.show('Updating price');$scope.stockinCart={};$scope.is_loading=!0;CommerceProCart.compute().then(function(computation){$scope.computation=computation}).then(function(){$scope.computation=angular.isObject($scope.computation)?$scope.computation:{};CommerceProCart.find().then(function(data){if(data.cart.tip===0){data.cart.tip=''}
if(angular.isObject($scope.object.cart)&&(!angular.isString(data.cart.discount_code)||data.cart.discount_code.trim().length<1)){data.cart.discount_code=$scope.object.cart.discount_code}
$scope.object.cart=data.cart;$scope.object.cart.commerce_pro.price_hide_flag=data.cart.commerce_pro.price_hide_flag=='1'?!0:!1;$scope.object.cart.commerce_pro.is_product_pic_hide=data.cart.commerce_pro.is_product_pic_hide=='1'?!0:!1;$scope.taxes_in_price=data.cart.taxes_in_price;$scope.object.cart.discount_message=$scope.computation.message;$scope.object.cart.discount=$scope.computation.discount;$scope.nb_stores=data.nb_stores;if($rootScope.success_state==='bookingpro-home'){$scope.show_change_quantity=!1}
$scope.object.booking_data=data.cart.booking_data;if($scope.object.cart.lines.length>0){$scope.checkStock();$scope.right_button={action:$scope.proceed,label:$translate.instant('Proceed','commerce_pro')}}}).then(function(){Customer.find().then(function(data){$scope.object.cart.customer_fidelity_points=(data.metadatas&&data.metadatas.fidelity_points)?data.metadatas.fidelity_points.points:null;if(!$scope.points_data.use_points){$scope.points_data.nb_points_used=$scope.object.cart.customer_fidelity_points}
$scope.updateEstimatedDiscount()}).then(function(){Loader.hide();$scope.is_loading=!1})})})};$scope.updateEstimatedDiscount=function(){if($scope.points_data.nb_points_used>0){$scope.object.cart.estimated_fidelity_discount=(Math.round($scope.points_data.nb_points_used*$scope.object.cart.fidelity_rate*100)/100)+' '+$scope.object.cart.currency_code}};$scope.useFidelityChange=function(){if($scope.points_data.use_points){$scope.object.cart.discount_code=null;$scope.updateTipAndDiscount()}};$scope._update=_.debounce(function(){Loader.show('Updating price');$scope.is_loading=!0;CommerceProCart.adddiscount($scope.object.cart.discount_code,!0).then(function(){CommerceProCart.addTip($scope.object.cart).then(function(data){if(data.success){if(angular.isDefined(data.message)){Dialog.alert('',data.message,'OK');return}}},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert('',data.message,'OK')}}).then(function(){$scope.loadContent();Loader.hide();$scope.is_loading=!1})},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert('',data.message,'OK')}}).then(function(){Loader.hide();$scope.is_loading=!1})},900);$scope.updateTipAndDiscount=function(){$scope._update()};$scope.proceed=function(){Loader.show();var gotToNext=function(){if(!$scope.object.cart.valid){$scope.cartIdInvalid()}else if($scope.nb_stores>1){$scope.goToStoreChoice()}else{$scope.goToOverview()}};if($scope.object.cart&&$scope.object.cart.discount_code){CommerceProCart.adddiscount($scope.object.cart.discount_code,!0).then(function(data){if(data&&data.success){gotToNext()}else{if(data&&data.message){Dialog.alert('',data.message,'OK')}else{Dialog.alert('','Unexpected Error','OK')}}},function(resp){var data=resp.data;if(data&&angular.isDefined(data.message)){Dialog.alert('',data.message,'OK')}}).then(function(){Loader.hide()})}else if($scope.points_data.use_points){if($scope.points_data.nb_points_used>0){if($scope.points_data.nb_points_used<=$scope.cart.customer_fidelity_points){CommerceProCart.useFidelityPoints($scope.points_data.nb_points_used).then(function(data){gotToNext()},function(data){Dialog.alert('',data.message,'OK')}).then(function(){Loader.hide()})}else{Dialog.alert("Sorry","You don't have enough points",'OK')}}}else{CommerceProCart.removeAllDiscount().then(function(data){gotToNext()},function(data){Dialog.alert('',data.message,'OK')}).then(function(){Loader.hide()})}};$scope.cartIdInvalid=function(){Dialog.alert("Sorry",$scope.object.cart.valid_message,"OK",3700)};$scope.goToStoreChoice=function(){$state.go('commercepro-sales-store',{value_id:$scope.value_id})};$scope.goToOverview=function(){if(!$scope.is_loading){$state.go('commercepro-sales-customer',{value_id:$scope.value_id})}};$scope.goToCategories=function(){var state_name='commercepro-category-list';if($rootScope.success_state){state_name=$rootScope.success_state}
$state.go(state_name,{value_id:$scope.value_id})};$scope.removeLine=function(line){Loader.show('Updating price');$scope.is_loading=!0;CommerceProCart.deleteLine(line.id).then(function(data){if(data.success){if(angular.isDefined(data.message)){Dialog.alert('',data.message,'OK');return}
$scope.loadContent()}},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert('',data.message,'OK')}})};$scope.changeQuantity=function(qty,params){Loader.show('Updating price');$scope.is_loading=!0;var localLine=angular.copy(params.line);localLine.qty=angular.copy(qty);console.log('cartmodifying');return CommerceProCart.modifyLine(localLine).then(function(data){$timeout(function(){$scope.object.cart.formattedSubtotalExclTax=data.cart.formattedSubtotalExclTax;$scope.object.cart.formattedDeliveryCost=data.cart.formattedDeliveryCost;$scope.object.cart.formattedTotalExclTax=data.cart.formattedTotalExclTax;$scope.object.cart.formattedTotalTax=data.cart.formattedTotalTax;$scope.object.cart.formattedTotal=data.cart.formattedTotal;$scope.object.cart.deliveryCost=data.cart.deliveryCost;$scope.object.cart.valid=data.cart.valid});return data},function(data){if(data&&angular.isDefined(data.message)){$scope.message=new Message();$scope.message.isError(!0).setText(data.message).show()}}).then(function(data){if(data&&angular.isDefined(data.message)){Dialog.alert('',$translate.instant(data.message),'OK')}
var scopeLineIndex=_.findIndex($scope.object.cart.lines,function(line){return line.id==data.line.id});$timeout(function(){$scope.object.cart.lines[scopeLineIndex]=data.line;Loader.hide();$scope.is_loading=!1;$scope.checkStock()});return data}).catch(function(){Loader.hide();$scope.is_loading=!1})};$scope.loadContent()});angular.module("starter").controller("CommerceProListController",function(Loader,$location,$scope,$state,$stateParams,$http,Url,Customer,$rootScope){$scope.is_loading=!0;Loader.show();$scope.value_id=$stateParams.value_id;$scope.is_chat_enable=!1;$rootScope.success_state='';if($rootScope.show_commercepro_banner!=!1){$rootScope.show_commercepro_banner=!0}
$scope.loadContent=function(){$http({method:'GET',url:Url.get("commercepro/mobile_list/get-settings",{value_id:$scope.value_id}),cache:!1,responseType:'json'}).then(function(data){console.log('loaded');data=data.data;$scope.cover=data.cover;$scope.page_title=data.page_title;$scope.list_view=data.list_view;$scope.show_search=data.show_search;$scope.labels=data.labels;$rootScope.CommercePro_labels=$scope.labels;if($scope.list_view==='plist_content'&&data.store_id){$scope.store_id=data.store_id}
$scope.unread_messages_count=data.unread_messages;$scope.is_chat_enable=data.is_chat_enable}).finally(function(){$scope.is_loading=!1;Loader.hide()})};$scope.displayChatHistory=function(){if(!Customer.isLoggedIn()){return Customer.loginModal(undefined,function(){$state.go('socialnetworks-chat-history',{value_id:$scope.value_id})})}
$state.go('socialnetworks-chat-history',{value_id:$scope.value_id})};$scope.closeBanner=function(){$rootScope.show_commercepro_banner=!1};$scope.loadContent()}).controller("CommerceProCategoryController",function(Loader,$location,$scope,$state,$stateParams,CommerceProCategory,CommerceProCart,Customer,$rootScope,$timeout,$translate,Lightbox,CommerceProProduct,$cordovaBarcodeScanner,Dialog){$scope.is_loading=!0;Loader.show();$scope.factory=CommerceProCategory;$scope.collection=[];$scope.collection_is_empty=!0;$scope.is_cart_enable=!1;$scope.is_chat_enable=!1;$scope.price_hide_flag=!1;$scope.is_product_pic_hide=!1;CommerceProCategory.value_id=$stateParams.value_id;CommerceProCategory.category_id=$stateParams.category_id;$scope.value_id=$stateParams.value_id;$scope.use_button_header=!1;if(Customer.isLoggedIn()&&!$stateParams.category_id){$scope.use_button_header=!0}
if($rootScope.show_commercepro_banner&&CommerceProCategory.category_id){$rootScope.show_commercepro_banner=!1}else if($rootScope.show_commercepro_banner){$rootScope.show_commercepro_banner=!0}
$scope.loadContent=function(){CommerceProCategory.findAll().then(function(data){$scope.price_hide_flag=data.price_hide_flag;$scope.show_search=data.show_search;$scope.collection=data.collection;$scope.collection_is_empty=$scope.collection.length>0;$scope.is_product_pic_hide=data.is_product_pic_hide;$scope.cover=data.cover;$scope.page_title=data.page_title;if(data.is_cart_enable){$scope.is_cart_enable=!0}
if(data.is_chat_enable==="1"){$scope.is_chat_enable=!0}
$scope.list_view=data.list_view;$timeout(function(){Lightbox.run(".category-list")},200)}).then(function(){$scope.is_loading=!1;Loader.hide()});CommerceProCart.value_id=$stateParams.value_id;CommerceProCart.find().then(function(data){try{$scope.cartItems=data.cart.lines.length}catch(e){$scope.cartItems=0}})};$scope.openCart=function(){if(!$scope.is_loading){$state.go('commercepro-cart-view',{value_id:$scope.value_id})}};$scope.openHistory=function(){if(!$scope.is_loading){$state.go('commercepro-sales-history',{value_id:$scope.value_id})}};if(!$scope.use_button_header){$scope.right_button={action:$scope.openCart,icon:'ion-ios-cart'}}
$scope.showItem=function(item){$location.path(item.url)};$scope.getScanProductQr=function(){$scope.is_loading=!0;CommerceProProduct.value_id=$stateParams.value_id;$cordovaBarcodeScanner.scan().then(function(scannedData){var qrCode=scannedData.text.replace('sendback:','');$scope.scaned_barcode=qrCode;CommerceProProduct.findByQr(qrCode).then(function(data){if(data.length!==0){$state.go('commercepro-product-view',{value_id:$stateParams.value_id,product_id:data.product.id})}else{Dialog.alert('',$translate.instant('No match found.','commerce_pro'),'OK')}},function(data){$scope.scaned_barcode=null;$scope.is_loading=!1});$scope.is_loading=!1},function(data){$scope.scaned_barcode=null;$scope.is_loading=!1})};$scope.loadContent()}).controller('CommerceProRedirectController',function($ionicHistory,$scope,$state,$stateParams,HomepageLayout,$rootScope){angular.extend($scope,{value_id:$stateParams.value_id,layout:HomepageLayout});$state.go('home').then(function(){if($scope.layout.properties.options.autoSelectFirst){$ionicHistory.nextViewOptions({historyRoot:!0,disableAnimate:!1})}
$state.go('commercepro-category-list',{value_id:$scope.value_id})})});angular.module("starter").controller("CommerceProProductViewController",function($cordovaSocialSharing,Loader,$log,$state,$stateParams,$scope,$translate,Analytics,Application,Dialog,CommerceProCategory,CommerceProCart,CommerceProProduct,$rootScope,Customer){CommerceProProduct.value_id=$stateParams.value_id;CommerceProCart.value_id=$stateParams.value_id;$scope.value_id=$stateParams.value_id;$scope.product_id=$stateParams.product_id;$scope.seller_cust_id=null;$scope.rating=0;$scope.is_rated=!1;$scope.rating_count=0;$scope.social_sharing_active=!1;$scope.is_cart_enable=!1;$scope.is_product_pic_hide=!1;$scope.is_chat_enable=!1;$scope.price_hide_flag=!1;$scope.out_of_stock=!1;$scope.product_quantity=1;$scope.product_max_qty=999;$scope.product_min_qty=1;$scope.product_stock=1;$scope.prd_qty=1;$scope.is_stock_check=!1;$scope.selected_format={id:null};$scope.list_qty=[1,2,3,4,5,6,7,8,9,10];$scope.loadContent=function(){$scope.is_loading=!0;Loader.show();CommerceProProduct.find($scope.product_id).then(function(data){$scope.product=data.product;$scope.product=data.product;$scope.rating=data.product.rating.rating;$scope.rating_count=data.product.rating.rating_count;$scope.is_rated=data.product.rating.is_rated;$scope.taxes_in_price=data.taxes_in_price;$scope.product_quantity=parseInt(data.product.min_qty)>0?parseInt(data.product.min_qty):1;if(parseInt(data.product.max_qty)>0){$scope.product_max_qty=parseInt(data.product.max_qty)}
if(data.product.stock_check){if(parseInt(data.product.max_qty)>data.product.stock){$scope.product_max_qty=parseInt(data.product.stock)}}
if(parseInt(data.product.min_qty)>0){$scope.product_min_qty=parseInt(data.product.min_qty);console.log('product_min_qty')
console.log($scope.product_min_qty)}
if(data.product.stock_check){if(parseInt(data.product.min_qty)>data.product.stock){$scope.product_quantity=parseInt(data.product.stock);$scope.out_of_stock=!0}}
$scope.price_hide_flag=data.price_hide_flag;$scope.is_product_pic_hide=data.is_product_pic_hide;console.log('$scope.price_hide_flagPRp')
console.log($scope.price_hide_flag)
console.log(data)
if(data.is_cart_enable==="1"){$scope.is_cart_enable=!0;$scope.right_button={action:$scope.openCart,icon:"ion-ios-cart"}}
$scope.labels=data.labels;if(data.is_chat_enable==="1"){$scope.is_chat_enable=!0;console.log(data.seller_cus_id);$scope.seller_cust_id=data.seller_cus_id}
Analytics.storeProductOpening($scope.product);$scope.social_sharing_active=($scope.product.social_sharing_active&&$rootScope.isNativeApp);$scope.share=function(){if($scope.is_sharing){return}
$scope.is_sharing=!0;var app_name=Application.app_name;var link=DOMAIN+"/application/device/downloadapp/app_id/"+Application.app_id;var subject="";console.log('$scope.product.picture[0]');console.log($scope.product.picture[0])
var file=($scope.product.picture[0]&&$scope.product.picture[0].url)?$scope.product.picture[0].url:"";var content=$scope.product.name;var message=$translate.instant("Hi. I just found: $1 in the $2 app.").replace("$1",content).replace("$2",app_name);$cordovaSocialSharing.share(message,subject,file,link).then(function(result){$log.debug("CommercePro::product.js","social sharing success");$scope.is_sharing=!1},function(err){$log.debug("CommercePro::product.js",err);$scope.is_sharing=!1})};if($scope.product.formatGroups.length>0){$scope.selected_format.id=$scope.product.formatGroups[0].id}
$scope.page_title=data.page_title}).then(function(){$scope.is_loading=!1;Loader.hide()})};$scope.addProduct=function(){$scope.is_loading=!0;Loader.show();var errors=[];var postParameters={'product_id':$scope.product_id,'category_id':CommerceProCategory.category_id,'qty':$scope.product_quantity,'options':$scope.product.optionsGroups.reduce(function(options,optionsGroup){if(optionsGroup.required&&!optionsGroup.selectedOptionId){errors.push($translate.instant('Option $1 is required.','commerce_pro').replace("$1",optionsGroup.title))}
if(optionsGroup.selectedQuantity<=0||!optionsGroup.selectedQuantity){errors.push($translate.instant('Quantity for option $1 is required.','commerce_pro').replace("$1",optionsGroup.title))}
options[optionsGroup.id]={'option_id':optionsGroup.selectedOptionId,'qty':optionsGroup.selectedQuantity};return options},{}),'choices':$scope.product.choicesGroups.reduce(function(choices,choicesGroup){var selected=[];choicesGroup.options.forEach(function(e,i){if(e.selected){selected.push(e.id)}});if(choicesGroup.required&&!selected.length){errors.push($translate.instant('Option $1 is required.','commerce_pro').replace("$1",choicesGroup.title))}
choices[choicesGroup.id]={'selected_options':selected};return choices},{}),'selected_format':$scope.selected_format.id};if(errors.length<=0){CommerceProCart.addProduct(postParameters).then(function(data){if(data.success){$scope.is_loading=!1;Loader.hide();$scope.openCart()}},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert('',$translate.instant(data.message),'OK')}
$scope.is_loading=!1;$scope.product_quantity=1;$scope.selected_format={id:null};$scope.product.optionsGroups.forEach(function(option){option.selectedOptionId=null;option.selectedQuantity=1});$scope.product.choicesGroups.forEach(function(choice){choice.options.forEach(function(option){option.selected=!1})});Loader.hide()})}else{var message=errors.join("<br/>");Dialog.alert('',message,'OK');$scope.is_loading=!1;Loader.hide()}};$scope.openCart=function(){if(!$scope.is_loading){$state.go("commercepro-cart-view",{value_id:$scope.value_id})}};$scope.changeQuantity=function(qty){var error=[]
if(qty){if(qty>$scope.product.max_qty&&$scope.product.max_qty!="0"){error.push('error');Dialog.alert('',$translate.instant('Max quantity you can order is ')+$scope.product.max_qty,'OK')}
if(qty<$scope.product.min_qty&&$scope.product.min_qty!="0"){error.push('error');Dialog.alert('',$translate.instant('Min quantity you can order is '+$scope.product.min_qty),'OK')}
if($scope.product.stock_check){if(qty>$scope.product.stock){error.push('error');Dialog.alert('',$translate.instant('Product available quantity is '+$scope.product.stock),'OK')}}
if(error.length<=0){$scope.product_quantity=qty}}};$scope.clickEvent=function(obj){if(obj.product_quantity){if(obj.product_quantity==($scope.product.max_qty)&&$scope.product.max_qty!="0"){Dialog.alert('',$translate.instant('You have reached max $1 product quantity allowed.','commerce_pro').replace("$1",$scope.product.max_qty),'OK')}
if(obj.product_quantity==$scope.product.min_qty&&$scope.product.min_qty!="0"){Dialog.alert('',$translate.instant('You have reached min $1 product quantity allowed.','commerce_pro').replace("$1",$scope.product.min_qty),'OK')}
if($scope.product.stock_check){if(obj.product_quantity>=$scope.product.stock){Dialog.alert('',$translate.instant("Product's available stock is $1.",'commerce_pro').replace("$1",$scope.product.stock),'OK')}}}};$scope.openChatWindow=function(){console.log('open chat from product page');if(!Customer.isLoggedIn()){return Customer.loginModal(undefined,function(){$state.go('socialnetworks-chat',{value_id:$scope.value_id,user_id:$scope.seller_cust_id})})}
$state.go('socialnetworks-chat',{value_id:$scope.value_id,user_id:$scope.seller_cust_id})};$scope.onItemRating=function(productID){$state.go('commercepro-product-reviewlist',{value_id:$scope.value_id,product_id:productID})};$scope.loadContent()});angular.module("starter").controller('CommerceProMapController',function($cordovaCamera,$cordovaBarcodeScanner,Loader,$cordovaGeolocation,CommerceProStore,CommerceProProduct,AUTH_EVENTS,$http,$ionicActionSheet,$ionicModal,Dialog,$location,$rootScope,$scope,$stateParams,$timeout,$translate,Application,Url,$state){$scope.$on("connectionStateChange",function(event,args){if(args.isOnline==!0){$scope.loadContent()}});$scope.is_loading=!0;$scope.page_title="Map";$scope.searchText='';Loader.show();$scope.factory=CommerceProStore;$scope.source_id=$stateParams.value_id;$scope.value_id=$stateParams.value_id;CommerceProStore.value_id=$stateParams.value_id;$scope.setupMarkers=function(position){var markers=[];var marker={config:{id:'center'},title:$translate.instant('You are here'),onClick:(function(config){})};marker.icon={url:BASE_URL+"/../app/local/modules/CommercePro/features/commerce_pro/assets/templates/images/youarehere.png",width:25,height:20,}
marker.latitude=position.coords.latitude;marker.longitude=position.coords.longitude;markers.push(marker);for(var i=0;i<$scope.collection.length;i=i+1){var place=$scope.collection[i];var picture='';if(place.picture&&place.picture!=""){picture=place.picture;picture='<img src="'+picture+'" width="70" >'}
var marker={config:{id:angular.copy(place.id)},title:place.title+'<br />'+picture+'<br />'+place.address+'<br />'+place.description+'<br />'+'<i class="ion-android-open"></i>&nbsp;'+$translate.instant('See details')+'</span>',onClick:(function(config){$scope.goToPlace(config.id)})};if(place.latitude&&place.longitude){marker.latitude=place.latitude;marker.longitude=place.longitude}
if($scope.settings.defaultIconImageUrl&&$scope.settings.defaultIconImageUrl!=""){marker.icon={url:$scope.settings.defaultIconImageUrl,width:70,height:44}}
markers.push(marker)}
$scope.map_config={markers:markers,bounds_to_marker:!1}}
$scope.loadContent=function(){CommerceProStore.findAllStores().then(function(data){$scope.page_title=data.page_title;$scope.collection=data.collection;$scope.settings=data.settings;$cordovaGeolocation.getCurrentPosition({enableHighAccuracy:!0,timeout:10000,maximumAge:0}).then(function(position){$scope.setupMarkers(position)},function(){alert($translate.instant('Current location not found.Please make sure GPS is enabled.'))})}).then(function(){$scope.is_loading=!1;Loader.hide()})}
$scope.loadContent();$scope.goToPlace=function(placeId){$state.go('commercepro-store-product-list',{value_id:$scope.value_id,store_id:placeId,})};$scope.getScanProductQr=function(){$scope.is_loading=!0;CommerceProProduct.value_id=$stateParams.value_id;$cordovaBarcodeScanner.scan().then(function(scannedData){var qrCode=scannedData.text.replace('sendback:','');$scope.scaned_barcode=qrCode;CommerceProProduct.findByQr(qrCode).then(function(data){if(data.length!==0){$state.go('commercepro-product-view',{value_id:$stateParams.value_id,product_id:data.product.id})}else{Dialog.alert('',$translate.instant('No match found.','commerce_pro'),'OK')}},function(data){$scope.scaned_barcode=null;$scope.is_loading=!1});$scope.is_loading=!1},function(data){$scope.scaned_barcode=null;$scope.is_loading=!1})};$scope.mapSearch=function(searchText){$rootScope.mapSearchText=searchText;$state.go('commercepro-stores-list',{value_id:$scope.value_id})}});angular.module("starter").service('CommerceProNearbyMaps',function($cordovaGeolocation,$location,$q,$rootScope,$translate,$window,Application){"use strict";var __self={is_loaded:!1,reset:function(){if(service.directionsRenderer){service.directionsRenderer.setPanel(null);service.directionsRenderer.setMap(null)}
for(var i=0;i<service.markers;i++){google.maps.event.removeListener(service.markers[i],'click');service.markers[i].setMap(null)}
service.map=null;service.panel_id=null;service.directionsRenderer=null;service.markers=[];__self.is_loaded=!1},_calculateRoute:function(origin,destination,params,rejectWithResponseAndStatus){var deferred=$q.defer();if(!_.isObject(params))
params={mode:google.maps.DirectionsTravelMode.WALKING,unitSystem:google.maps.UnitSystem.METRIC};if(!_.isObject(params.request))
params.request={};if(!this.directionsService){this.directionsService=new google.maps.DirectionsService()}
var request=_.merge({origin:new google.maps.LatLng(origin.latitude,origin.longitude),destination:new google.maps.LatLng(destination.latitude,destination.longitude),travelMode:params.mode,unitSystem:params.unitSystem},params.request);this.directionsService.route(request,function(response,status){if(status==google.maps.DirectionsStatus.OK){deferred.resolve(response)}else{var errorMessage=$translate.instant(status==="ZERO_RESULTS"?"There is no route available with these informations.":"An unexpected error occurred while calculating the route.");console.error(errorMessage,status);if(rejectWithResponseAndStatus===!0){deferred.reject([response,status])}else{deferred.reject(errorMessage)}}});return deferred.promise},_updateBoundsFromPoints:function(bounds,p){var latitude=parseFloat(p.latitude);var longitude=parseFloat(p.longitude);if(bounds[0][0]===null||bounds[0][0]>latitude){bounds[0][0]=latitude}
if(bounds[1][0]===null||bounds[1][0]<latitude){bounds[1][0]=latitude}
if(bounds[0][1]===null||bounds[0][1]>longitude){bounds[0][1]=longitude}
if(bounds[1][1]===null||bounds[1][1]<longitude){bounds[1][1]=longitude}
return bounds},_extendBounds:function(bounds,margin){if(margin){var latitudeMargin=(bounds[1][0]-bounds[0][0])*margin;if(latitudeMargin===0){latitudeMargin=0.02}
bounds[0][0]-=latitudeMargin;bounds[1][0]+=latitudeMargin;var longitudeMargin=(bounds[1][1]-bounds[0][1])*margin;if(longitudeMargin===0){longitudeMargin=0.01}
bounds[0][1]-=longitudeMargin;bounds[1][1]+=longitudeMargin}
return bounds}};var gmap_callbacks=[];var gmap_script_appended=!1;var gmap_loaded=!1;var _init_called=!1;$window.initGMapCallback=function(){if(gmap_script_appended){gmap_loaded=!0;console.log("Gmap loaded, calling callbacks");while(gmap_callbacks.length>0){var func=gmap_callbacks.shift();if(_.isFunction(func)){func.apply($window,arguments)}}}};var service={USER_INTERACTED_EVENT:"GoogleMaps.UserInteracted",map:null,directionsRenderer:null,panel_id:null,markers:[],lastInfoWindow:null,init:function(){if(typeof GoogleMaps=="undefined"&&!gmap_script_appended){if(_init_called)
return;_init_called=!0;Application.loaded.then(function(){var google_map_src="https://maps.googleapis.com/maps/api/js?libraries=places&key="+Application.googlemaps_key+"&callback=initGMapCallback";var script_already_added=document.querySelector("script[src='"+google_map_src+"']");console.log('is google map script already added=>'+script_already_added);if(!script_already_added){var google_maps=document.createElement('script');google_maps.type="text/javascript";google_maps.src=google_map_src;document.body.appendChild(google_maps);gmap_script_appended=!0}else{console.log(" map script already added hence calling initGMapCallback func directly");gmap_script_appended=!0;$window.initGMapCallback()}})}
if(gmap_loaded){$window.initGMapCallback()}},addCallback:function(func){gmap_callbacks.push(func);service.init()},createMap:function(element,options){if(!angular.isObject(options))
options={};if(__self.is_loaded){__self.reset()}
options=_.merge({zoom:12,mapTypeId:google.maps.MapTypeId.ROADMAP},options);service.map=new google.maps.Map(document.getElementById(element),options);google.maps.event.addListener(service.map,"tilesloaded",function(){console.log("Maps is loaded");__self.is_loaded=!0});var userInteracted=function(event_name){return function(){$rootScope.$broadcast(service.USER_INTERACTED_EVENT,event_name)}};google.maps.event.addListener(service.map,'dblclick',userInteracted("dblclick"));google.maps.event.addListener(service.map,'dragend',userInteracted("dragend"));google.maps.event.addDomListener(service.map.getDiv(),'mousewheel',userInteracted("wheel"),!0);google.maps.event.addDomListener(service.map.getDiv(),'DOMMouseScroll',userInteracted("wheel"),!0);return service.map},setCenter:function(coordinates){if(coordinates){var center=new google.maps.LatLng(coordinates.latitude,coordinates.longitude);return service.map.setCenter(center)}else{return $cordovaGeolocation.getCurrentPosition().then(function(position){service.setCenter(position.coords)})}},setPanelId:function(panel_id){service.panel_id=panel_id},isLoaded:function(){return __self.is_loaded},addMarker:function(marker,index){var latlng=new google.maps.LatLng(marker.latitude,marker.longitude);var icon=null;if(marker.icon&&marker.icon.url){var width=marker.icon.width?marker.icon.width:95;var height=marker.icon.height?marker.icon.height:49;icon={url:marker.icon.url,scaledSize:new google.maps.Size(width,height)}}
var options=_.merge({position:latlng,map:service.map,icon:icon},marker.markerOptions);var mapMarker=new google.maps.Marker(options);if(marker.title){var marker_id='info-marker-'+index;var infoWindowContent='<div id="'+marker_id+'"><p style="color:black;">';if(marker.link){infoWindowContent+='<a href="'+marker.link+'">'}
infoWindowContent+=marker.title;if(marker.link){infoWindowContent+='</a>'}
var markerHasAction=_.isObject(marker.action)&&_.isString(marker.action.label)&&_.isFunction(marker.action.onclick);if(markerHasAction){var id="map_marker_infowindow_action_"+Math.ceil((+new Date())*Math.random());infoWindowContent+='<div style="margin-top: 15px; "><button id="'+id+'" class="button button-custom">'+marker.action.label+'</button></div>'}
infoWindowContent+='</p></div>';var infoWindows=new google.maps.InfoWindow({content:infoWindowContent});if(markerHasAction){google.maps.event.addListener(infoWindows,'domready',function(){document.getElementById(id).addEventListener('click',marker.action.onclick)})}
google.maps.event.addListener(mapMarker,'click',function(){if(service.lastInfoWindow!==null){service.lastInfoWindow.close()}
infoWindows.open(service.map,mapMarker);service.lastInfoWindow=infoWindows;if(marker.hasOwnProperty('onClick')&&(typeof marker.onClick==='function')){setTimeout(function(){google.maps.event.addDomListener(document.getElementById(marker_id),'click',function(event){marker.onClick(angular.extend({},marker.config))})},500)}})}
if(marker.is_centered){service.setCenter(marker)}
if(+index<0){service.markers.push(mapMarker)}else{service.markers.splice(index,0,mapMarker)}
return mapMarker},removeMarker:function(mapMarker){var index=service.markers.indexOf(mapMarker);if(index>=0){service.markers[index].setMap(null);service.markers.splice(index,1);return!0}
return!1},replaceMarker:function(mapMarker,marker){if(service.removeMarker(mapMarker)){return service.addMarker(marker)}
return!1},addRoute:function(route,custom_directions_renderer,custom_panel_div_id){var renderer=null;if(_.isObject(custom_directions_renderer)&&_.isFunction(custom_directions_renderer.setDirections)){renderer=custom_directions_renderer}else{if(!service.directionsRenderer){service.directionsRenderer=new google.maps.DirectionsRenderer()}
renderer=service.directionsRenderer}
renderer.setMap(service.map);renderer.setDirections(route);var panelDiv=document.getElementById(custom_panel_div_id||service.panel_id);if(panelDiv){renderer.setPanel(panelDiv)}},fitToBounds:function(bounds){var sw=new google.maps.LatLng(bounds.latitudeMin,bounds.longitudeMin);var ne=new google.maps.LatLng(bounds.latitudeMax,bounds.longitudeMax);var mapBounds=new google.maps.LatLngBounds(sw,ne);service.map.fitBounds(mapBounds)},geocode:function(address){var deferred=$q.defer();if(!this.geocoder){this.geocoder=new google.maps.Geocoder()}
this.geocoder.geocode({'address':address},function(results,status){if(status==google.maps.GeocoderStatus.OK){var latitude=results[0].geometry.location.lat();var longitude=results[0].geometry.location.lng();deferred.resolve({latitude:latitude,longitude:longitude})}else{var errorMessage=$translate.instant("The address you're looking for does not exist.");console.error(errorMessage);deferred.reject(errorMessage)}});return deferred.promise},reverseGeocode:function(position){var deferred=$q.defer();if(!this.geocoder){this.geocoder=new google.maps.Geocoder()}
var latlng={lat:position.latitude,lng:position.longitude};this.geocoder.geocode({'location':latlng},function(results,status){if(status==google.maps.GeocoderStatus.OK){deferred.resolve(results)}else{var errorMessage=$translate.instant("The address you're looking for does not exists.");deferred.reject(errorMessage)}});return deferred.promise},calculateRoute:function(origin,destination,params,rejectWithResponseAndStatus){var deferred=$q.defer();if(origin){__self._calculateRoute(origin,destination,params,rejectWithResponseAndStatus).then(function(route){deferred.resolve(route)},function(err){deferred.reject(err)})}else{$cordovaGeolocation.getCurrentPosition().then(function(position){__self._calculateRoute(position.coords,destination,params,rejectWithResponseAndStatus).then(function(route){deferred.resolve(route)},function(err){deferred.reject(err)})},function(err){if(angular.isObject(err)&&err.code===1&&angular.isString(err.message)&&err.message.indexOf("secure origin")){deferred.reject("Your location could not be found because your application doesn't use SSL.")}
deferred.reject("gps_disabled")})}
return deferred.promise},getBoundsFromPoints:function(points,margin){if(points){var bounds=[[null,null],[null,null]];points.reduce(function(output,p){if(!p.latitude){console.warn('Invalid latitude.')}
if(!p.longitude){console.warn('Invalid longitude.')}
bounds=__self._updateBoundsFromPoints(bounds,p);return output},[]);if(points.length!==0&&margin){bounds=__self._extendBounds(bounds,margin)}
return{latitudeMin:bounds[0][0],latitudeMax:bounds[1][0],longitudeMin:bounds[0][1],longitudeMax:bounds[1][1]}}
return null}};service.init();return service});angular.module("starter").directive('storesNearbyMaps',function(){return{restrict:'A',scope:{map:"=",config:"="},controller:function($scope,CommerceProNearbyMaps){CommerceProNearbyMaps.addCallback(function(){$scope.map=CommerceProNearbyMaps.createMap("nearby-store-google-maps",{zoom:12});if($scope.config.coordinates){if(!$scope.config.coordinates.origin||((!$scope.config.coordinates.origin.latitude||!$scope.config.coordinates.origin.longitude)&&!$scope.config.coordinates.origin.address)){console.error("An origin (latitude / longitude or address) is required to use Maps");return}
if(!$scope.config.coordinates.destination||((!$scope.config.coordinates.destination.latitude||!$scope.config.coordinates.destination.longitude)&&!$scope.config.coordinates.destination.address)){console.error("A destination (latitude / longitude or address) is required to use Maps");return}
CommerceProNearbyMaps.calculateRoute($scope.config.coordinates.origin,$scope.config.coordinates.destination).then(function(route){CommerceProNearbyMaps.addRoute(route)})}
if($scope.config.markers&&$scope.config.markers.constructor===Array){for(var i=0;i<$scope.config.markers.length;i++){var marker=$scope.config.markers[i];CommerceProNearbyMaps.addMarker(marker)}
if($scope.config.bounds_to_marker){var bounds=GoogleMaps.getBoundsFromPoints($scope.config.markers);CommerceProNearbyMaps.fitToBounds(bounds)}}
CommerceProNearbyMaps.setCenter()})}}});angular.module("starter").controller("CommerceProStoreController",function($cordovaCamera,$cordovaBarcodeScanner,Loader,$location,$scope,$state,$stateParams,CommerceProStore,CommerceProCart,Customer,$translate,Modal,$rootScope,Dialog,CommerceProProduct,$cordovaGeolocation,Location,$ionicScrollDelegate,$timeout,Lightbox){$scope.is_loading=!0;Loader.show();$scope.is_show=!0;$scope.collection_all=[];$scope.list_type='1';$scope.type='';$scope.is_cart_enable=!1;$scope.price_hide_flag=!1;$scope.is_chat_enable=!1;$scope.is_product_pic_hide=!1;$scope.seller_cust_id=null;$scope.viewspage="listView";$scope.factory=CommerceProStore;$scope.collection=[];$scope.category_all=!0;$scope.sub_category_all=!0;$scope.collection_is_empty=!0;$scope.location={latitude:0,longitude:0};$scope.list_qty=[1,2,3,4,5,6,7,8,9,10];var factory_new={events:[],customer:null,modal:null,options_modal:null}
var store_modal={events:[],modal:null,options_modal:null}
CommerceProStore.category_id=null;CommerceProStore.store_id=null;if($stateParams.store_id){CommerceProStore.store_id=$stateParams.store_id}
if($scope.store_id){CommerceProStore.store_id=$scope.store_id}
CommerceProStore.value_id=$stateParams.value_id;CommerceProStore.type="";$scope.value_id=$stateParams.value_id;$scope.use_button_header=!1;if(Customer.isLoggedIn()&&!CommerceProStore.store_id){$scope.use_button_header=!0}
if($rootScope.mapSearchText){$scope.filter_search=$rootScope.mapSearchText;$rootScope.mapSearchText=''}
$scope.infoModal=function(obj){var modalScope=$rootScope.$new(!0);console.log('obj')
console.log(obj)
var layout='./features/commerce_pro/assets/templates/l1/store_info_modal.html';return Modal.fromTemplateUrl(layout,{scope:angular.extend(modalScope,{store:obj}),animation:'slide-in-up'}).then(function(modal){store_modal.options_modal=modal;store_modal.options_modal.show();return modal})}
$scope.onSelectChange=function(keyEvent){const val=document.getElementById("del_type").value;console.log('val')
console.log(val)
console.log("Loading Storescollection_all")
console.log($scope.collection_all)
if(val&&val.trim()!==''){$scope.collection=$scope.collection_all.filter(term=>{console.log(term)
if(val.trim()=="home_delivery"&&!term.is_redius_set){return term.is_delivery.toLowerCase().indexOf(val.trim())>-1}else if(val.trim()=="home_delivery"&&term.is_redius_set){return term.is_delivery.toLowerCase().indexOf(val.trim())>-1&&term.delivery_area>term.distance}else if(val.trim()=="in_store")
return term.is_pickup.toLowerCase().indexOf(val.trim())>-1})}else{$scope.collection=$scope.collection_all}}
$scope.loadContent=function(){CommerceProStore.findAll($scope.location).then(function(data){$scope.price_hide_flag=data.price_hide_flag;$scope.is_product_pic_hide=data.is_product_pic_hide;$scope.show_search=data.show_search;$scope.collection=data.collection;$scope.collection_all=data.collection;console.log("Loading Stores")
console.log($scope.collection_all)
$scope.collection_is_empty=$scope.collection.length>0;$scope.cover=data.cover;if(CommerceProStore.store_id){var distance=$scope.calculateDistance($scope.location.latitude,$scope.location.longitude,$scope.cover.latitude,$scope.cover.longitude);var distanceUnit="km";$scope.cover.distance=Math.round(distance*100)/100+' '+distanceUnit}
$scope.page_title=data.page_title;if(data.is_cart_enable==="1"){$scope.is_cart_enable=!0}
if(data.is_chat_enable&&CommerceProStore.store_id){$scope.is_chat_enable=!0;$scope.seller_cust_id=data.cover.seller_cus_id}
$scope.categories=data.categories;$scope.sub_categories=data.sub_categories;$scope.labels=$rootScope.CommercePro_labels;var collection_class='all-stores';if(CommerceProStore.store_id){collection_class='store-products'}
$timeout(function(){Lightbox.run("."+collection_class)},200)}).then(function(){$scope.is_loading=!1;Loader.hide()});CommerceProCart.value_id=$stateParams.value_id;CommerceProCart.find().then(function(data){try{$scope.cartItems=data.cart.lines.length}catch(e){$scope.cartItems=0}})};$scope.filterCategoryStores=function(category_id){if(!$scope.is_loading){if(category_id){$scope.category_all=!1}else{$scope.category_all=!0}
CommerceProStore.category_id=category_id;$scope.loadContent()}};$scope.filterSubCategoryProducts=function(sub_category_id){if(!$scope.is_loading){if(sub_category_id){$scope.sub_category_all=!1}else{$scope.sub_category_all=!0}
CommerceProStore.sub_category_id=sub_category_id;$scope.loadContent()}};$scope.addToCart=function(product){console.log('add to cart'+product.id);if(!$scope.is_loading){var options_required=!1;for(var key=0;key<product.optionsGroups.length;key++){if(product.optionsGroups[key].required){options_required=!0;break}}
if(!options_required){for(var key=0;key<product.choicesGroups.length;key++){if(product.choicesGroups[key].required){options_required=!0;break}}}
product.selected_format={id:null};if(product.formatGroups.length>0){options_required=!0;product.selected_format.id=product.formatGroups[0].id}
if(options_required){console.log('required');factory_new.openOptionsModal(product)}else{$scope.validateAddProduct(product)}}};$scope.$on("commercepro.closeModal",function(){factory_new.options_modal.hide();$scope.loadContent()});$scope.$on("commercepro.closeStoreModal",function(){store_modal.options_modal.hide()});factory_new.openOptionsModal=function(product){console.log('A');if($rootScope.isNotAvailableOffline()){return!1}
var modalScope=$rootScope.$new(!0);modalScope.$on('modal.shown',function(){console.log('modal shown');var addProductSubscriber=modalScope.$on('commercepro.validateOptions',function(){console.log('modal shown after close'+product.selected_format.id);$scope.validateAddProduct(product)});factory_new.login_modal_hidden_subscriber=modalScope.$on('modal.hidden',function(){factory_new.login_modal_hidden_subscriber();addProductSubscriber()})});var layout='./features/commerce_pro/assets/templates/l1/product_options_modal.html';return Modal.fromTemplateUrl(layout,{scope:angular.extend(modalScope,{product:product,list_qty:$scope.list_qty}),animation:'slide-in-up'}).then(function(modal){factory_new.options_modal=modal;factory_new.options_modal.show();return modal})};$scope.validateAddProduct=function(product){var errors=[];var postParameters={'product_id':product.id,'qty':1,'options':product.optionsGroups.reduce(function(options,optionsGroup){if(optionsGroup.required&&!optionsGroup.selectedOptionId){errors.push($translate.instant('Option $1 is required.','commerce_pro').replace("$1",optionsGroup.title))}
if(optionsGroup.selectedQuantity<=0||!optionsGroup.selectedQuantity){errors.push($translate.instant('Quantity for option $1 is required.','commerce_pro').replace("$1",optionsGroup.title))}
options[optionsGroup.id]={'option_id':optionsGroup.selectedOptionId,'qty':optionsGroup.selectedQuantity};return options},{}),'choices':product.choicesGroups.reduce(function(choices,choicesGroup){var selected=[];choicesGroup.options.forEach(function(e,i){if(e.selected){selected.push(e.id)}});if(choicesGroup.required&&!selected.length){errors.push($translate.instant('Option $1 is required.','commerce_pro').replace("$1",choicesGroup.title))}
choices[choicesGroup.id]={'selected_options':selected};return choices},{}),'selected_format':product.selected_format.id};if(errors.length<=0){CommerceProCart.addProduct(postParameters).then(function(data){if(data.success){$scope.is_loading=!1;$scope.cartItems=$scope.cartItems+1;if(factory_new.options_modal){factory_new.options_modal.hide()}
Dialog.alert('',$translate.instant('Product added to cart successfully.','commerce_pro'),'OK')}},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert('',$translate.instant(data.message),'OK')}
$scope.is_loading=!1;product.selected_format={id:null};product.optionsGroups.forEach(function(option){option.selectedOptionId=null;option.selectedQuantity=1});product.choicesGroups.forEach(function(choice){choice.options.forEach(function(option){option.selected=!1})});Loader.hide()})}else{var message=errors.join("<br/>");Dialog.alert('',message,'OK');$scope.is_loading=!1}};$scope.openCart=function(){if(!$scope.is_loading){$state.go('commercepro-cart-view',{value_id:$scope.value_id})}};$scope.openHistory=function(){if(!$scope.is_loading){$state.go('commercepro-sales-history',{value_id:$scope.value_id})}};if(!$scope.use_button_header){$scope.right_button={action:$scope.openCart,icon:'ion-ios-cart'}}
$scope.openMap=function(){if(!$scope.is_loading){$state.go('commercepro-map-view',{value_id:$scope.value_id})}};$scope.getScan=function(){$scope.is_loading=!0;$cordovaBarcodeScanner.scan().then(function(scannedData){var qrCode=scannedData.text.replace('sendback:','');$scope.scaned_store_id=qrCode;console.log("scaned"+qrCode)
$state.go('commercepro-store-product-list',{value_id:$stateParams.value_id,store_id:$scope.scaned_store_id});console.log("scanedId"+$scope.scaned_store_id)
$scope.is_loading=!1},function(data){$scope.scaned_store_id=null;$scope.is_loading=!1})};$scope.getScanProductQr=function(){$scope.is_loading=!0;CommerceProProduct.value_id=$stateParams.value_id;$cordovaBarcodeScanner.scan().then(function(scannedData){var qrCode=scannedData.text.replace('sendback:','');$scope.scaned_barcode=qrCode;CommerceProProduct.findByQr(qrCode).then(function(data){if(data.length!==0){$state.go('commercepro-product-view',{value_id:$stateParams.value_id,product_id:data.product.id})}else{Dialog.alert('',$translate.instant('No match found.','commerce_pro'),'OK')}},function(data){$scope.scaned_barcode=null;$scope.is_loading=!1});$scope.is_loading=!1},function(data){$scope.scaned_barcode=null;$scope.is_loading=!1})};$scope.openChatWindow=function(){if(!Customer.isLoggedIn()){return Customer.loginModal(undefined,function(){$state.go('socialnetworks-chat',{value_id:$scope.value_id,user_id:$scope.seller_cust_id})})}
$state.go('socialnetworks-chat',{value_id:$scope.value_id,user_id:$scope.seller_cust_id})};$scope.showItem=function(item){console.log("redirect")
$location.path(item.url)};$scope.calculateDistance=function(lat1,lon1,lat2,lon2){var radlat1=Math.PI*lat1/180;var radlat2=Math.PI*lat2/180;var theta=lon1-lon2;var radtheta=Math.PI*theta/180;var dist=Math.sin(radlat1)*Math.sin(radlat2)+Math.cos(radlat1)*Math.cos(radlat2)*Math.cos(radtheta);dist=Math.acos(dist);dist=dist*180/Math.PI;dist=dist*60*1.1515;dist=dist*1.609344;return dist};console.log('disable_location='+$rootScope.CommercePro_labels.disable_location);if($rootScope.CommercePro_labels.disable_location==="1"){$scope.loadContent()}else{Location.getLocation({timeout:10000},!0).then(function(position){console.log('fetching location');$scope.location.latitude=position.coords.latitude;$scope.location.longitude=position.coords.longitude},function(){console.log('Current location not found.Please make sure GPS is enabled.');$scope.location.latitude=0;$scope.location.longitude=0}).then(function(){console.log('Aftre trying for currentr location, load content..');$scope.loadContent()})}
$scope.makeHeaderFix=function(){var top=$ionicScrollDelegate.getScrollPosition().top;console.log('TOP='+top);if(top>=200){console.log('header fixed');if($scope.categories.length>0){$('#prod_cat_list').show();$timeout(function(){Lightbox.run("#prod_cat_list")},200)}}else{console.log('on TOP'+$('#prod_cat_list').css('display'));if($('#prod_cat_list').css('display')!='none')
$('#prod_cat_list').hide()}}}).controller("CommerceProPListController",function(Loader,$location,$scope,$state,$stateParams,CommerceProStore,CommerceProCart,Customer,$translate,$timeout,Lightbox,CommerceProProduct,$cordovaBarcodeScanner){$scope.is_loading=!0;$scope.is_back_btn_visible=!0;if($stateParams.store_id=="undefined"){$scope.is_back_btn_visible=!1}
Loader.show();$scope.factory=CommerceProStore;$scope.collection=[];$scope.collection_is_empty=!0;$scope.is_cart_enable=!1;$scope.is_chat_enable=!1;$scope.price_hide_flag=!1;$scope.is_product_pic_hide=!1;CommerceProStore.value_id=$stateParams.value_id;CommerceProStore.store_id=$stateParams.store_id;$scope.value_id=$stateParams.value_id;$scope.use_button_header=!1;if(Customer.isLoggedIn()&&!$stateParams.store_id){$scope.use_button_header=!0}
$scope.loadContent=function(){CommerceProStore.findAllPro().then(function(data){$scope.price_hide_flag=data.price_hide_flag;$scope.is_product_pic_hide=data.is_product_pic_hide;$scope.show_search=data.show_search;$scope.collection=data.collection;console.log("store_p")
$scope.collection_is_empty=$scope.collection.length>0;$scope.cover=data.cover;$scope.page_title=data.page_title;if(data.is_cart_enable==="1"){$scope.is_cart_enable=!0}
if(data.is_chat_enable==="1"){$scope.is_chat_enable=!0}
$timeout(function(){Lightbox.run(".product-list")},200)}).then(function(){$scope.is_loading=!1;Loader.hide()});CommerceProCart.value_id=$stateParams.value_id;CommerceProCart.find().then(function(data){try{$scope.cartItems=data.cart.lines.length}catch(e){$scope.cartItems=0}})};$scope.openCart=function(){if(!$scope.is_loading){$state.go('commercepro-cart-view',{value_id:$scope.value_id})}};$scope.openHistory=function(){if(!$scope.is_loading){$state.go('commercepro-sales-history',{value_id:$scope.value_id})}};if(!$scope.use_button_header){$scope.right_button={action:$scope.openCart,icon:'ion-ios-cart'}}
$scope.showItem=function(item){$location.path(item.url)};$scope.getScanProductQr=function(){$scope.is_loading=!0;CommerceProProduct.value_id=$stateParams.value_id;$cordovaBarcodeScanner.scan().then(function(scannedData){var qrCode=scannedData.text.replace('sendback:','');$scope.scaned_barcode=qrCode;CommerceProProduct.findByQr(qrCode).then(function(data){if(data.length!==0){$state.go('commercepro-product-view',{value_id:$stateParams.value_id,product_id:data.product.id})}else{Dialog.alert('',$translate.instant('No match found.','commerce_pro'),'OK')}},function(data){$scope.scaned_barcode=null;$scope.is_loading=!1});$scope.is_loading=!1},function(data){$scope.scaned_barcode=null;$scope.is_loading=!1})};$scope.loadContent()}).controller('CommerceProRedirectController',function($ionicHistory,$scope,$state,$stateParams,HomepageLayout,$rootScope){angular.extend($scope,{value_id:$stateParams.value_id,layout:HomepageLayout});$state.go('home').then(function(){if($scope.layout.properties.options.autoSelectFirst){$ionicHistory.nextViewOptions({historyRoot:!0,disableAnimate:!1})}
var state_name='commercepro-category-list';if($rootScope.success_state){state_name=$rootScope.success_state}
console.log('order placed, go to state='+state_name);$state.go(state_name,{value_id:$scope.value_id})})}).controller('productOptionsModalController',function($scope,$state,$stateParams,$rootScope){$scope.closeModal=function(){$rootScope.$broadcast("commercepro.closeModal")};$scope.validateOptions=function(){$rootScope.$broadcast("commercepro.validateOptions")}}).controller('storetInfoModalController',function($scope,$state,$stateParams,$rootScope){$scope.closeModal=function(){$rootScope.$broadcast("commercepro.closeStoreModal")}});angular.module('starter').controller('CommerceProSalesConfirmationViewController',function(Loader,$location,$rootScope,$scope,$state,$stateParams,$timeout,$translate,$window,Analytics,Application,Customer,Dialog,CommerceProCart,CommerceProSalesPayment){angular.extend($scope,{is_loading:!0,page_title:$translate.instant('Review','commerce_pro'),value_id:$stateParams.value_id});Loader.show();CommerceProCart.value_id=$stateParams.value_id;CommerceProSalesPayment.value_id=$stateParams.value_id;$scope.checkStock=function(){$scope.stock={};if($scope.cart.lines.length>0&&$scope.cart.stockCheck){for(var line of $scope.cart.lines){var productIdkey=line.product.id;$scope.stock[productIdkey]=$scope.stock[productIdkey]!=undefined?$scope.stock[productIdkey]+line.qty:line.qty;if($scope.stock[productIdkey]>line.available_stock){$state.go('commercepro-cart-view',{value_id:$stateParams.value_id})}}}}
$scope.loadContent=function(){$scope.guest_mode=Customer.guest_mode;CommerceProCart.compute().then(function(computation){CommerceProCart.find().then(function(data){$scope.cart=data.cart;$scope.cart.commerce_pro.price_hide_flag=data.cart.commerce_pro.price_hide_flag=='1'?!0:!1;$scope.cart.discount_message=computation.message;$scope.cart.discount=computation.discount;CommerceProSalesPayment.findOnlinePaymentUrl().then(function(onlinePaymentData){$scope.onlinePaymentUrl=onlinePaymentData.url;$scope.form_url=onlinePaymentData.form_url;$scope.checkStock();$scope.right_button={action:$scope.validate,label:$translate.instant('Validate','commerce_pro')}}).then(function(){Loader.hide();if(computation&&angular.isDefined(computation.message)&&computation.show_message){Dialog.alert('',computation.message,'OK')}
$scope.is_loading=!1})},function(){$scope.is_loading=!1;Loader.hide()})},function(){Loader.hide();$scope.is_loading=!1})};$scope.validate=function(){var notes=document.getElementById("notes").value;console.log('note')
console.log(notes)
CommerceProSalesPayment.notes=notes||'';sessionStorage.setItem('mcommerce-notes',$scope.notes||'');if($scope.onlinePaymentUrl){if(!isNativeApp){$window.location=$scope.onlinePaymentUrl}else{var browser=$window.open($scope.onlinePaymentUrl,$rootScope.getTargetForLink(),'location=yes');var nextState='commercepro-sales-error';var stepNext=function(){browser.close();$state.go(nextState,{value_id:$stateParams.value_id})};browser.addEventListener('loadstart',function(event){switch(!0){case/(commercepro\/mobile_sales_success)/.test(event.url):nextState='commercepro-sales-success';stepNext();break;case/(commercepro\/mobile_sales_cancel)/.test(event.url):nextState='commercepro-sales-confirmation-cancel';stepNext();break;case/(commercepro\/mobile_sales_error)/.test(event.url):nextState='commercepro-sales-error';stepNext();break}})}}else if($scope.form_url){$location.path($scope.form_url)}else{if($scope.is_loading){return}
var isRedirectedToGateway=!1;if($scope.cart.paymentMethodCode=="bank"){Dialog.alert('',$scope.cart.paymentSetting.message,$translate.instant('OK')).then(function(){$state.go('commercepro-sales-success',{value_id:$stateParams.value_id})})}
if($scope.cart.paymentMethodCode=="ewallet"){isRedirectedToGateway=!0;$state.go("commercepro-sales-ewallet",{value_id:$stateParams.value_id},{reload:!0})}
if(!isRedirectedToGateway){$scope.is_loading=!0;Loader.show();CommerceProSalesPayment.validatePayment().then(function(data){var products=[];angular.forEach($scope.cart.lines,function(value,key){var product=value.product;product.category_id=value.category_id;product.quantity=value.qty;products.push(product)});Analytics.storeProductSold(products);console.log($scope.cart)
$state.go('commercepro-sales-success',{value_id:$stateParams.value_id})},function(data){Dialog.alert('',data.message,$translate.instant('OK'))}).then(function(){$scope.is_loading=!1;Loader.hide()})}}};$scope.loadContent()});angular.module('starter').controller('CommerceProSalesConfirmationCancelController',function($state,$stateParams,$translate,Dialog){Dialog.alert('','The payment has been cancelled, something wrong happened? Feel free to contact us.',$translate.instant('OK')).then(function(){$state.go('commercepro-sales-confirmation',{value_id:$stateParams.value_id})})});angular.module('starter').controller('CommerceProSalesCustomerViewController',function(Loader,$state,$stateParams,$scope,$translate,$rootScope,CommerceProCart,CommerceProSalesCustomer,CommerceProSalesDelivery,Customer,Dialog,Application,SB){$scope.hasguestmode=!1;angular.extend($scope,{dateTime:{format:"MM/DD/YYYY",title:$translate.instant('Date of birth','commerce_pro')}});$scope.signupEnabled=function(){return Application.myAccount.settings.enable_registration};$scope.customer_login=function(){Customer.display_account_form=!1;Customer.loginModal($scope)};$scope.customer_signup=function(){Customer.display_account_form=!0;Customer.loginModal($scope)};$scope.customer_guestmode=function(){Loader.show();var currentTs=Date.now();var guestmail='guest'+currentTs+(parseInt(Math.random()*1000,10))+'@guest.com';Customer.register({civility:'m',firstname:'Guest',lastname:'Guest',email:guestmail,password:parseInt(Math.random()*10000000000,10),privacy_policy:!0}).then(function(){$scope.is_logged_in=!0;Customer.guest_mode=!0;$scope.loadContent()}).then(function(){$scope.is_loading=!1;Loader.hide()})};$scope.$on(SB.EVENTS.AUTH.loginSuccess,function(){$scope.is_logged_in=!0;$scope.loadContent()});$scope.$on(SB.EVENTS.AUTH.logoutSuccess,function(){$scope.is_logged_in=!1});$scope.is_loading=!0;Loader.show();$scope.is_logged_in=Customer.isLoggedIn();CommerceProCart.value_id=$stateParams.value_id;CommerceProSalesCustomer.value_id=$stateParams.value_id;$scope.value_id=$stateParams.value_id;$scope.page_title=$translate.instant('My information','commerce_pro');$scope.loadContent=function(){CommerceProSalesCustomer.hasGuestMode().then(function(dataGuestMode){if(dataGuestMode.success&&dataGuestMode.activated){$scope.hasguestmode=!0}
CommerceProSalesCustomer.find().then(function(data){$scope.customer=data.customer;$scope.settings=data.settings}).then(function(){$scope.is_loading=!1;Loader.hide()})},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert('Error',data.message,'OK')}}).then(function(){$scope.is_loading=!1;Loader.hide()})};$scope.goToDeliveryPage=function(){$state.go('commercepro-sales-delivery',{value_id:$stateParams.value_id})};$scope.updateCustomerInfos=function(){$rootScope.loginFeature=!0;$rootScope.loginFeatureBack=!1;$scope.is_loading=!0;Loader.show();CommerceProSalesCustomer.updateCustomerInfos({customer:$scope.customer}).then(function(data){$scope.customer=data.customer;if($rootScope.success_state==='bookingpro-home'){CommerceProCart.value_id=$stateParams.value_id;CommerceProSalesDelivery.value_id=$stateParams.value_id;CommerceProCart.find().then(function(data){$scope.cart=data.cart},function(){$scope.is_loading=!1;Loader.hide()});CommerceProSalesDelivery.findStore().then(function(data){$scope.clients_calculate_change_form_is_visible=data.clients_calculate_change;$scope.store_setting=data.store_setting;$scope.selectedStore=data.store;$scope.label_array=data.labels}).then(function(){console.log('att='+$scope.selectedStore.deliveryMethods[0].id);var postParameters={'delivery_method_id':$scope.selectedStore.deliveryMethods[0].id,'paid_amount':null,'store_id':$scope.selectedStore.id,'delivery_time':'0000-00-00 00:00:00','pickup_time':'0000-00-00 00:00:00','submitted_number':null};CommerceProSalesDelivery.updateDeliveryInfos(postParameters).then(function(data){$scope.goToPaymentPage()},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert("",data.message,"OK")}}).then(function(){})})}else{$scope.goToDeliveryPage()}},function(data){$scope.is_loading=!1;Loader.hide();if(data&&angular.isDefined(data.message)){Dialog.alert('Error',data.message,'OK')}})};$scope.goToPaymentPage=function(){$state.go("commercepro-sales-payment",{value_id:$stateParams.value_id})};$scope.right_button={action:$scope.updateCustomerInfos,label:$translate.instant('Next','commerce_pro')};$scope.loadContent()});angular.module("starter").controller("CommerceProSalesDeliveryOfferController",function(Loader,$scope,$stateParams,$state,$translate,CommerceProCart,CommerceProSalesDeliveryOffers,Dialog,$timeout,$ionicHistory){$scope.page_title=$translate.instant('Delivery Offers','commerce_pro');CommerceProCart.value_id=$stateParams.value_id;$scope.shippingOffers=[];CommerceProSalesDeliveryOffers.value_id=$stateParams.value_id;$scope.value_id=$stateParams.value_id;$scope.loadContent=function(){$scope.is_loading=!0;Loader.show();CommerceProCart.find().then(function(data){$scope.cart=data.cart;CommerceProSalesDeliveryOffers.findOffers().then(function(offers){$scope.shippingOffers=offers.response.offers}).then(function(){$scope.is_loading=!1;Loader.hide()})},function(){$scope.is_loading=!1;Loader.hide()})};$scope.selectShippingMethod=function(cart,shipping){$scope.cart.shipping=shipping;$scope.cart.shippingMethodId=shipping.product.id;$scope.cart.shippingTotal=shipping.total_price.amount;if($scope.cart.shippingMethodId!=""){$scope.updateShippingInfos(!0)}};$scope.updateShippingInfos=function(isClicked=!1){if(!$scope.is_loading){$scope.is_loading=!0;Loader.show();if(!isClicked&&$scope.cart.shippingMethodId!==0){$scope.is_loading=!1;Loader.hide();$scope.goToPaymentPage()}
var postParameters={'shipping_method_id':$scope.cart.shippingMethodId,'price':$scope.cart.shippingTotal,'offer':$scope.cart.shipping,};CommerceProSalesDeliveryOffers.updateOffersInfos(postParameters).then(function(data){$scope.goToPaymentPage()},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert("",data.message,"OK")}}).then(function(){$scope.is_loading=!1;Loader.hide()})}};$scope.goToPaymentPage=function(){$state.go("commercepro-sales-payment",{value_id:$stateParams.value_id})};$scope.right_button={action:$scope.updateShippingInfos,label:$translate.instant('Next','commerce_pro')};$scope.loadContent()});angular.module("starter").controller("CommerceProSalesDeliveryViewController",function(Loader,$scope,$stateParams,$state,$translate,CommerceProCart,CommerceProSalesDelivery,Dialog,$timeout,$ionicHistory){angular.extend($scope,{deliveryTime:{minDate:0,format:"",title:$translate.instant('Delivery Time','commerce_pro')},pickupTime:{minDate:0,format:"",title:$translate.instant('Pickup Time','commerce_pro')}});$scope.page_title=$translate.instant('Delivery','commerce_pro');$scope.label_array=null;CommerceProCart.value_id=$stateParams.value_id;CommerceProSalesDelivery.value_id=$stateParams.value_id;$scope.value_id=$stateParams.value_id;$scope.deliveryMethodCodeKey="";$scope.clients_calculate_change_form_is_visible=!1;$scope.loadContent=function(){$scope.is_loading=!0;Loader.show();CommerceProCart.find().then(function(data){$scope.cart=data.cart;$scope.cart.delivery_method_extra_client_amount=$scope.cart.paid_amount?parseFloat($scope.cart.paid_amount):$scope.cart.total;$scope.cart.delivery_method_extra_amount_due=($scope.cart.delivery_amount_due)?parseFloat($scope.cart.delivery_amount_due):0;$scope.deliveryMethodCodeKey=data.cart.deliveryMethodCode;if(data.cart.deliveryMethodCode=='home_delivery'&&data.cart.deliveryMethodId!=""){$scope.cart.delivery_time=data.cart.delivery_time;$scope.is_visible_delivery_time=!0;$scope.is_visible_pickup_time=!1;$scope.is_visible_submitted_number=!1}
if(data.cart.deliveryMethodCode=="in_store"||data.cart.deliveryMethodCode=="carry_out"&&data.cart.deliveryMethodId!=""){$scope.cart.pickup_time=data.cart.pickup_time;$scope.is_visible_pickup_time=!0;$scope.is_visible_delivery_time=!1;$scope.is_visible_submitted_number=!1}
console.log(data.cart.deliveryMethodCode)
console.log('data.cart.deliveryMethodCode')
if(data.cart.deliveryMethodCode=="on_location"&&data.cart.deliveryMethodId!=""){$scope.cart.submitted_number=data.cart.submitted_number;$scope.is_visible_pickup_time=!1;$scope.is_visible_delivery_time=!1;$scope.is_visible_submitted_number=!0}
CommerceProSalesDelivery.findStore().then(function(data){$scope.clients_calculate_change_form_is_visible=data.clients_calculate_change;$scope.store_setting=data.store_setting;if($scope.store_setting.is_delivery_time==="hidden")
$scope.is_visible_delivery_time=!1;if($scope.store_setting.is_pickup_time==="hidden")
$scope.is_visible_pickup_time=!1;$scope.selectedStore=data.store;$scope.label_array=data.labels;$scope.calculateAmountDue();if(data.store.deliveryMethods.length==0){$scope.submitDefaultData()}}).then(function(){$scope.is_loading=!1;Loader.hide()})},function(){$scope.is_loading=!1;Loader.hide()})};$scope.selectDeliveryMethod=function(cart,delivery_method){var tmp_total_with_fees=cart.base_total_without_fees+delivery_method.price;cart.total=parseFloat(tmp_total_with_fees!=cart.total&&!cart.deliveryCost?tmp_total_with_fees:cart.total);cart.delivery_method_extra_client_amount=cart.total;cart.deliveryMethodId=delivery_method.id;$scope.clients_calculate_change_form_is_visible=((delivery_method.code=="home_delivery")&&$scope.selectedStore.clients_calculate_change);$scope.cart.delivery_method_extra_amount_due=0;if(delivery_method.code=="home_delivery"){$scope.is_visible_delivery_time=!0;$scope.is_visible_pickup_time=!1;$scope.is_visible_submitted_number=!1}
if(delivery_method.code=="in_store"||delivery_method.code=="carry_out"){$scope.is_visible_pickup_time=!0;$scope.is_visible_delivery_time=!1;$scope.is_visible_submitted_number=!1}
console.log(delivery_method.code)
if(delivery_method.code=="on_location"&&delivery_method.code!=""){$scope.is_visible_pickup_time=!1;$scope.is_visible_delivery_time=!1;$scope.is_visible_submitted_number=!0}
if($scope.store_setting.is_delivery_time==="hidden")
$scope.is_visible_delivery_time=!1;if($scope.store_setting.is_pickup_time==="hidden")
$scope.is_visible_pickup_time=!1;$scope.deliveryMethodCodeKey=delivery_method.code;if(delivery_method.code!=="home_delivery"){console.log('autoupdate')}};$scope.calculateAmountDue=function(){if(!$scope.clients_calculate_change_form_is_visible){$scope.cart.delivery_method_extra_client_amount=""}else{var price=parseFloat($scope.cart.delivery_method_extra_client_amount);if(isNaN(price)||price<$scope.cart.total){if(isNaN(price)){$scope.cart.delivery_method_extra_client_amount=""}
$scope.cart.delivery_method_extra_amount_due="";return}
if($scope.cart.delivery_method_extra_client_amount<$scope.cart.total){$scope.cart.delivery_method_extra_client_amount=$scope.cart.total}
$scope.cart.delivery_method_extra_amount_due=(price-$scope.cart.total).toFixed(2)}
$timeout(function(){$scope.cart.total=$scope.cart.total})};$scope.updateDeliveryInfos=function(){if($scope.clients_calculate_change_form_is_visible&&$scope.cart.delivery_method_extra_client_amount<$scope.cart.total){Dialog.alert("",$translate.instant('The amount must be equal or greater than the order total.','commerce_pro'),"OK");return}
if(!$scope.cart.deliveryMethodId){Dialog.alert("",$translate.instant('You must choose a delivery method.','commerce_pro'),"OK");return}
if($scope.is_visible_delivery_time&&$scope.store_setting.is_delivery_time==="mandatory"&&($scope.cart.delivery_time==""||$scope.cart.delivery_time==null||$scope.cart.delivery_time=="0000-00-00 00:00:00")){Dialog.alert("",$translate.instant('You must choose a delivery time.','commerce_pro'),"OK");return}
if($scope.is_visible_submitted_number&&($scope.cart.submitted_number==""||$scope.cart.submitted_number==null)){var strmsg=$scope.label_array[$scope.deliveryMethodCodeKey]!==undefined&&$scope.label_array[$scope.deliveryMethodCodeKey]!=""?$scope.label_array[$scope.deliveryMethodCodeKey]:"Table No";Dialog.alert("",$translate.instant('Please enter $1','commerce_pro').replace("$1",strmsg),"OK");return}
if(($scope.store_setting.is_delivery_time==="mandatory"||$scope.store_setting.is_delivery_time==="optional")&&$scope.cart.delivery_time!=""&&$scope.is_visible_delivery_time&&$scope.cart.delivery_time!="0000-00-00 00:00:00"){console.log("inSideDeli")
var current_date=new Date();var date=current_date.getDate();var month=current_date.getMonth()+1;var year=current_date.getFullYear();var delivery_date=new Date($scope.cart.delivery_time.replace(/-/g,"/"));var date_d=delivery_date.getDate();var month_d=delivery_date.getMonth();var year_d=delivery_date.getFullYear();if(current_date.getTime()<=delivery_date.getTime()){var weekday=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];var selected_day=weekday[delivery_date.getDay()];var timing_arr=$scope.store_setting.store_timing;var day=[];timing_arr.forEach(function(entry){if(entry.day===selected_day){day.push(entry)}});if(day.length==0){Dialog.alert("",$translate.instant("Sorry ,We are closed on selected date. Please select another date.",'commerce_pro'),"OK");return}
var selected_time=delivery_date;var flag=!1;var str="";day.forEach(function(entry){str+=selected_day;var o_time_string=entry.open;var c_time_string=entry.closed;var open_time_string=o_time_string.split(":");var closed_time_string=c_time_string.split(":");var today_open_time=new Date(year_d,month_d,date_d,open_time_string[0],open_time_string[1]);var today_closed_time=new Date(year_d,month_d,date_d,closed_time_string[0],closed_time_string[1]);console.log("open")
console.log(today_open_time)
console.log("closed")
console.log(today_closed_time)
console.log('selected_time')
console.log(selected_time)
console.log('picker_time')
console.log($scope.cart.delivery_time)
str+=", Open: "+o_time_string+" Closed: "+c_time_string;if(selected_time<today_open_time||selected_time>today_closed_time){}else{console.log("in range delivery");flag=!0}});if(!flag){Dialog.alert("",$translate.instant('Delivery time should be in range of store open hours $1','commerce_pro').replace("$1",str),"OK");return}
console.log('day');console.log(day);console.log(weekday[delivery_date.getDay()]);console.log(delivery_date.getHours()+":"+delivery_date.getMinutes())}else{Dialog.alert("",$translate.instant('Oop! delivery time should not be less than current time.','commerce_pro'),"OK");return}}
console.log('$scope.store_setting.is_pickup_time')
console.log($scope.store_setting.is_pickup_time)
console.log($scope.cart.pickup_time)
console.log('is_visible_pickup_time')
console.log($scope.is_visible_pickup_time)
if($scope.store_setting.is_pickup_time==="mandatory"&&$scope.is_visible_pickup_time&&($scope.cart.pickup_time==""||$scope.cart.pickup_time==null||$scope.cart.pickup_time=='undefined'||$scope.cart.pickup_time=='0000-00-00 00:00:00')){Dialog.alert("",$translate.instant('You must choose a pickup time.','commerce_pro'),"OK");return}
if(($scope.store_setting.is_pickup_time==="mandatory"||$scope.store_setting.is_pickup_time==="optional")&&($scope.cart.pickup_time!=""&&$scope.is_visible_pickup_time&&$scope.cart.pickup_time!='0000-00-00 00:00:00')){console.log("inSidePick")
var strmsg="";var current_date=new Date();var date=current_date.getDate();var month=current_date.getMonth()+1;var year=current_date.getFullYear();var pickup_date=new Date($scope.cart.pickup_time.replace(/-/g,"/"));var date_d=pickup_date.getDate();var month_d=pickup_date.getMonth();var year_d=pickup_date.getFullYear();console.log("current_date "+current_date+" pickup_date "+pickup_date);if(current_date.getTime()<=pickup_date.getTime()){var weekday=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];var selected_day=weekday[pickup_date.getDay()];var timing_arr=$scope.store_setting.store_timing;var day=[];timing_arr.forEach(function(entry){if(entry.day===selected_day){day.push(entry)}});if(day.length==0){Dialog.alert("",$translate.instant("Sorry ,We are closed on selected date. Please select another date.",'commerce_pro'),"OK");return}
var selected_time=pickup_date;var flag=!1;day.forEach(function(entry){strmsg+=selected_day;var o_time_string=entry.open;var c_time_string=entry.closed;var open_time_string=o_time_string.split(":");var closed_time_string=c_time_string.split(":");var today_open_time=new Date(year_d,month_d,date_d,open_time_string[0],open_time_string[1]);var today_closed_time=new Date(year_d,month_d,date_d,closed_time_string[0],closed_time_string[1]);console.log("open")
console.log(today_open_time)
console.log("closed")
console.log(today_closed_time)
console.log('selected_time')
console.log(selected_time)
console.log('picker_time')
console.log($scope.cart.pickup_date)
strmsg+=", Open: "+o_time_string+" Closed: "+c_time_string;if(selected_time<today_open_time||selected_time>today_closed_time){}else{flag=!0;console.log("in range pickup");return}});if(!flag){Dialog.alert("",$translate.instant('pickup time should be in range of store open hours $1','commerce_pro').replace("$1",strmsg),"OK");return}
console.log('day');console.log(day);console.log(weekday[pickup_date.getDay()]);console.log(pickup_date.getHours()+":"+pickup_date.getMinutes())}else{Dialog.alert("",$translate.instant('Oop! pickup time should not be less than current time.','commerce_pro'),"OK");return}}
if(!$scope.is_loading){$scope.is_loading=!0;Loader.show();var postParameters={'delivery_method_id':$scope.cart.deliveryMethodId,'paid_amount':$scope.clients_calculate_change_form_is_visible?$scope.cart.delivery_method_extra_client_amount:null,'store_id':$scope.selectedStore.id,'delivery_time':$scope.cart.delivery_time,'pickup_time':$scope.cart.pickup_time,'submitted_number':$scope.cart.submitted_number};console.log('postParameters')
console.log(postParameters)
CommerceProSalesDelivery.updateDeliveryInfos(postParameters).then(function(data){if($scope.deliveryMethodCodeKey==="home_delivery"&&$scope.cart.isShipping&&$scope.cart.is_cs_enable){$scope.goToShippingPage()}else{$scope.goToPaymentPage()}},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert("",data.message,"OK")}}).then(function(){$scope.is_loading=!1;Loader.hide()})}};$scope.goToPaymentPage=function(){$state.go("commercepro-sales-payment",{value_id:$stateParams.value_id})};$scope.goToShippingPage=function(){$state.go("commercepro-sales-delivery-offers",{value_id:$stateParams.value_id})};$scope.submitDefaultData=function(){$scope.is_loading=!0;Loader.show();var postParameters={'delivery_method_id':1,'paid_amount':$scope.clients_calculate_change_form_is_visible?$scope.cart.delivery_method_extra_client_amount:null,'store_id':$scope.selectedStore.id,'delivery_time':$scope.cart.delivery_time,'pickup_time':$scope.cart.pickup_time,'submitted_number':$scope.cart.submitted_number};console.log('postParameters')
console.log(postParameters)
CommerceProSalesDelivery.updateDeliveryInfos(postParameters).then(function(data){$scope.goToPaymentPage();$timeout(function(){$ionicHistory.removeBackView()},500)},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert("",data.message,"OK")}}).then(function(){$scope.is_loading=!1;Loader.hide()})}
$scope.right_button={action:$scope.updateDeliveryInfos,label:$translate.instant('Next','commerce_pro')};$scope.loadContent()});angular.module('starter').controller('CommerceProSalesErrorViewController',function($scope,$state,$stateParams,$timeout){$scope.value_id=$stateParams.value_id;$timeout(function(){$state.go('commercepro-redirect',{value_id:$scope.value_id})},4000)});angular.module("starter").controller("CommerceProSalesHistoryViewController",function(Loader,$scope,$state,$stateParams,$translate,CommerceProSalesCustomer){$scope.value_id=$stateParams.value_id;$scope.page_title=$translate.instant('Order history','commerce_pro');$scope.showLoader=function(){Loader.show()};$scope.orders=[];$scope.all_orders=[];$scope.offset=0;$scope.can_load_older_posts=!0;CommerceProSalesCustomer.value_id=$stateParams.value_id;$scope.loadContent=function(){$scope.showLoader();CommerceProSalesCustomer.getOrderHistory($scope.offset).then(function(data){if(data.orders){$scope.orders=$scope.orders.concat(data.orders);if(data.orders.length>0){$scope.all_orders=$scope.orders}
console.log('$scope.all_ordersLoading')
console.log($scope.all_orders)
$scope.offset+=data.orders.length;if(data.orders.length<=0){$scope.can_load_older_posts=!1}
return!0}else{return!1}}).then(function(refresh){if(refresh){$scope.$broadcast('scroll.infiniteScrollComplete')}
Loader.hide()})};$scope.loadContent();$scope.onSearchTerm=function(keyEvent){const val=keyEvent.target.value;if(val&&val.trim()!==''){$scope.orders=$scope.all_orders.filter(term=>{return term.number.toLowerCase().indexOf(val.trim().toLowerCase())>-1})}else{$scope.orders=$scope.all_orders}}
$scope.showDetails=function(order_id){$state.go("commercepro-sales-history-details",{value_id:$scope.value_id,order_id:order_id})};$scope.loadMore=function(){$scope.loadContent()}}).controller("CommerceProSalesHistoryDetailsController",function(Loader,$scope,$stateParams,$translate,CommerceProSalesCustomer,CommerceProCart,$state){$scope.value_id=$stateParams.value_id;$scope.page_title=$translate.instant('Order details','commerce_pro');$scope.order_id=$stateParams.order_id;$scope.label_array=null;Loader.show();CommerceProSalesCustomer.value_id=$stateParams.value_id;$scope.loadContent=function(){CommerceProSalesCustomer.getOrderDetails($scope.order_id).then(function(data){$scope.order=data.order;$scope.label_array=data.order.label_array;console.log('$scope.label_array')
console.log($scope.label_array)
console.log($scope.label_array.table_no);if($scope.label_array.table_no!==undefined&&$scope.label_array.table_no!=""){console.log("true");console.log($scope.label_array.table_no)}else{console.log("false");console.log($scope.label_array.table_no)}}).then(function(){Loader.hide()})};$scope.loadContent();$scope.orderAgain=function(order){console.log(order);Loader.show('Processing');$scope.is_loading=!0;CommerceProCart.orderAgain(order.order_id).then(function(data){$scope.is_loading=!1;if(!$scope.is_loading){$state.go('commercepro-cart-view',{value_id:$scope.value_id})}}).then(function(){Loader.hide()})}
$scope.writeReview=function(order){$state.go('commercepro-product-review',{value_id:$scope.value_id,order_id:order.order_id})}});angular.module('starter').controller('CommerceProSalesPaymentViewController',function(Loader,$scope,$state,$stateParams,$translate,CommerceProCart,CommerceProSalesPayment,Dialog,$timeout,$ionicHistory){$scope.page_title=$translate.instant('Payment','commerce_pro');CommerceProCart.value_id=$stateParams.value_id;CommerceProSalesPayment.value_id=$stateParams.value_id;$scope.value_id=$stateParams.value_id;$scope.loadContent=function(){Loader.show();CommerceProCart.find().then(function(data){$scope.cart=data.cart;CommerceProSalesPayment.findPaymentMethods().then(function(resultMethods){$scope.paymentMethods=resultMethods.paymentMethods;$scope.paymentMethodId=resultMethods.paymentMethods.reduce(function(paymentMethodId,paymentMethod){return($scope.cart.paymentMethodId===paymentMethod.id)?paymentMethod.id:paymentMethodId},null);if($scope.paymentMethods.length===1&&$scope.paymentMethods[0].code==='free'&&$scope.cart.lines.length>0){$scope.cart.paymentMethodId=$scope.paymentMethods[0].id;$scope.updatePaymentInfos()}
if($scope.paymentMethods.length===0){$scope.cart.paymentMethodId='';$scope.updateDefaultPaymentInfos()}}).then(function(){$scope.is_loading=!1;Loader.hide()})},function(){$scope.is_loading=!1;Loader.hide()})};$scope.updatePaymentInfos=function(){if(!$scope.is_loading){$scope.is_loading=!0;Loader.show();var postParameters={'payment_method_id':$scope.cart.paymentMethodId};CommerceProSalesPayment.updatePaymentInfos(postParameters).then(function(data){$scope.goToConfirmationPage()},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert('',data.message,'OK')}}).then(function(){$scope.is_loading=!1;Loader.hide()})}};$scope.updateDefaultPaymentInfos=function(){if(!$scope.is_loading){$scope.is_loading=!0;Loader.show();var postParameters={'payment_method_id':$scope.cart.paymentMethodId};CommerceProSalesPayment.updatePaymentInfos(postParameters).then(function(data){$scope.cart.paymentMethodId=data.payment_method_id;$scope.goToConfirmationPage();$timeout(function(){$ionicHistory.removeBackView()},500)},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert('',data.message,'OK')}}).then(function(){$scope.is_loading=!1;Loader.hide()})}};$scope.goToConfirmationPage=function(){if($scope.cart.paymentMethodId){$state.go('commercepro-sales-confirmation',{value_id:$stateParams.value_id})}else{Dialog.alert('','Please choose a payment method.','OK')}};$scope.right_button={action:$scope.updatePaymentInfos,label:$translate.instant('Next','commerce_pro')};$scope.loadContent()});angular.module("starter").controller("CommerceProSalesStoreChoiceController",function(Loader,$scope,$state,$stateParams,$translate,Dialog,CommerceProSalesStorechoice){$scope.value_id=$stateParams.value_id;$scope.is_store_skip=!1;CommerceProSalesStorechoice.value_id=$stateParams.value_id;$scope.selected_store={id:null,name:""};$scope.loadContent=function(){$scope.is_loading=!0;CommerceProSalesStorechoice.find().then(function(data){$scope.stores=data.stores;$scope.cart_amount=data.cart_amount;$scope.selected_store.id=data.store_id;if(data.is_store_skip){$scope.is_store_skip=!0;$scope.selected_store.name=data.store_name;$scope.selected_store.id=data.store_id}}).then(function(){$scope.is_loading=!1})};$scope.chooseStore=function(){if($scope.selected_store.id){Loader.show();$scope.min_amount=0;angular.forEach($scope.stores,function(store){if(store.id==$scope.selected_store.id){$scope.min_amount=store.min_amount;$scope.error_message=store.error_message}});if($scope.min_amount<=$scope.cart_amount){CommerceProSalesStorechoice.update($scope.selected_store.id).then(function(data){Loader.hide();if(data.store_id){$state.go("commercepro-sales-customer",{value_id:$scope.value_id})}}).then(function(){Loader.hide()})}else{Dialog.alert("",$scope.error_message,"OK");Loader.hide()}}};$scope.right_button={action:$scope.chooseStore,label:$translate.instant('Proceed','commerce_pro')};$scope.loadContent()});angular.module("starter").controller("CommerceProSalesStripeViewController",function(Loader,$scope,$state,$stateParams,$timeout,$translate,Customer,CommerceProStripe,Dialog){$scope.is_loading=!0;Loader.show();$scope.value_id=$stateParams.value_id;CommerceProStripe.value_id=$stateParams.value_id;$scope.card={};$scope.payment={};$scope.payment.save_card=!1;$scope.payment.use_stored_card=!1;$scope.payment.hasStoredCard=!1;$scope.isProcessing=!1;$scope.cardElement=null;$scope.creditCardBrand=function(brand){var _brand=(brand===undefined)?"default":brand;switch(_brand.toLowerCase()){case "visa":return"./features/commerce_pro/assets/templates/images/011-cc-visa.svg";case "mastercard":return"./features/commerce_pro/assets/templates/images/012-cc-mastercard.svg";case "american express":return"./features/commerce_pro/assets/templates/images/013-cc-amex.png"}
return"./features/commerce_pro/assets/templates/images/014-cc.svg"};$scope.loadContent=function(){$scope.guest_mode=Customer.guest_mode;var cust_id=null;if(Customer.isLoggedIn()){cust_id=Customer.id}
$scope.payment.save_card=!1;CommerceProStripe.find(cust_id).then(function(data){CommerceProStripe.StripeInstance=Stripe(data.publishable_key);$scope.cart_total=data.total;if(data.card&&data.card.exp_year){$scope.card=data.card;$scope.payment.hasStoredCard=!0}}).then(function(){$scope.is_loading=!1;Loader.hide();$timeout(function(){$scope.mountCard()},200)})};$scope.mountCard=function(){var cardElementParent=document.getElementById("mcommerce_card_element");try{cardElementParent.firstChild.remove()}catch(e){}
var elements=CommerceProStripe.StripeInstance.elements();var style={base:{color:"#32325d",fontFamily:"'Helvetica Neue', Helvetica, sans-serif",fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}};$scope.cardElement=elements.create("card",{hidePostalCode:!0,style:style});var saveElement=document.getElementById("mcommerce_save_element");var displayError=document.getElementById("mcommerce_card_errors");var displayErrorParent=document.getElementById("mcommerce_card_errors_parent");saveElement.setAttribute("disabled","disabled");$scope.cardElement.removeEventListener("change");$scope.cardElement.addEventListener("change",function(event){if(event.error){displayErrorParent.classList.remove("ng-hide");displayError.textContent=event.error.message;saveElement.setAttribute("disabled","disabled")}else{displayErrorParent.classList.add("ng-hide");displayError.textContent="";saveElement.removeAttribute("disabled")}});$scope.cardElement.mount("#mcommerce_card_element")};$scope.validateCard=function(){$scope.process()};$scope.deleteVault=function(){Dialog.confirm("Confirmation","Do you confirm you want to remove your card?",["Yes","No"],"commerce_pro").then(function(result){if(result){$scope.is_loading=!0;Loader.show();CommerceProStripe.removeCard(Customer.id).then(function(data){$scope.oldcard=$scope.card;$scope.card={};$scope.payment.use_stored_card=!1;$scope.payment.hasStoredCard=!1}).then(function(){$scope.is_loading=!1;Loader.hide()})}})};$scope.useCard=function(){if(!$scope.isProcessing){$scope.isProcessing=!0;$scope.payment.use_stored_card=!0;$scope.process()}};$scope.process=function(){if(!$scope.is_loading){$scope.is_loading=!0;Loader.show();if($scope.payment.use_stored_card){$scope._process()}else{CommerceProStripe.StripeInstance.createToken($scope.cardElement).then(function(result){_stripeResponseHandler(result)})}}};var _stripeResponseHandler=function(result){if(result.error){Dialog.alert("",result.error.message,"OK");$scope.is_loading=!1;$scope.isProcessing=!1;Loader.hide()}else{$scope.card={token:result.token.id,last4:result.token.card.last4,brand:result.token.card.brand,exp_month:result.token.card.exp_month,exp_year:result.token.card.exp_year,exp:Math.round(+(new Date((new Date(result.token.card.exp_year,result.token.card.exp_month,1))-1))/1000)|0};$scope._process()}};$scope._process=function(){var data={"token":$scope.card.token,"use_stored_card":$scope.payment.use_stored_card,"save_card":$scope.payment.save_card,"customer_id":Customer.id||null};CommerceProStripe.process(data).then(function(res){if(res){$state.go("commercepro-sales-success",{value_id:$stateParams.value_id})}else{Dialog.alert("Error","Unexpected error","OK")}},function(err){Dialog.alert("Error","Unexpected error","OK")}).then(function(){$scope.is_loading=!1;$scope.isProcessing=!1;Loader.hide()})};$scope.right_button={action:$scope.process,label:$translate.instant('Pay','commerce_pro')};$scope.loadContent()});angular.module('starter').controller('CommerceProSalesEWalletViewController',function(Dialog,Loader,Customer,$filter,Modal,$ionicPopup,$ionicScrollDelegate,$timeout,$ionicHistory,$rootScope,SB,$scope,$state,$stateParams,$translate,CommerceProCart,$ionicHistory,$ionicSideMenuDelegate,Ewallet){$scope.value_id=$stateParams.value_id;$scope.order_id=$stateParams.order_id;$scope.is_loading=!1;$scope.loadContent=function(){CommerceProCart.compute().then(function(computation){CommerceProCart.find().then(function(data){$scope.cart.method=='payToModule';$scope.cart.order_id=data.cart.id;$scope.cart.amount=data.cart.total;$scope.cart.currency_code=data.cart.currency_code;$scope.cart.currency_symbol=data.cart.currency_code;$scope.cart.remark="Order #"+data.cart.id;$scope.cart.return_state_name='commercepro-sales-ewallet-return';$scope.cart.return_value_id=$scope.value_id;console.log("sending to ewallet:cart");console.log($scope.cart);Ewallet.setPaycart($scope.cart);$ionicHistory.nextViewOptions({disableBack:!0});$ionicSideMenuDelegate.canDragContent(!1);$state.go("ewallet-module-payment",{value_id:data.cart.paymentSetting.value_id},{reload:!0});Loader.hide()})});$scope.cart={};Loader.show()}
$scope.loadContent()}).controller('CommerceProSalesEWalletReturnController',function(Dialog,Loader,Customer,$filter,Modal,$ionicPopup,$ionicScrollDelegate,$timeout,$ionicHistory,$rootScope,SB,CommerceProSalesPayment,$scope,$state,$stateParams,$translate,Ewallet,$ionicHistory,$ionicSideMenuDelegate){$scope.value_id=$stateParams.value_id;$scope.cart=Ewallet.getPaycart();console.log($scope.cart);$ionicHistory.nextViewOptions({historyRoot:!0,disableAnimate:!1,disableBack:!0});$ionicSideMenuDelegate.canDragContent(!0);Loader.show();if($scope.cart.status=='success'){CommerceProSalesPayment.validatePayment().then(function(data){$state.go('commercepro-sales-success',{value_id:$stateParams.value_id})})}
if($scope.cart.status=='failed'){$state.go('commercepro-sales-error',{value_id:$stateParams.value_id})}
Ewallet.setPaycart({})});angular.module('starter').controller('CommerceProSalesSuccessViewController',function($scope,$state,Loader,$stateParams,$timeout,Customer,CommerceProStore,Dialog,$translate){$scope.value_id=$stateParams.value_id;if(Customer.guest_mode){Customer.guest_mode=!1;Customer.logout()}
$scope.showMessage=!1;CommerceProStore.value_id=$stateParams.value_id;CommerceProStore.findSettings().then(function(data){console.log(data);if(data.labels.order_success_message&&data.labels.order_success_message!=""){Dialog.alert('',data.labels.order_success_message,$translate.instant('OK')).then(function(){$state.go('commercepro-redirect',{value_id:$scope.value_id})})}else{$scope.showMessage=!0;$scope.redirect()}}).then(function(){$scope.is_loading=!1;Loader.hide()});$scope.redirect=function(){$timeout(function(){$state.go('commercepro-redirect',{value_id:$scope.value_id})},3000)}});angular.module("starter").controller("CommerceProProductReviewListController",function(Loader,$scope,$state,$stateParams,$translate,CommerceProProductReview){$scope.page_title=$translate.instant('Product Reviews','commerce_pro');$scope.showLoader=function(){Loader.show()};$scope.reviews=[];$scope.all_reviews=[];$scope.offset=0;$scope.can_load_older_reviews=!0;CommerceProProductReview.value_id=$stateParams.value_id;CommerceProProductReview.product_id=$stateParams.product_id;$scope.loadContent=function(){$scope.showLoader();CommerceProProductReview.getProductReview($scope.offset).then(function(data){Loader.hide();var data=data.data;if(data.reviews){$scope.reviews=$scope.reviews.concat(data.reviews);if(data.reviews.length>0){$scope.all_reviews=$scope.reviews}
$scope.offset+=data.reviews.length;if(data.reviews.length<=0){$scope.can_load_older_reviews=!1}
return!0}else{return!1}}).then(function(refresh){if(refresh){$scope.$broadcast('scroll.infiniteScrollComplete')}
Loader.hide()})};$scope.loadContent();$scope.loadMore=function(){$scope.loadContent()}}).controller("CommerceProProductReviewController",function(Loader,Dialog,$scope,$stateParams,$translate,CommerceProSalesCustomer,CommerceProProductReview,$ionicHistory,$state){$scope.value_id=$stateParams.value_id;$scope.page_title=$translate.instant('Product','commerce_pro');$scope.order_id=$stateParams.order_id;$scope.review={review:null,rating:null,product_id:null};$scope.review.rating=0;Loader.show();CommerceProSalesCustomer.value_id=$stateParams.value_id;CommerceProProductReview.value_id=$stateParams.value_id;$scope.loadContent=function(){CommerceProSalesCustomer.getOrderDetails($scope.order_id).then(function(data){$scope.order=data.order}).then(function(){Loader.hide()})};$scope.loadContent();$scope.loadifExist=function(){var product_id=document.getElementById("review_product_id").value;CommerceProProductReview.getRating(product_id).then(function(data){$scope.review.review=data.data.review;$scope.review.rating=data.data.rating}).then(function(){Loader.hide()})};$scope.updateRating=function(rating){$scope.review.rating=rating};$scope.updateProductRating=function(rating){$scope.review.rating=rating};$scope.post=function(){$scope.is_loading=!0;var objJsonStr=JSON.stringify($scope.review);var objJsonB64=btoa(encodeURIComponent(objJsonStr));CommerceProProductReview.post(objJsonB64).success(function(data){if(data.success==1){$ionicHistory.goBack(-1)}}).error(function(data){if(data&&angular.isDefined(data.message)){Dialog.alert($translate.instant("Error"),data.message,$translate.instant("OK"))}}).finally(function(){$scope.is_loading=!1})}});angular.module("starter").factory("CommerceProCart",function($pwaRequest,$session){var factory={value_id:null};factory.find=function(){if(!this.value_id){return $pwaRequest.reject("[CommerceProCart::find] missing value_id.")}
return $pwaRequest.get("commercepro/mobile_cart/find",{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.addProduct=function(form){if(!this.value_id){return $pwaRequest.reject("[CommerceProCart::addProduct] missing value_id.")}
return $pwaRequest.post("commercepro/mobile_cart/add",{urlParams:{value_id:this.value_id},data:{form:form},cache:!1,refresh:!0})};factory.orderAgain=function(order){if(!this.value_id){return $pwaRequest.reject("[CommerceProCart::orderAgain] missing value_id.")}
return $pwaRequest.post("commercepro/mobile_cart/orderagain",{urlParams:{value_id:this.value_id},data:{order_id:order},cache:!1,refresh:!0})};factory.adddiscount=function(discount_code,use_clean_code){if(!this.value_id){return use_clean_code?$pwaRequest.reject('[CommerceProCart::adddiscount] missing value_id.'):$pwaRequest.resolve({success:!1})}
if(discount_code===undefined){return $pwaRequest.resolve({success:!0})}
if(discount_code.length===0&&!use_clean_code){return $pwaRequest.resolve({success:!0})}
return $pwaRequest.post('commercepro/mobile_cart/adddiscount',{urlParams:{value_id:this.value_id},data:{discount_code:discount_code,customer_uuid:$session.getDeviceUid()},cache:!1,refresh:!0})};factory.addTip=function(cart){if(!this.value_id){return $pwaRequest.reject("[CommerceProCart::addTip] missing value_id.")}
return $pwaRequest.post("commercepro/mobile_cart/addtip",{urlParams:{value_id:this.value_id},data:{tip:cart.tip?cart.tip:0}})};factory.compute=function(){if(!this.value_id){return $pwaRequest.reject("[CommerceProCart::compute] missing value_id.")}
return $pwaRequest.post("commercepro/mobile_cart/compute",{urlParams:{value_id:this.value_id,customer_uuid:$session.getDeviceUid()}})};factory.deleteLine=function(line_id){if(!this.value_id||!line_id){return $pwaRequest.reject("[CommerceProCart::deleteLine] missing value_id or line_id.")}
return $pwaRequest.get("commercepro/mobile_cart/delete",{urlParams:{value_id:this.value_id,line_id:line_id},cache:!1,refresh:!0})};factory.modifyLine=function(line){if(!this.value_id){return $pwaRequest.reject("[CommerceProCart::modifyLine] missing value_id.")}
return $pwaRequest.post("commercepro/mobile_cart/modify",{urlParams:{value_id:this.value_id},data:{line_id:line.id,qty:line.qty,format:line.format},cache:!1,refresh:!0})};factory.useFidelityPoints=function(points){if(!this.value_id){return $pwaRequest.reject("[CommerceProCart::useFidelityPoints] missing value_id.")}
return $pwaRequest.post("commercepro/mobile_cart/usefidelitypointsforcart",{data:{points:points}})};factory.removeAllDiscount=function(){if(!this.value_id){return $pwaRequest.reject("[CommerceProCart::removeAllDiscount] missing value_id.")}
return $pwaRequest.post("commercepro/mobile_cart/removealldiscount",{urlParams:{value_id:this.value_id}})};return factory});angular.module("starter").factory("CommerceProStore",function($pwaRequest){var factory={value_id:null,store_id:null,category_id:null,sub_category_id:null,};factory.findAll=function(location,offset){if(!this.value_id){return $pwaRequest.reject("[CommerceProStore::findAll] missing value_id.")}
return $pwaRequest.get("commercepro/mobile_store/findall",{urlParams:{value_id:this.value_id,store_id:this.store_id,category_id:this.category_id,sub_category_id:this.sub_category_id,latitude:location.latitude,longitude:location.longitude,offset:offset},cache:!1,refresh:!0}).then(function(data){if(data.displayed_per_page){factory.displayed_per_page=data.displayed_per_page}
return data})};factory.findAllPro=function(offset){if(!this.value_id){return $pwaRequest.reject("[CommerceProStore::findAllPro] missing value_id.")}
return $pwaRequest.get("commercepro/mobile_store/findallpro",{urlParams:{value_id:this.value_id,offset:offset},cache:!1,refresh:!0}).then(function(data){if(data.displayed_per_page){factory.displayed_per_page=data.displayed_per_page}
return data})};factory.findAllStores=function(offset){if(!this.value_id){return $pwaRequest.reject("[CommerceProStore::findAllStores] missing value_id.")}
return $pwaRequest.get("commercepro/mobile_store/findallstores",{urlParams:{value_id:this.value_id,offset:offset},cache:!1,refresh:!0}).then(function(data){return data})};factory.findSettings=function(){if(!this.value_id){return $pwaRequest.reject("[CommerceProSalesDelivery::findStore] missing value_id.")}
return $pwaRequest.get("commercepro/mobile_store/settings",{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};return factory});angular.module("starter").factory("CommerceProCategory",function($pwaRequest){var factory={value_id:null,category_id:null};factory.findAll=function(offset){if(!this.value_id){return $pwaRequest.reject("[CommerceProCategory::findAll] missing value_id.")}
return $pwaRequest.get("commercepro/mobile_category/findall",{urlParams:{value_id:this.value_id,category_id:this.category_id,offset:offset},cache:!1,refresh:!0}).then(function(data){if(data.displayed_per_page){factory.displayed_per_page=data.displayed_per_page}
return data})};return factory});angular.module("starter").factory("CommerceProProduct",function($pwaRequest){var factory={value_id:null};factory.find=function(product_id){if(!this.value_id){return $pwaRequest.reject("[CommerceProProduct::find] missing value_id.")}
return $pwaRequest.get("commercepro/mobile_product/find",{urlParams:{value_id:this.value_id,product_id:product_id},cache:!1,refresh:!0})};factory.findByQr=function(barcode){if(!this.value_id){return $pwaRequest.reject("[CommerceProProduct::code] missing value_id.")}
console.log("ApiAB"+barcode)
return $pwaRequest.get("commercepro/mobile_product/code",{urlParams:{value_id:this.value_id,barcode:barcode},cache:!1,refresh:!0})};return factory});angular.module('starter').factory('CommerceProSalesCustomer',function($pwaRequest){var factory={value_id:null};factory.updateCustomerInfos=function(form){if(!this.value_id){return $pwaRequest.reject('[CommerceProSalesCustomer::updateCustomerInfos] missing value_id.')}
return $pwaRequest.post('commercepro/mobile_sales_customer/update',{urlParams:{value_id:this.value_id},data:{form:form,option_value_id:this.value_id}})};factory.find=function(){if(!this.value_id){return $pwaRequest.reject('[CommerceProSalesCustomer::find] missing value_id.')}
return $pwaRequest.get('commercepro/mobile_sales_customer/find',{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.hasGuestMode=function(){if(!this.value_id){return $pwaRequest.reject('[CommerceProSalesCustomer::hasGuestMode] missing value_id.')}
return $pwaRequest.get('commercepro/mobile_sales_customer/hasguestmode',{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.getOrderHistory=function(offset){if(!this.value_id){return $pwaRequest.reject('[CommerceProSalesCustomer::getOrderHistory] missing value_id.')}
return $pwaRequest.get('commercepro/mobile_sales_customer/getorders',{urlParams:{value_id:this.value_id,offset:offset},cache:!1,refresh:!0})};factory.getOrderDetails=function(order_id){if(!this.value_id){return $pwaRequest.reject('[CommerceProSalesCustomer::getOrderDetails] missing value_id.')}
return $pwaRequest.get('commercepro/mobile_sales_customer/getorderdetails',{urlParams:{value_id:this.value_id,order_id:order_id},cache:!1,refresh:!0})};return factory});angular.module("starter").factory("CommerceProSalesDelivery",function($pwaRequest){var factory={value_id:null};factory.findStore=function(){if(!this.value_id){return $pwaRequest.reject("[CommerceProSalesDelivery::findStore] missing value_id.")}
return $pwaRequest.get("commercepro/mobile_sales_delivery/findstore",{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.updateDeliveryInfos=function(form){if(!this.value_id){return $pwaRequest.reject("[CommerceProSalesDelivery::updateDeliveryInfos] missing value_id.")}
return $pwaRequest.post("commercepro/mobile_sales_delivery/update",{urlParams:{value_id:this.value_id},data:{form:form}})};return factory});angular.module("starter").factory("CommerceProSalesDeliveryOffers",function($pwaRequest){var factory={value_id:null};factory.findOffers=function(){if(!this.value_id){return $pwaRequest.reject("[CommerceProSalesDeliveryOffers::find] missing value_id.")}
return $pwaRequest.get("commercepro/mobile_sales_deliveryoffers/find",{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.updateOffersInfos=function(form){if(!this.value_id){return $pwaRequest.reject("[CommerceProSalesDeliveryOffers::updateOffersInfos] missing value_id.")}
return $pwaRequest.post("commercepro/mobile_sales_deliveryoffers/update",{urlParams:{value_id:this.value_id},data:{form:form}})};return factory});angular.module('starter').factory('CommerceProProductReview',function($pwaRequest,$http,Url){var factory={value_id:null,product_id:null};factory.post=function(form){if(!this.value_id)
return;var url=Url.get("commercepro/mobile_product/post",{value_id:this.value_id});var data={form:form};return $http.post(url,data)};factory.getRating=function(product_id){if(!this.value_id)
return;var url=Url.get("commercepro/mobile_product/ratingload",{value_id:this.value_id});var data={product_id:product_id};return $http.post(url,data)};factory.getProductReview=function(offset){if(!this.value_id)
return;var url=Url.get("commercepro/mobile_product/reviewload",{value_id:this.value_id});var data={product_id:this.product_id,offset:offset};return $http.post(url,data)};return factory});angular.module('starter').factory('CommerceProSalesPayment',function($pwaRequest,$session){var factory={value_id:null,notes:''};factory.findPaymentMethods=function(){if(!this.value_id){return $pwaRequest.reject('[CommerceProSalesPayment::findPaymentMethods] missing value_id.')}
return $pwaRequest.get('commercepro/mobile_sales_payment/findpaymentmethods',{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.findOnlinePaymentUrl=function(){if(!this.value_id){return $pwaRequest.reject('[CommerceProSalesPayment::findOnlinePaymentUrl] missing value_id.')}
return $pwaRequest.get('commercepro/mobile_sales_payment/findonlinepaymenturl',{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.updatePaymentInfos=function(form){if(!this.value_id){return $pwaRequest.reject('[CommerceProSalesPayment::updatePaymentInfos] missing value_id.')}
return $pwaRequest.post('commercepro/mobile_sales_payment/update',{urlParams:{value_id:this.value_id},data:{form:form}})};factory.validatePayment=function(){if(!this.value_id){return $pwaRequest.reject('[CommerceProSalesPayment::validatePayment] missing value_id.')}
var formData={validate_payment:1,customer_uuid:$session.getDeviceUid(),notes:factory.notes||''};if(IS_NATIVE_APP){formData.is_ajax=!0}
return $pwaRequest.post('commercepro/mobile_sales_payment/validatepayment',{urlParams:{value_id:this.value_id},data:formData,cache:!1,refresh:!0})}
return factory});angular.module("starter").factory("CommerceProSalesStorechoice",function($pwaRequest){var factory={value_id:null};factory.find=function(){if(!this.value_id){return $pwaRequest.reject("[CommerceProSalesStorechoice::find] missing value_id.")}
return $pwaRequest.get("commercepro/mobile_sales_storechoice/find",{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.update=function(store_id){if(!this.value_id){return $pwaRequest.reject("[CommerceProSalesStorechoice::update] missing value_id.")}
return $pwaRequest.post("commercepro/mobile_sales_storechoice/update",{urlParams:{value_id:this.value_id},data:{store_id:store_id}})};return factory});angular.module("starter").factory("CommerceProStripe",function($pwaRequest){var factory={value_id:null,StripeInstance:null};factory.find=function(cust_id){if(!this.value_id){return $pwaRequest.reject("[CommerceProStripe::find] missing value_id.")}
return $pwaRequest.post("commercepro/stripe/find",{data:{value_id:this.value_id,customer_id:cust_id}})};factory.process=function(data){if(!this.value_id){return $pwaRequest.reject("[CommerceProStripe::process] missing value_id.")}
return $pwaRequest.post("commercepro/stripe/process",{data:{value_id:this.value_id,token:data.token,customer_id:data.customer_id,use_stored_card:data.use_stored_card,save_card:data.save_card,notes:sessionStorage.getItem('mcommerce-notes')||""}})};factory.getCard=function(customer_id){if(!this.value_id){return $pwaRequest.reject("[CommerceProStripe::getCard] missing value_id.")}
return $pwaRequest.post("commercepro/stripe/getcard",{data:{"value_id":this.value_id,"customer_id":customer_id}})};factory.removeCard=function(customer_id){if(!this.value_id){return $pwaRequest.reject("[CommerceProStripe::removeCard] missing value_id.")}
return $pwaRequest.post("commercepro/stripe/removecard",{data:{"value_id":this.value_id,"customer_id":customer_id}})};return factory});angular.module('starter').directive('cpInputQuantity',function($timeout,$translate){return{restrict:'E',scope:{changeQty:'&',step:'=?',min:'=?',max:'=?',value:'=?',label:'=?',params:'=?'},template:'<div class="item item-input item-custom input-number-sb">'+'   <div class="input-label">{{ getLabel() }}</div>'+'   <div class="input-container text-right">'+'       <button class="button button-small button-custom button-left" '+'               ng-click="oneLess()">'+'           <i class="icon ion-minus"></i>'+'       </button>'+'       <div class="item-input-wrapper">'+'           <input type="text" '+'                  value="{{ getValue() }}" '+'                   ng-model="inputValue"'+'                   ng-change="inputChanged()"'+'                  class="text-center input" '+'                   />'+'       </div>'+'       <button class="button button-small button-custom button-right" '+'               ng-click="oneMore()">'+'           <i class="icon ion-plus"></i>'+'       </button>'+'   </div>'+'</div>',replace:!0,link:function(scope,element,attrs){scope.step=scope.step?scope.step:1;scope.min=scope.min?scope.min:0;scope.inputValue=scope.min?scope.min:0;scope.max=scope.max?scope.max:999;scope.params=scope.params?scope.params:{};scope.label=attrs.label?attrs.label+':':''},controller:function($scope){$scope.oneMore=function(){if($scope.value<$scope.max){$scope.value=$scope.value+1;$scope.callBack($scope.value)}
$scope.inputValue=$scope.value};$scope.oneLess=function(){if($scope.value>$scope.min){$scope.value=$scope.value-1;$scope.callBack($scope.value)}
$scope.inputValue=$scope.value};$scope.inputChanged=function(){$scope.inputValue=parseInt($scope.inputValue);if($scope.inputValue>=$scope.min&&$scope.inputValue<$scope.max){$scope.value=parseInt($scope.inputValue);$scope.callBack($scope.value);console.log($scope.inputValue+" "+$scope.value)}else if(!isNaN($scope.inputValue))
$scope.inputValue=$scope.value};$scope.getLabel=function(){return $translate.instant($scope.label,'commerce_pro')};$scope.getValue=function(){return $scope.value};$scope.callBack=function(value){if(typeof $scope.changeQty==='function'){if($scope.debouncePromise){$timeout.cancel($scope.debouncePromise)}
$scope.debouncePromise=$timeout(function(){$scope.changeQty({qty:value,params:$scope.params});$scope.debouncePromise=null},800)}}}}});angular.module('starter').directive('cpCartQuantity',function($timeout,$translate){return{restrict:'E',scope:{changeQty:'&',step:'=?',min:'=?',max:'=?',value:'=?',label:'=?',params:'=?'},template:'<div class="item item-input item-custom input-number-sb">'+'   <div class="input-label">{{ getLabel() }}</div>'+'   <div class="input-container text-right">'+'       <button class="button button-small button-custom button-left" '+'               ng-click="oneLess()">'+'           <i class="icon ion-minus"></i>'+'       </button>'+'       <div class="item-input-wrapper">'+'           <input type="text" '+'                  value="{{ getValue() }}" '+'                  class="text-center input" '+'                  readonly />'+'       </div>'+'       <button class="button button-small button-custom button-right" '+'               ng-click="oneMore()">'+'           <i class="icon ion-plus"></i>'+'       </button>'+'   </div>'+'</div>',replace:!0,link:function(scope,element,attrs){scope.step=scope.step?scope.step:1;scope.min=scope.min?scope.min:0;scope.max=scope.max?scope.max:999;scope.params=scope.params?scope.params:{};scope.label=attrs.label?attrs.label+':':''},controller:function($scope){$scope.oneMore=function(){if($scope.value<$scope.max){$scope.value=$scope.value+1;$scope.callBack($scope.value)}};$scope.oneLess=function(){if($scope.value>$scope.min){$scope.value=$scope.value-1;$scope.callBack($scope.value)}};$scope.getLabel=function(){return $translate.instant($scope.label,'commerce_pro')};$scope.getValue=function(){return $scope.value};$scope.callBack=function(value){if(typeof $scope.changeQty==='function'){if($scope.debouncePromise){$timeout.cancel($scope.debouncePromise)}
$scope.debouncePromise=$timeout(function(){$scope.changeQty({qty:value,params:$scope.params});$scope.debouncePromise=null},800)}}}}});!function(){"use strict";angular.module("jkAngularRatingStars",["jkAngularRatingStars.templates"])}(),function(){"use strict";function RatingStarsController($scope,$attrs,$timeout){var that=this;void 0===that.readOnly&&(that.readOnly=!1),that.initStarsArray=function(){that.starsArray=that.getStarsArray(),that.validateStars()},that.getStarsArray=function(){for(var starsArray=[],index=0;index<that.maxRating;index++){var starItem={index:index,"class":"star-off"};starsArray.push(starItem)}return starsArray},that.setRating=function(rating){that.readOnly||(that.rating=rating,that.validateStars(that.rating),$timeout(function(){that.onRating({rating:that.rating}),$scope.$apply()}))},that.setMouseOverRating=function(rating){that.readOnly||that.validateStars(rating)},that.validateStars=function(rating){if(that.starsArray&&0!==that.starsArray.length)for(var index=0;index<that.starsArray.length;index++){var starItem=that.starsArray[index];rating-1>=index?starItem["class"]="star-on":starItem["class"]="star-off"}}}angular.module("jkAngularRatingStars").controller("RatingStarsController",["$scope","$attrs","$timeout",RatingStarsController])}(),function(){"use strict";function RatingStarsDirective(){function link(scope,element,attrs,ctrl){(!attrs.maxRating||parseInt(attrs.maxRating)<=0)&&(attrs.maxRating="5"),scope.$watch("ctrl.maxRating",function(oldVal,newVal){ctrl.initStarsArray()}),scope.$watch("ctrl.rating",function(oldVal,newVal){ctrl.validateStars(ctrl.rating)})}return{restrict:"E",replace:!0,templateUrl:"rating-stars-directive.html",scope:{},controller:"RatingStarsController",controllerAs:"ctrl",bindToController:{maxRating:"@?",rating:"=?",readOnly:"=?",onRating:"&"},link:link}}angular.module("jkAngularRatingStars").directive("jkRatingStars",[RatingStarsDirective])}(),function(){angular.module("jkAngularRatingStars.templates",[]).run(["$templateCache",function($templateCache){$templateCache.put("rating-stars-directive.html",'<div\n  class="jk-rating-stars-container"\n  layout="row" >\n\n  <a\n    class="button"\n    ng-click="ctrl.setRating(0)"\n    ng-if="!ctrl.readOnly" >\n    <i class="material-icons">remove_circle_outline</i>\n  </a>\n\n  <a\n    class="button star-button"\n    ng-class="item.class"\n    ng-mouseover="ctrl.setMouseOverRating($index + 1)"\n    ng-mouseleave="ctrl.setMouseOverRating(ctrl.rating)"\n    ng-click="ctrl.setRating($index + 1)"\n    ng-repeat="item in ctrl.starsArray" >\n    <i class="material-icons">star</i>\n  </a>\n\n</div>\n')}])}();Features.insertCSS(":root{--safe-area-inset-top:0;--safe-area-inset-right:0;--safe-area-inset-bottom:0;--safe-area-inset-left:0}@supports (padding-top:constant(safe-area-inset-top)){:root{--safe-area-inset-top:constant(safe-area-inset-top);--safe-area-inset-right:constant(safe-area-inset-right);--safe-area-inset-bottom:constant(safe-area-inset-bottom);--safe-area-inset-left:constant(safe-area-inset-left)}}@supports (padding-top:env(safe-area-inset-top)){:root{--safe-area-inset-top:env(safe-area-inset-top);--safe-area-inset-right:env(safe-area-inset-right);--safe-area-inset-bottom:env(safe-area-inset-bottom);--safe-area-inset-left:env(safe-area-inset-left)}}.platform-overview.platform-cordova{--safe-area-inset-top:1.5em;--safe-area-inset-right:0;--safe-area-inset-bottom:.5em;--safe-area-inset-left:0}.module-commercepro .saved-card{font-weight:700;letter-spacing:0}.module-commercepro .saved-card .last-star{transform:translateY(3px);display:inline-block}ion-view[state=\"commercepro-category-list\"] .category-list,ion-view[state=\"commercepro-category-list\"] .product-list{padding-bottom:100px!important}ion-view[state=\"commercepro-subcategory-list\"] .category-list,ion-view[state=\"commercepro-subcategory-list\"] .product-list{padding-bottom:100px!important}ion-view[state=\"commercepro-store-product-list\"] .store-products{padding-bottom:100px!important}.jk-rating-stars-container .button{cursor:pointer}.jk-rating-stars-container .button .material-icons{font-size:30px}.jk-rating-stars-container .star-button{text-shadow:.06em .04em #000}.jk-rating-stars-container .star-button.star-on .material-icons{color:#ee9a00}.jk-rating-stars-container .star-button.star-off .material-icons{color:#ddd}","commerce_pro")